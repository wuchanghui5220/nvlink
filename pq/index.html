<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品报价管理系统</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Custom CSS -->
    <link href="css/styles.css" rel="stylesheet">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line me-2"></i>产品报价管理系统
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">Vincent的报价助手</span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 标签页导航 -->
        <ul class="nav nav-tabs" id="mainTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">
                    仪表板
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button" role="tab">
                    产品管理
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="quotes-tab" data-bs-toggle="tab" data-bs-target="#quotes" type="button" role="tab">
                    报价记录
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis" type="button" role="tab">
                    价格分析
                </button>
            </li>
        </ul>

        <div class="tab-content mt-3" id="mainTabContent">
            <!-- 仪表板 -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">产品总数</h5>
                                <h2 class="text-primary" id="totalProducts">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">报价记录</h5>
                                <h2 class="text-success" id="totalQuotes">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">本月报价</h5>
                                <h2 class="text-warning" id="monthlyQuotes">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">本月报价总额</h5>
                                <h2 class="text-info" id="monthlyTotal">0万元</h2>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 数据管理 -->
                <div class="card mt-4">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">数据管理</h5>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="d-grid">
                                    <button type="button" class="btn btn-primary" onclick="exportAllData()">
                                        📥 导出所有数据
                                    </button>
                                    <small class="text-muted mt-1">将所有产品和报价数据导出为JSON文件</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-grid">
                                    <button type="button" class="btn btn-success" onclick="document.getElementById('importFileInput').click()">
                                        📤 导入数据
                                    </button>
                                    <small class="text-muted mt-1">从JSON文件导入产品和报价数据</small>
                                    <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="importAllData(this)">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 最近报价记录 -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">最近报价记录</h5>
                    </div>
                    <div class="card-body">
                        <div id="recentQuotes">
                            <p class="text-muted text-center">暂无报价记录</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 产品管理 -->
            <div class="tab-pane fade" id="products" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>产品管理</h4>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal">
                        添加产品
                    </button>
                </div>

                <!-- 筛选控件 -->
                <div class="card mb-3">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">筛选条件</h6>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearProductFilters()">
                                清除筛选
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="filterProductModel" class="form-label">产品型号</label>
                                <input type="text" class="form-control form-control-sm" id="filterProductModel" placeholder="搜索产品型号...">
                            </div>
                            <div class="col-md-3">
                                <label for="filterManufacturer" class="form-label">厂商</label>
                                <select class="form-select form-select-sm" id="filterManufacturer">
                                    <option value="">全部厂商</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="filterProductDateFrom" class="form-label">创建起始日期</label>
                                <input type="date" class="form-control form-control-sm" id="filterProductDateFrom">
                            </div>
                            <div class="col-md-3">
                                <label for="filterProductDateTo" class="form-label">创建结束日期</label>
                                <input type="date" class="form-control form-control-sm" id="filterProductDateTo">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="productsTable">
                                <thead>
                                    <tr>
                                        <th>产品型号</th>
                                        <th>厂商</th>
                                        <th>描述</th>
                                        <th>创建日期</th>
                                        <th>报价次数</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">暂无产品数据</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 报价记录 -->
            <div class="tab-pane fade" id="quotes" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>报价记录</h4>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#quoteModal">
                        添加报价
                    </button>
                </div>

                <!-- 筛选控件 -->
                <div class="card mb-3">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">筛选条件</h6>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-success me-2" onclick="exportQuoteData()">
                                    <i class="fas fa-download me-1"></i>导出数据
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearQuoteFilters()">
                                    清除筛选
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="filterProduct" class="form-label">产品</label>
                                <select class="form-select form-select-sm" id="filterProduct">
                                    <option value="">全部产品</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="filterCustomer" class="form-label">客户</label>
                                <select class="form-select form-select-sm" id="filterCustomer">
                                    <option value="">全部客户</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="filterDateFrom" class="form-label">起始日期</label>
                                <input type="date" class="form-control form-control-sm" id="filterDateFrom">
                            </div>
                            <div class="col-md-3">
                                <label for="filterDateTo" class="form-label">结束日期</label>
                                <input type="date" class="form-control form-control-sm" id="filterDateTo">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">报价记录列表</h6>
                            <button type="button" class="btn btn-sm btn-outline-info" onclick="debugQuotes()">
                                🔍 调试报价数据
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="quotesTable">
                                <thead>
                                    <tr>
                                        <th>产品型号</th>
                                        <th>客户</th>
                                        <th>数量</th>
                                        <th>单价</th>
                                        <th>总价</th>
                                        <th>日期</th>
                                        <th>备注</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="quotesTableBody">
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">暂无报价记录</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 价格分析 -->
            <div class="tab-pane fade" id="analysis" role="tabpanel">
                <h4 class="mb-3">价格走势分析</h4>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6>产品选择</h6>
                            </div>
                            <div class="card-body">
                                <select class="form-select" id="analysisProductSelect">
                                    <option value="">选择产品查看价格走势</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6>时间范围</h6>
                            </div>
                            <div class="card-body">
                                <select class="form-select" id="timeRange">
                                    <option value="30">最近30天</option>
                                    <option value="90">最近90天</option>
                                    <option value="180">最近6个月</option>
                                    <option value="365">最近一年</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-body">
                        <canvas id="priceChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 产品添加模态框 -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加产品</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <div class="mb-3">
                            <label for="productModel" class="form-label">产品型号 *</label>
                            <input type="text" class="form-control" id="productModel" required>
                        </div>
                        <div class="mb-3">
                            <label for="productManufacturer" class="form-label">厂商 *</label>
                            <div class="input-group">
                                <select class="form-select" id="manufacturerSelect" style="max-width: 120px;">
                                    <option value="Nvidia">Nvidia</option>
                                    <option value="AMD">AMD</option>
                                    <option value="Intel">Intel</option>
                                    <option value="custom">其他</option>
                                </select>
                                <input type="text" class="form-control" id="productManufacturer" value="Nvidia" required>
                            </div>
                            <div class="form-text">选择常用厂商或在右侧输入框手动输入</div>
                        </div>
                        <div class="mb-3">
                            <label for="productDescription" class="form-label">产品描述</label>
                            <textarea class="form-control" id="productDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">保存产品</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 报价添加模态框 -->
    <div class="modal fade" id="quoteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加报价</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="quoteForm">
                        <div class="mb-3">
                            <label for="quoteProduct" class="form-label">选择产品 *</label>
                            <select class="form-select" id="quoteProduct" required>
                                <option value="">请选择产品</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="quoteCustomer" class="form-label">客户名称</label>
                            <div class="input-group">
                                <select class="form-select" id="customerSelect" style="max-width: 120px;">
                                    <option value="new">新客户</option>
                                </select>
                                <input type="text" class="form-control" id="quoteCustomer" placeholder="输入客户名称">
                            </div>
                            <div class="form-text">选择常用客户或在右侧输入框手动输入</div>
                        </div>
                        <div class="mb-3">
                            <label for="quoteQuantity" class="form-label">数量 *</label>
                            <input type="number" class="form-control" id="quoteQuantity" min="1" value="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="quoteUnitPrice" class="form-label">单价 *</label>
                            <div class="input-group">
                                <span class="input-group-text">¥</span>
                                <input type="number" class="form-control" id="quoteUnitPrice" step="0.01" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="quoteTotalPrice" class="form-label">总价</label>
                            <div class="input-group">
                                <span class="input-group-text">¥</span>
                                <input type="number" class="form-control" id="quoteTotalPrice" step="0.01" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="quoteDate" class="form-label">报价日期 *</label>
                            <input type="date" class="form-control" id="quoteDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="quoteNotes" class="form-label">备注</label>
                            <textarea class="form-control" id="quoteNotes" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success" onclick="saveQuote()">保存报价</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="js/app.js"></script>
    <script src="js/product.js"></script>
    <script src="js/quote.js"></script>
    <script src="js/chart.js"></script>

    <!-- 数据导出/导入功能 -->
    <script>
    function exportAllData() {
        if (!app) {
            alert('应用未初始化');
            return;
        }

        try {
            // 准备导出数据
            const exportData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                products: app.products,
                quotes: app.quotes,
                statistics: {
                    totalProducts: app.products.length,
                    totalQuotes: app.quotes.length
                }
            };

            // 创建下载链接
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            // 生成文件名
            const now = new Date();
            const timestamp = now.toISOString().split('T')[0].replace(/-/g, '');
            const filename = `产品报价系统数据备份_${timestamp}.json`;

            // 创建下载链接并触发下载
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = filename;
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);

            // 清理URL对象
            URL.revokeObjectURL(url);

            app.showAlert(`数据导出成功！已导出 ${app.products.length} 个产品和 ${app.quotes.length} 条报价记录`, 'success');

        } catch (error) {
            console.error('数据导出失败:', error);
            app.showAlert('数据导出失败，请重试', 'danger');
        }
    }

    function importAllData(input) {
        if (!app) {
            alert('应用未初始化');
            return;
        }

        const file = input.files[0];
        if (!file) {
            return;
        }

        // 检查文件类型
        if (!file.name.toLowerCase().endsWith('.json')) {
            app.showAlert('请选择JSON格式的数据文件', 'danger');
            input.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importData = JSON.parse(e.target.result);

                // 验证数据格式
                if (!importData.products || !importData.quotes) {
                    app.showAlert('数据文件格式不正确，缺少必要的数据字段', 'danger');
                    return;
                }

                // 确认导入操作
                const confirmMessage = `准备导入数据：\n产品数量：${importData.products.length}\n报价记录：${importData.quotes.length}\n\n注意：这将覆盖当前所有数据，是否继续？`;

                if (!confirm(confirmMessage)) {
                    return;
                }

                // 导入数据
                app.products = importData.products || [];
                app.quotes = importData.quotes || [];

                // 保存到localStorage
                app.saveData();

                // 刷新界面
                if (app.updateDashboard) app.updateDashboard();
                if (typeof refreshProductTable === 'function') refreshProductTable();
                if (typeof refreshQuoteTable === 'function') refreshQuoteTable();
                if (typeof updateQuoteProductSelect === 'function') updateQuoteProductSelect();
                if (typeof updateFilterProductSelect === 'function') updateFilterProductSelect();
                if (typeof updateFilterCustomerSelect === 'function') updateFilterCustomerSelect();
                if (typeof updateCustomerSelect === 'function') updateCustomerSelect();
                if (app.updatePriceChart) app.updatePriceChart();

                // 强制更新报价表格显示
                setTimeout(() => {
                    const tableBody = document.getElementById('quotesTableBody');
                    if (tableBody && app.quotes.length > 0) {
                        console.log('强制刷新报价表格，数据量:', app.quotes.length);
                        if (typeof refreshQuoteTable === 'function') {
                            refreshQuoteTable();
                        }
                    }
                }, 500);

                app.showAlert(`数据导入成功！已导入 ${app.products.length} 个产品和 ${app.quotes.length} 条报价记录`, 'success');

            } catch (error) {
                console.error('数据导入失败:', error);
                app.showAlert('数据文件解析失败，请检查文件格式', 'danger');
            } finally {
                // 清空文件输入
                input.value = '';
            }
        };

        reader.onerror = function() {
            app.showAlert('文件读取失败，请重试', 'danger');
            input.value = '';
        };

        reader.readAsText(file);
    }

    function debugQuotes() {
        console.log('=== 报价数据调试 ===');
        console.log('app对象存在:', !!app);

        if (app) {
            console.log('app.quotes长度:', app.quotes.length);
            console.log('前3条报价:', app.quotes.slice(0, 3));

            // 检查localStorage
            const savedQuotes = localStorage.getItem('quote_quotes');
            console.log('localStorage中的报价数据:', savedQuotes ? JSON.parse(savedQuotes).length : '无');

            // 检查表格元素
            const tableBody = document.getElementById('quotesTableBody');
            console.log('表格body元素存在:', !!tableBody);
            if (tableBody) {
                console.log('当前表格内容:', tableBody.innerHTML.substring(0, 100));
            }

            // 手动刷新
            if (typeof refreshQuoteTable === 'function') {
                console.log('调用refreshQuoteTable函数...');
                refreshQuoteTable();
                console.log('refreshQuoteTable调用完成');
            } else {
                console.log('refreshQuoteTable函数不存在');
            }
        }

        alert('调试信息已输出到控制台');
    }
    </script>
</body>
</html>