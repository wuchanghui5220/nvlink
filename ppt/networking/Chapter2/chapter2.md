
本章节将涵盖InfiniBand (IB) 网络在不同应用场景下的拓扑结构设计，从最简单的双机直连到复杂的高性能计算集群拓扑，并探讨如何确保网络的稳定性和高可用性。

---

### **第二章：IB网络拓扑规划**

#### **1. 单机直连配置**

在最简单的应用场景中，例如连接两台服务器以实现高速数据传输，可以采用单机直连的方式。

*   **概念与优势**：
    *   **定义**：单机直连是指使用一根InfiniBand线缆直接连接两台服务器上的IB网卡（HCA），中间不经过任何交换机。 这种方式也被称为点对点连接。
    *   **优势**：这是最具成本效益的配置，因为它无需昂贵的IB交换机，设置简单，可以为两台主机之间提供极高的带宽和极低的延迟。
    *   **适用场景**：适用于双节点集群、测试环境搭建或特定应用中两台服务器间需要高速互联的场景。

*   **配置要点**：
    *   **硬件**：您只需要两台装有IB网卡的服务器和一根合适的IB线缆。 标准的IB线缆即可，不存在所谓的“交叉线”。
    *   **子网管理器 (Subnet Manager, SM)**：尽管没有交换机，InfiniBand网络仍然需要一个子网管理器来初始化和管理链路。 您必须在其中一台（或两台）服务器上运行OpenSM（一种常见的SM软件）。 当链路建立后，OpenSM会为网络中的每个端口分配一个本地ID（LID），使得通信成为可能。
    *   **网络配置**：在操作系统层面，通常会启用并配置IP over InfiniBand (IPoIB)。这会创建虚拟的ibX网络接口，您可以像配置普通以太网卡一样为其分配IP地址，从而使两台服务器可以通过IP协议进行通信。

#### **2. 多机集群拓扑设计（Fat-Tree等）**

当节点数量超过两个时，就需要使用IB交换机来构建一个交换网络。在高性能计算（HPC）和AI集群中，胖树（Fat-Tree）拓扑是目前应用最广泛、性能最优的网络结构之一。

*   **胖树（Fat-Tree）拓扑简介**：
    *   **核心思想**：胖树是一种分层的网络拓扑，其核心特点是网络中从任何节点到根节点的路径上都拥有恒定的带宽，越靠近网络核心（根），链路的总带宽越大，就像一棵根部更“胖”的树。 这确保了网络中任意两个节点之间都能获得无阻塞或低阻塞的通信带宽。
    *   **结构**：典型的胖树网络由两层或三层交换机构成：
        *   **接入层（Leaf Switches）**：底层交换机，直接连接计算节点和存储节点。
        *   **核心层（Spine Switches）**：上层交换机，不直接连接任何终端节点，仅用于连接接入层交换机，负责流量转发。
    *   **优势**：
        *   **高带宽与无阻塞**：理想的胖树拓扑可以提供全对分带宽（Full Bisection Bandwidth），意味着网络可以被平分成两半，两半之间所有节点能同时以全速进行通信而不会产生瓶颈。
        *   **可扩展性**：通过增加交换机和层级，胖树网络可以扩展到支持数千个节点的规模。
        *   **可预测的低延迟**：任意两个节点之间的通信跳数（经过的交换机数量）是固定的或非常接近，从而保证了稳定可预测的通信延迟。

*   **设计原则与考量**：
    *   **收敛比（Blocking Factor）**：在设计时，需要确定网络的收敛比。1:1的收敛比意味着网络是完全无阻塞的。 在实际应用中，为了平衡成本和性能，有时会设计带有一定收敛比（如2:1或3:1）的阻塞式网络，这意味着从接入层到核心层的上行链路带宽小于接入层连接服务器的总带宽。
    *   **交换机端口分配**：以一个36端口的交换机为例，在构建一个无阻塞的胖树网络时，通常会将一半的端口（18个）用于连接下层的设备（服务器或下一级交换机），另一半端口（18个）用于连接上层的核心交换机。
    *   **规模规划**：构建一个胖树网络需要仔细规划。例如，一个简单的两层胖树，当节点需求超过单个交换机端口数时，就需要多台交换机构建网络，成本会显著增加。 设计一个支持数百甚至数千个节点的网络需要非常精确的计算和布线方案。

#### **3. 冗余与高可用性方案**

在生产环境中，网络的稳定性和业务的连续性至关重要。InfiniBand网络通过其交换矩阵架构和多种设计方案来提供高可用性。

*   **多路径冗余**：
    *   InfiniBand的交换网络架构天然支持设备间的多个通信路径。 当某条链路或某个交换机端口发生故障时，子网管理器（SM）可以自动重新计算路由，将流量引导至备用路径，从而实现故障隔离和业务的快速恢复。

*   **双交换机冗余拓扑**：
    *   这是一种常见的高可用性部署方案。通过使用两台或多台核心交换机，并将每个计算节点通过不同的网卡端口分别连接到不同的交换机上，可以实现设备级的冗余。
    *   **工作模式**：
        *   **主备模式（Active-Backup）**：一个节点的多个网络接口被绑定在一起，但只有一个接口处于活动状态。当活动链路发生故障时，流量会自动切换到备用链路上。
        *   **负载均衡模式**：通过更复杂的配置，可以让流量同时经过两条链路，既实现了冗余，也提升了总带宽。
    *   **注意事项**：这种拓扑的设计目标是冗余还是性能，会影响具体的布线和配置方式。 例如，两台交换机之间是否需要互联，取决于具体的应用需求和冗余策略。

*   **子网管理器（SM）冗余**：
    *   子网管理器是IB网络的核心大脑，它的失效将导致整个子网瘫痪。 因此，在一个子网内配置多个冗余的子网管理器是至关重要的。
    *   网络中可以存在多个SM，但只有一个处于“Master”状态，其余的则作为“Standby”。当Master SM失效时，其中一个Standby SM会自动接管，确保网络的正常管理。

*   **电源与风扇冗余**：
    *   对于企业级的IB交换机，硬件本身也提供了高可用性特性，例如配备可热插拔的冗余电源和风扇模块，确保单个硬件组件的故障不会导致整个交换机关机。

