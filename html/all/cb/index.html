<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <script>if(sessionStorage.getItem('nv_net_auth')!=='524f544a8b79f41c7c60c2b1a797af2089e20cbf856d715f39ee68577ad2c344'){location.replace('../')}</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IB 网络配置计算器</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a2e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            font-size: 14px;
        }

        .header {
            background: rgba(0,0,0,0.3);
            padding: 12px 20px;
            border-bottom: 1px solid rgba(0,212,255,0.2);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header h1 {
            font-size: 18px;
            color: #00d4ff;
            font-weight: 500;
        }

        .header .subtitle {
            color: #888;
            font-size: 12px;
        }

        .main-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .input-panel {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 16px;
        }

        .section-title {
            font-size: 13px;
            color: #00d4ff;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(0,212,255,0.2);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
        }

        input, select {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 4px;
            padding: 8px 10px;
            color: #fff;
            font-size: 13px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #00d4ff;
        }

        select { cursor: pointer; }

        .server-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 12px;
            font-size: 12px;
        }

        .server-table th {
            text-align: left;
            padding: 6px 8px;
            background: rgba(0,212,255,0.1);
            color: #00d4ff;
            font-weight: 500;
            font-size: 10px;
            text-transform: uppercase;
        }

        .server-table td {
            padding: 4px 8px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .server-table input, .server-table select {
            width: 100%;
            padding: 6px;
            font-size: 12px;
        }

        .btn-calculate {
            width: 100%;
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: #000;
            border: none;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 8px;
        }

        .btn-calculate:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(0,212,255,0.3);
        }

        .result-panel {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .result-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 16px;
        }

        .result-card h3 {
            font-size: 13px;
            color: #00d4ff;
            margin-bottom: 12px;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }

        .stat-item {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 22px;
            font-weight: 600;
            color: #00d4ff;
        }

        .stat-label {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
            margin-top: 2px;
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .result-table th {
            text-align: left;
            padding: 8px;
            background: rgba(0,212,255,0.1);
            color: #00d4ff;
            font-weight: 500;
        }

        .result-table td {
            padding: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .result-table tr:hover {
            background: rgba(0,212,255,0.05);
        }

        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.1);
            color: #888;
            padding: 8px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .tab-btn:hover { color: #fff; }

        .tab-btn.active {
            background: rgba(0,212,255,0.2);
            border-color: #00d4ff;
            color: #00d4ff;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .info-row:last-child { border-bottom: none; }

        .btn-download {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            margin-top: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-download:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(46,204,113,0.3);
        }

        .btn-download:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        @media (max-width: 900px) {
            .main-container { grid-template-columns: 1fr; }
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: rgba(0,212,255,0.3); border-radius: 3px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>IB 网络配置计算器</h1>
        <span class="subtitle">InfiniBand Fabric Topology Calculator</span>
    </div>

    <div class="main-container">
        <!-- 左侧输入面板 -->
        <div class="input-panel">
            <div class="section-title">基本参数</div>
            <div class="form-row">
                <div class="form-group">
                    <label>网络速度</label>
                    <select id="speed">
                        <option value="1">HDR (200G)</option>
                        <option value="2" selected>NDR (400G)</option>
                        <option value="3">SN5610 (800G)</option>
                        <option value="4">Q3400 (800G)</option>
                        <option value="5">Q3400 降速 (400G↓800G↑)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>收敛比</label>
                    <select id="ratio">
                        <option value="1" selected>1:1</option>
                        <option value="2">1:2</option>
                        <option value="3">1:3</option>
                    </select>
                </div>
            </div>

            <div class="form-row" id="planeRow" style="display:none">
                <div class="form-group">
                    <label>平面数</label>
                    <select id="planeCount">
                        <option value="1" selected>单平面</option>
                        <option value="2">双平面</option>
                    </select>
                </div>
                <div class="form-group" id="nicTypeGroup" style="display:none">
                    <label>网卡类型</label>
                    <select id="nicType">
                        <option value="800g" selected>单口800G</option>
                        <option value="400g">双口400G</option>
                    </select>
                </div>
            </div>

            <div class="section-title">服务器配置</div>
            <table class="server-table">
                <thead>
                    <tr><th>类型</th><th>数量</th><th>NIC</th></tr>
                </thead>
                <tbody>
                    <tr>
                        <td>GPU</td>
                        <td><input type="number" id="gpuServerNum" value="0" min="0"></td>
                        <td><select id="gpuCardNum">
                            <option value="1">1</option><option value="2">2</option>
                            <option value="4">4</option><option value="8" selected>8</option>
                        </select></td>
                    </tr>
                    <tr>
                        <td>存储</td>
                        <td><input type="number" id="storageServerNum" value="0" min="0"></td>
                        <td><select id="storageCardNum">
                            <option value="1" selected>1</option><option value="2">2</option><option value="4">4</option>
                        </select></td>
                    </tr>
                    <tr>
                        <td>CPU</td>
                        <td><input type="number" id="cpuServerNum" value="0" min="0"></td>
                        <td><select id="cpuCardNum">
                            <option value="1" selected>1</option><option value="2">2</option>
                        </select></td>
                    </tr>
                    <tr>
                        <td>其他</td>
                        <td><input type="number" id="otherServerNum" value="0" min="0"></td>
                        <td><select id="otherCardNum">
                            <option value="1" selected>1</option><option value="2">2</option>
                        </select></td>
                    </tr>
                </tbody>
            </table>

            <div class="form-row">
                <div class="form-group">
                    <label>GPU 型号</label>
                    <input type="text" id="gpuType" value="B200">
                </div>
                <div class="form-group">
                    <label>DAC 线缆</label>
                    <input type="number" id="dacCableNumber" value="0" min="0">
                </div>
            </div>

            <button class="btn-calculate" id="calculateButton">计算拓扑</button>
        </div>

        <!-- 右侧结果面板 -->
        <div class="result-panel">
            <div class="result-card">
                <h3>拓扑概览</h3>
                <div class="result-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="statServers">0</div>
                        <div class="stat-label">服务器</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statNodes">0</div>
                        <div class="stat-label">节点</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statSpines">0</div>
                        <div class="stat-label">Spine</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statLeafs">0</div>
                        <div class="stat-label">Leaf</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statCables">0</div>
                        <div class="stat-label">线缆</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statSpeed">-</div>
                        <div class="stat-label">速度</div>
                    </div>
                </div>
            </div>

            <div class="result-card">
                <div class="tabs">
                    <button class="tab-btn" data-tab="detail">详细结果</button>
                    <button class="tab-btn active" data-tab="product">配置清单</button>
                </div>

                <!-- 详细结果 -->
                <div class="tab-content" id="tab-detail">
                    <div class="section-title">服务器统计</div>
                    <table class="result-table">
                        <thead><tr><th>类型</th><th>服务器</th><th>节点</th><th>Leaf</th></tr></thead>
                        <tbody>
                            <tr><td>GPU</td><td id="gpuServerResult">0</td><td id="gpuNodesResult">0</td><td id="gpuLeafsResult">0</td></tr>
                            <tr><td>存储</td><td id="storageServerResult">0</td><td id="storageNodesResult">0</td><td id="storageLeafsResult">0</td></tr>
                            <tr><td>CPU</td><td id="cpuServerResult">0</td><td id="cpuNodesResult">0</td><td id="cpuLeafsResult">0</td></tr>
                            <tr><td>其他</td><td id="otherServerResult">0</td><td id="otherNodesResult">0</td><td id="otherLeafsResult">0</td></tr>
                            <tr style="font-weight:bold;background:rgba(0,212,255,0.1)"><td>总计</td><td id="totalServerResult">0</td><td id="totalNodesResult">0</td><td id="totalLeafsResult">0</td></tr>
                        </tbody>
                    </table>

                    <div class="section-title" style="margin-top:16px">线缆统计</div>
                    <div class="info-row"><span>Spine-Leaf 线缆</span><span id="spineLeafCables">0</span></div>
                    <div class="info-row"><span>Leaf-Server 线缆</span><span id="leafServerCables">0</span></div>
                    <div class="info-row"><span>最大 Leaf-Server</span><span id="maxLeafServerCables">0</span></div>
                    <div class="info-row"><span>总线缆数</span><span id="totalCables">0</span></div>

                    <div class="section-title" style="margin-top:16px">光模块统计</div>
                    <div id="otInfo"></div>
                </div>

                <!-- 配置清单 -->
                <div class="tab-content active" id="tab-product">
                    <div id="productSummary" style="color:#00d4ff;margin-bottom:12px;font-weight:500;"></div>
                    <table class="result-table" id="productTable">
                        <thead><tr><th>产品</th><th>型号</th><th>Product Code</th><th>描述</th><th>数量</th><th>备注</th></tr></thead>
                        <tbody></tbody>
                    </table>
                    <button class="btn-download" id="downloadExcel" disabled>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        下载 Excel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SheetJS for Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script>
    // 产品数据
    const ndrProducts = [
        {name: '400G IB交换机', model: 'MQM9790-NS2R', code: '920-9B210-00RN-0D0', desc: 'NVIDIA Quantum 2 based NDR InfiniBand Switch, 64 NDR ports, 32 OSFP ports, 2 Power Supplies (AC), Standard depth, Unmanaged, C2P airflow, Rail Kit'},
        {name: '400G IB交换机', model: 'MQM9700-NS2R', code: '', desc: 'NVIDIA Quantum-2 based NDR InfiniBand Switch, 64 NDR ports, 32 OSFP ports, 2 Power Supplies (AC), Standard depth, Managed, C2P airflow, Rail Kit'},
        {name: '800G以太网交换机', model: 'SN5610', code: '920-9N42F-00RI-3C1', desc: 'NVIDIA Spectrum-4 based 800GbE 2U Open Ethernet switch with Cumulus Linux Authentication, 64 OSFP ports and 2 SFP28 ports, 4 AC PSUs, Secure-boot, standard depth, Connector-to-Power Airflow, Tool-less Rail Kit'},
        {name: '800G IB交换机', model: 'Q3400-RA', code: '920-9B36F-00RX-8S0', desc: 'NVIDIA Quantum-3 based XDR InfiniBand Switch, Q3400-RA, 4U, 144 XDR Ports over 72 OSFP Cages, 8 Power Supplies (Power Cords Not Included), Standard Depth, Managed, C2P Airflow, Rail Kit'},
        {name: '800G 光模块NDR', model: 'MMA4Z00-NS', code: '980-9I510-00NS00', desc: 'NVIDIA twin port transceiver, 800(2x400)Gbps, OSFP, 2xMPO12 APC, 850nm MMF, up to 50m, finned'},
        {name: '400G 光模块', model: 'MMA4Z00-NS400', code: '980-9I51S-00NS00', desc: 'NVIDIA single port transceiver, 400Gbps, OSFP, MPO12 APC, 850nm MMF, up to 50m, flat top'},
        {name: '1.6T 光模块', model: 'MMS4A00-XM', code: '980-9IAH1-00XM00', desc: 'NVIDIA twin port transceiver, 1600Gbps, OSFP, 2xMPO, 1310nm SMF, EML, up to 500m, IHS'},
        {name: '800G 光模块XDR', model: 'MMS4A20-XM800', code: '980-9IAT0-00XM00', desc: 'NVIDIA single port transceiver, 800Gbps, OSFP DR4, MPO, APC 1310nm SMF, up to 500m, RHS'},
        {name: 'MPO12-APC光纤', model: 'MFP7E10-N030', code: '980-9I570-00N030', desc: 'NVIDIA passive fiber cable, MMF, MPO12 APC to MPO12 APC, 30m'},
        {name: 'MPO12-APC光纤(50m)', model: 'MFP7E10-N050', code: '980-9I57Y-00N050', desc: 'NVIDIA passive fiber cable, MMF, MPO12 APC to MPO12 APC, 50m'},
        {name: 'MPO12-APC光纤(SMF)', model: 'MFP7E30-N030', code: '980-9I58G-00N030', desc: 'NVIDIA passive fiber cable, SMF, MPO12 APC to MPO12 APC, 30m'},
        {name: 'MPO12-APC光纤(SMF 50m)', model: 'MFP7E30-N050', code: '980-9I58H-00N050', desc: 'NVIDIA passive fiber cable, SMF, MPO12 APC to MPO12 APC, 50m'},
        {name: 'MPO12-APC 1分2光纤', model: 'MFP7E20-N030', code: '', desc: 'NVIDIA passive fiber cable, MMF, MPO12 APC to 2xMPO12 APC, 30m'},
        {name: '800G双端口400G光模块', model: 'MMA4Z00-NS-FLT', code: '980-9I51A-00NS00', desc: 'NVIDIA twin port transceiver, 800(2x400)Gbps, OSFP, 2xMPO12 APC, 850nm MMF, up to 50m, flat top'},
        {name: '400G单端口光模块', model: 'MMA1Z00-NS400-T', code: '980-9I693-F4NS00', desc: 'SINGLE PORT TRANSCEIVER, 400GBPS, 400GbE, QSFP112, MPO12 APC, 850NM MMF, UP TO 50M, FLAT TOP'}
    ];

    const hdrProducts = [
        {name: '200G IB交换机', model: 'MQM8790-HS2F', code: '920-9B110-00FH-0D0', desc: 'Mellanox Quantum HDR InfiniBand Switch, 40 QSFP56 ports, 2 Power Supplies (AC), unmanaged, standard depth, C2P airflow, Rail Kit'},
        {name: '200G IB交换机', model: 'MQM8700-HS2F', code: '', desc: 'Mellanox Quantum HDR InfiniBand Switch, 40 QSFP56 ports, 2 Power Supplies (AC), x86 dual core, standard depth, C2P airflow, Rail Kit'},
        {name: '200G IB AOC线缆', model: 'MFS1S00-H030V', code: '980-9I440-00H030', desc: 'Mellanox active optical cable, up to 200Gb/s IB HDR, QSFP56, 30m'},
        {name: '200G IB AOC 1分2线缆', model: 'MFS1S50-H030V', code: '', desc: 'Mellanox active optical cable, 200Gb/s to 2x100Gb/s IB HDR, QSFP56 to 2x QSFP56, 30m'}
    ];

    const PORTS = { HDR: 40, NDR: 64, SN5610_400G: 128, Q3: 144 };
    let calcResults = {};
    let productData = [];

    // 标签页切换
    document.querySelectorAll('.tab-btn[data-tab]').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn[data-tab]').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        });
    });

    // 事件绑定
    document.getElementById('calculateButton').addEventListener('click', calculate);
    document.getElementById('downloadExcel').addEventListener('click', downloadExcel);

    // SN5610 平面/网卡类型联动
    document.getElementById('speed').addEventListener('change', function() {
        const isSN5610 = this.value === '3';
        document.getElementById('planeRow').style.display = isSN5610 ? '' : 'none';
        if (!isSN5610) {
            document.getElementById('planeCount').value = '1';
            document.getElementById('nicTypeGroup').style.display = 'none';
        }
    });
    document.getElementById('planeCount').addEventListener('change', function() {
        const isDual = this.value === '2';
        document.getElementById('nicTypeGroup').style.display = isDual ? '' : 'none';
    });

    function transform(x, n) { return n * Math.ceil(x/n); }

    // 主计算函数
    function calculate() {
        const ratio = parseInt(document.getElementById('ratio').value) || 1;
        const RA = ratio + 1;
        const inputSpeed = parseInt(document.getElementById('speed').value);

        const gpuServerNum = parseInt(document.getElementById('gpuServerNum').value) || 0;
        const gpuCardNum = parseInt(document.getElementById('gpuCardNum').value);
        const storageServerNum = parseInt(document.getElementById('storageServerNum').value) || 0;
        const storageCardNum = parseInt(document.getElementById('storageCardNum').value);
        const cpuServerNum = parseInt(document.getElementById('cpuServerNum').value) || 0;
        const cpuCardNum = parseInt(document.getElementById('cpuCardNum').value);
        const otherServerNum = parseInt(document.getElementById('otherServerNum').value) || 0;
        const otherCardNum = parseInt(document.getElementById('otherCardNum').value);
        const dacCableNumber = parseInt(document.getElementById('dacCableNumber').value) || 0;

        let ports, speed, switchType, cableType, cableTypeUplink, ot800, ot400, ot1600, downlinkPorts;

        const useLongCable = gpuServerNum > 256;

        switch(inputSpeed) {
            case 1:
                ports = PORTS.HDR; speed = "HDR"; switchType = "MQM8790-HS2F";
                cableType = "MFS1S00-H030V";
                break;
            case 2:
                ports = PORTS.NDR; speed = "NDR"; switchType = "MQM9790-NS2R";
                cableType = useLongCable ? "MFP7E10-N050" : "MFP7E10-N030"; ot800 = "MMA4Z00-NS"; ot400 = "MMA4Z00-NS400";
                break;
            case 3:
                ports = PORTS.SN5610_400G; speed = "SN5610-400G"; switchType = "SN5610";
                cableType = useLongCable ? "MFP7E10-N050" : "MFP7E10-N030"; ot800 = "MMA4Z00-NS"; ot400 = "MMA4Z00-NS400";
                break;
            case 4:
                ports = PORTS.Q3; speed = "XDR"; switchType = "Q3400-RA";
                cableType = useLongCable ? "MFP7E30-N050" : "MFP7E30-N030"; ot1600 = "MMS4A00-XM"; ot800 = "MMS4A20-XM800";
                break;
            case 5:
                ports = 144; speed = "Q3400-400G"; switchType = "Q3400-RA";
                downlinkPorts = 96; // 96×400G 下行, 48×800G 上行 (非对称)
                cableType = useLongCable ? "MFP7E10-N050" : "MFP7E10-N030"; // Leaf-Server MMF
                cableTypeUplink = useLongCable ? "MFP7E30-N050" : "MFP7E30-N030"; // Spine-Leaf SMF
                ot800 = "MMA4Z00-NS"; ot400 = "MMA4Z00-NS400"; ot1600 = "MMS4A00-XM";
                break;
        }

        // 计算 bisection (上行端口数)
        let bisection, ratioText;
        if (speed === "Q3400-400G") { bisection = 48; ratioText = "1:1"; }
        else if (RA === 2 && ports === PORTS.HDR) { bisection = 20; ratioText = "1:1"; }
        else if (RA === 2 && ports === PORTS.NDR) { bisection = 32; ratioText = "1:1"; }
        else if (RA === 3 && ports === PORTS.HDR) { bisection = 16; ratioText = "3:5"; }
        else if (RA === 3 && ports === PORTS.NDR) { bisection = 20; ratioText = "1:2"; }
        else if (ports === PORTS.SN5610_400G) { bisection = Math.ceil(ports / RA); ratioText = "1:1"; }
        else if (ports === PORTS.Q3) { bisection = Math.ceil(ports / RA); ratioText = "1:1"; }
        else { bisection = 32; ratioText = "1:1"; }

        const dlPorts = downlinkPorts || bisection; // 下行端口容量 (非对称时 ≠ bisection)

        const factors = [];
        for (let i = 1; i <= bisection; i++) if (bisection % i === 0) factors.push(i);

        // GPU
        let gpuLeafs = 0, gpuNodes = 0, restGpuPorts = 0;
        if (gpuServerNum > 0) {
            const suNodes = gpuCardNum * dlPorts;
            const su = Math.ceil((gpuServerNum * gpuCardNum) / suNodes);
            gpuLeafs = gpuCardNum * su;
            gpuNodes = gpuServerNum * gpuCardNum;
            restGpuPorts = su * suNodes - gpuNodes;
        }

        // Storage
        let storageLeafs = 0, storageNodes = 0, restStoragePorts = 0;
        if (storageServerNum > 0) {
            storageNodes = storageServerNum * storageCardNum;
            storageLeafs = (storageNodes - restGpuPorts) / dlPorts;
            if (storageLeafs > 0) storageLeafs = transform(storageLeafs, storageCardNum);
            else storageLeafs = 0;
            restStoragePorts = (gpuLeafs + storageLeafs) * dlPorts - (gpuNodes + storageNodes);
        } else {
            restStoragePorts = gpuLeafs * dlPorts - gpuNodes;
        }

        // CPU
        let cpuLeafs = 0, cpuNodes = 0, restCpuPorts = 0;
        if (cpuServerNum > 0) {
            cpuNodes = cpuServerNum * cpuCardNum;
            cpuLeafs = (cpuNodes - restStoragePorts) / dlPorts;
            if (cpuLeafs > 0) cpuLeafs = transform(cpuLeafs, cpuCardNum);
            else cpuLeafs = 0;
            restCpuPorts = (gpuLeafs + storageLeafs + cpuLeafs) * dlPorts - (gpuNodes + storageNodes + cpuNodes);
        } else {
            restCpuPorts = (gpuLeafs + storageLeafs) * dlPorts - (gpuNodes + storageNodes);
        }

        // Other
        let otherLeafs = 0, otherNodes = 0;
        if (otherServerNum > 0) {
            otherNodes = otherServerNum * otherCardNum;
            otherLeafs = (otherNodes - restCpuPorts) / dlPorts;
            if (otherLeafs > 0) otherLeafs = transform(otherLeafs, otherCardNum);
            else otherLeafs = 0;
        }

        const serverNum = gpuServerNum + storageServerNum + cpuServerNum + otherServerNum;
        const nodes = gpuNodes + storageNodes + cpuNodes + otherNodes;
        const leafs = gpuLeafs + storageLeafs + cpuLeafs + otherLeafs;

        let spines = Math.ceil(leafs * bisection / ports);
        if (!factors.includes(spines)) {
            for (const f of factors) if (f > spines) { spines = f; break; }
        }

        const spineToLeafCables = Math.floor(leafs * bisection);
        let leafToServerCables = Math.floor(nodes);
        const maxLeafToServerCables = leafs * (ports - bisection);

        // 光模块
        let spine2LeafOT = 0, leaf2ServerOT = 0, switchOT = 0, hcaOT = nodes;
        let q3SpineToLeafOT = 0, q3LeafToServerOT = 0, q3OT = 0;

        if (speed === "NDR" || speed === "SN5610-400G") {
            spine2LeafOT = Math.ceil(leafs * bisection * 2 / 2);
            leaf2ServerOT = Math.ceil(nodes / 2);
            switchOT = spine2LeafOT + leaf2ServerOT;
        } else if (speed === "XDR") {
            q3SpineToLeafOT = Math.ceil(leafs * bisection * 2 / 2);
            q3LeafToServerOT = Math.ceil(nodes / 2);
            q3OT = q3SpineToLeafOT + q3LeafToServerOT;
        } else if (speed === "Q3400-400G") {
            // Spine-Leaf: MMS4A00-XM (1.6T双端口800G) 两端各需
            q3SpineToLeafOT = Math.ceil(leafs * bisection * 2 / 2);
            // Leaf-Server: MMA4Z00-NS (800G双端口400G) 仅Leaf侧
            leaf2ServerOT = Math.ceil(nodes / 2);
        }

        if (dacCableNumber > 0) {
            leafToServerCables -= dacCableNumber * 2;
            hcaOT -= dacCableNumber * 2;
            if (speed === "NDR" || speed === "SN5610-400G") {
                leaf2ServerOT -= dacCableNumber;
                switchOT = spine2LeafOT + leaf2ServerOT;
            } else if (speed === "XDR") {
                q3LeafToServerOT -= dacCableNumber;
                q3OT = q3SpineToLeafOT + q3LeafToServerOT;
            }
        }

        const numPlanes = (inputSpeed === 3) ? parseInt(document.getElementById('planeCount').value) : 1;
        const nicType = (numPlanes === 2) ? document.getElementById('nicType').value : '';

        calcResults = {
            speed, ratioText, switchType, cableType, cableTypeUplink, ot800, ot400, ot1600,
            serverNum, nodes, spines, leafs,
            gpuServerNum, gpuNodes, gpuLeafs,
            storageServerNum, storageNodes, storageLeafs,
            cpuServerNum, cpuNodes, cpuLeafs,
            otherServerNum, otherNodes, otherLeafs,
            spineToLeafCables, leafToServerCables, maxLeafToServerCables,
            allCables: spineToLeafCables + leafToServerCables,
            spine2LeafOT, leaf2ServerOT, switchOT, hcaOT,
            q3SpineToLeafOT, q3LeafToServerOT, q3OT,
            numPlanes, nicType
        };

        updateUI();
    }

    function updateUI() {
        const r = calcResults;
        const np = r.numPlanes || 1;

        // 概览
        document.getElementById('statServers').textContent = r.serverNum;
        document.getElementById('statNodes').textContent = r.nodes * np;
        document.getElementById('statSpines').textContent = r.spines * np;
        document.getElementById('statLeafs').textContent = r.leafs * np;
        document.getElementById('statCables').textContent = r.allCables * np;
        document.getElementById('statSpeed').textContent = r.speed + (np > 1 ? ' (双平面)' : '');

        // 详细
        document.getElementById('gpuServerResult').textContent = r.gpuServerNum;
        document.getElementById('gpuNodesResult').textContent = r.gpuNodes * np;
        document.getElementById('gpuLeafsResult').textContent = r.gpuLeafs * np;
        document.getElementById('storageServerResult').textContent = r.storageServerNum;
        document.getElementById('storageNodesResult').textContent = r.storageNodes * np;
        document.getElementById('storageLeafsResult').textContent = r.storageLeafs * np;
        document.getElementById('cpuServerResult').textContent = r.cpuServerNum;
        document.getElementById('cpuNodesResult').textContent = r.cpuNodes * np;
        document.getElementById('cpuLeafsResult').textContent = r.cpuLeafs * np;
        document.getElementById('otherServerResult').textContent = r.otherServerNum;
        document.getElementById('otherNodesResult').textContent = r.otherNodes * np;
        document.getElementById('otherLeafsResult').textContent = r.otherLeafs * np;
        document.getElementById('totalServerResult').textContent = r.serverNum;
        document.getElementById('totalNodesResult').textContent = r.nodes * np;
        document.getElementById('totalLeafsResult').textContent = r.leafs * np;

        document.getElementById('spineLeafCables').textContent = r.spineToLeafCables * np;
        document.getElementById('leafServerCables').textContent = r.leafToServerCables * np;
        document.getElementById('maxLeafServerCables').textContent = r.maxLeafToServerCables * np;
        document.getElementById('totalCables').textContent = r.allCables * np;

        // 光模块
        let otHtml = '';
        if (r.speed === "NDR" || r.speed === "SN5610-400G") {
            otHtml = `
                <div class="info-row"><span>Spine-Leaf 800G 双端口</span><span>${r.spine2LeafOT * np}</span></div>
                <div class="info-row"><span>Leaf-Server 800G 双端口</span><span>${r.leaf2ServerOT * np}</span></div>
                <div class="info-row"><span>交换机侧总数</span><span>${r.switchOT * np}</span></div>`;
            if (np > 1 && r.nicType === '800g') {
                otHtml += `<div class="info-row"><span>网卡侧 单口800G双端口光模块</span><span>${r.hcaOT}</span></div>`;
            } else if (np > 1 && r.nicType === '400g') {
                otHtml += `<div class="info-row"><span>网卡侧 双口400G单端口光模块</span><span>${r.hcaOT * 2}</span></div>`;
            } else {
                otHtml += `<div class="info-row"><span>HCA 400G 单端口</span><span>${r.hcaOT}</span></div>`;
            }
        } else if (r.speed === "XDR") {
            otHtml = `
                <div class="info-row"><span>Spine-Leaf 1.6T 双端口</span><span>${r.q3SpineToLeafOT}</span></div>
                <div class="info-row"><span>Leaf-Server 1.6T 双端口</span><span>${r.q3LeafToServerOT}</span></div>
                <div class="info-row"><span>交换机侧总数</span><span>${r.q3OT}</span></div>
                <div class="info-row"><span>HCA 800G 单端口</span><span>${r.hcaOT}</span></div>`;
        } else if (r.speed === "Q3400-400G") {
            otHtml = `
                <div class="info-row"><span>Spine-Leaf MMS4A00-XM (1.6T)</span><span>${r.q3SpineToLeafOT}</span></div>
                <div class="info-row"><span>Leaf-Server MMA4Z00-NS (800G)</span><span>${r.leaf2ServerOT}</span></div>
                <div class="info-row"><span>交换机侧总数</span><span>${r.q3SpineToLeafOT + r.leaf2ServerOT}</span></div>
                <div class="info-row"><span>HCA MMA4Z00-NS400 (400G)</span><span>${r.hcaOT}</span></div>`;
        } else if (r.speed === "HDR") {
            otHtml = `<div class="info-row"><span>HDR AOC 线缆</span><span>${r.allCables}</span></div>`;
        }
        document.getElementById('otInfo').innerHTML = otHtml;

        // 产品清单
        const gpuType = document.getElementById('gpuType').value || 'H800';
        let summary = [];
        if (r.gpuServerNum > 0) summary.push(`${r.gpuServerNum}台 ${gpuType} GPU`);
        if (r.storageServerNum > 0) summary.push(`${r.storageServerNum}台存储`);
        if (r.cpuServerNum > 0) summary.push(`${r.cpuServerNum}台CPU`);
        if (r.otherServerNum > 0) summary.push(`${r.otherServerNum}台其他`);
        const planeLabel = np > 1 ? ' (双平面)' : '';
        const summaryText = (summary.join('、') || '服务器') + ` ${r.speed}网络配置清单` + planeLabel;
        document.getElementById('productSummary').textContent = summaryText;

        const tbody = document.querySelector('#productTable tbody');
        tbody.innerHTML = '';
        const products = r.speed === "HDR" ? hdrProducts : ndrProducts;
        const pn = np > 1 ? ` (×${np}平面)` : '';

        let items;

        if (r.speed === "Q3400-400G") {
            // Q3400 降速: 非对称端口 (96×400G↓ + 48×800G↑), 不同层使用不同线缆和光模块
            items = [
                { model: r.switchType, num: r.spines, note: 'Spine 交换机' },
                { model: r.switchType, num: r.leafs, note: 'Leaf 交换机' },
                { model: r.cableTypeUplink, num: r.spineToLeafCables, note: 'Spine-Leaf 线缆 (SMF 800G)' },
                { model: r.cableType, num: r.leafToServerCables, note: 'Leaf-Server 线缆 (MMF 400G)' },
                { model: r.ot1600, num: r.q3SpineToLeafOT, note: 'Spine-Leaf MMS4A00-XM' },
                { model: r.ot800, num: r.leaf2ServerOT, note: 'Leaf-Server MMA4Z00-NS' },
                { model: r.ot400, num: r.hcaOT, note: 'HCA 400G' }
            ];
        } else {
            items = [
                { model: r.switchType, num: r.spines * np, note: 'Spine 交换机' + pn },
                { model: r.switchType, num: r.leafs * np, note: 'Leaf 交换机' + pn },
                { model: r.cableType, num: r.spineToLeafCables * np, note: 'Spine-Leaf 线缆' + pn },
                { model: r.cableType, num: r.leafToServerCables * np, note: 'Leaf-Server 线缆' + pn }
            ];

            if (r.speed === "NDR" || r.speed === "SN5610-400G") {
                items.push({ model: r.ot800, num: r.spine2LeafOT * np, note: 'Spine-Leaf 800G' + pn });
                items.push({ model: r.ot800, num: r.leaf2ServerOT * np, note: 'Leaf-Server 800G' + pn });
                if (np > 1 && r.nicType === '800g') {
                    items.push({ model: 'MMA4Z00-NS-FLT', num: r.hcaOT, note: '网卡侧 单口800G光模块' });
                } else if (np > 1 && r.nicType === '400g') {
                    items.push({ model: 'MMA1Z00-NS400-T', num: r.hcaOT * 2, note: '网卡侧 双口400G光模块' });
                } else {
                    items.push({ model: r.ot400, num: r.hcaOT, note: 'HCA 400G' });
                }
            } else if (r.speed === "XDR") {
                items.push({ model: r.ot1600, num: r.q3SpineToLeafOT, note: 'Spine-Leaf 1.6T' });
                items.push({ model: r.ot1600, num: r.q3LeafToServerOT, note: 'Leaf-Server 1.6T' });
                items.push({ model: r.ot800, num: r.hcaOT, note: 'HCA 800G' });
            }
        }

        // 保存产品数据用于导出
        productData = [];

        items.forEach(item => {
            if (item.num > 0) {
                const prod = products.find(p => p.model === item.model);
                if (prod) {
                    const row = tbody.insertRow();
                    row.innerHTML = `<td>${prod.name}</td><td>${prod.model}</td><td>${prod.code || ''}</td><td>${prod.desc}</td><td>${item.num}</td><td>${item.note}</td>`;
                    productData.push({
                        '产品名称': prod.name,
                        '型号': prod.model,
                        'Product Code': prod.code || '',
                        '描述': prod.desc,
                        '数量': item.num,
                        '备注': item.note
                    });
                }
            }
        });

        // 启用下载按钮
        document.getElementById('downloadExcel').disabled = productData.length === 0;
    }

    function downloadExcel() {
        if (productData.length === 0) {
            alert('请先计算拓扑');
            return;
        }

        const r = calcResults;
        const gpuType = document.getElementById('gpuType').value || 'H800';

        // 创建工作簿
        const wb = XLSX.utils.book_new();

        // 配置清单表
        const wsData = [
            ['产品名称', '型号', 'Product Code', '描述', '数量', '备注']
        ];

        // 添加产品数据
        productData.forEach(item => {
            wsData.push([item['产品名称'], item['型号'], item['Product Code'], item['描述'], item['数量'], item['备注']]);
        });

        const ws = XLSX.utils.aoa_to_sheet(wsData);

        // 设置列宽
        ws['!cols'] = [
            { wch: 18 },
            { wch: 25 },
            { wch: 22 },
            { wch: 45 },
            { wch: 8 },
            { wch: 18 }
        ];

        XLSX.utils.book_append_sheet(wb, ws, '配置清单');

        // 生成文件名
        let filename = `IB网络配置清单_${r.speed}`;
        if (r.gpuServerNum > 0) filename += `_${r.gpuServerNum}台${gpuType}`;
        filename += `_${new Date().toISOString().slice(0,10)}.xlsx`;

        // 下载文件
        XLSX.writeFile(wb, filename);
    }
    </script>
</body>
</html>
