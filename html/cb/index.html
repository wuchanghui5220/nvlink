<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IB 网络配置计算器</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a2e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            font-size: 14px;
        }

        .header {
            background: rgba(0,0,0,0.3);
            padding: 12px 20px;
            border-bottom: 1px solid rgba(0,212,255,0.2);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header h1 {
            font-size: 18px;
            color: #00d4ff;
            font-weight: 500;
        }

        .header .subtitle {
            color: #888;
            font-size: 12px;
        }

        .main-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .input-panel {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 16px;
        }

        .section-title {
            font-size: 13px;
            color: #00d4ff;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(0,212,255,0.2);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
        }

        input, select {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 4px;
            padding: 8px 10px;
            color: #fff;
            font-size: 13px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #00d4ff;
        }

        select { cursor: pointer; }

        .server-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 12px;
            font-size: 12px;
        }

        .server-table th {
            text-align: left;
            padding: 6px 8px;
            background: rgba(0,212,255,0.1);
            color: #00d4ff;
            font-weight: 500;
            font-size: 10px;
            text-transform: uppercase;
        }

        .server-table td {
            padding: 4px 8px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .server-table input, .server-table select {
            width: 100%;
            padding: 6px;
            font-size: 12px;
        }

        .btn-calculate {
            width: 100%;
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: #000;
            border: none;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 8px;
        }

        .btn-calculate:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(0,212,255,0.3);
        }

        .result-panel {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .result-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 16px;
        }

        .result-card h3 {
            font-size: 13px;
            color: #00d4ff;
            margin-bottom: 12px;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }

        .stat-item {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 22px;
            font-weight: 600;
            color: #00d4ff;
        }

        .stat-label {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
            margin-top: 2px;
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .result-table th {
            text-align: left;
            padding: 8px;
            background: rgba(0,212,255,0.1);
            color: #00d4ff;
            font-weight: 500;
        }

        .result-table td {
            padding: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .result-table tr:hover {
            background: rgba(0,212,255,0.05);
        }

        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.1);
            color: #888;
            padding: 8px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .tab-btn:hover { color: #fff; }

        .tab-btn.active {
            background: rgba(0,212,255,0.2);
            border-color: #00d4ff;
            color: #00d4ff;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .info-row:last-child { border-bottom: none; }

        .btn-download {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            margin-top: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-download:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(46,204,113,0.3);
        }

        .btn-download:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        @media (max-width: 900px) {
            .main-container { grid-template-columns: 1fr; }
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: rgba(0,212,255,0.3); border-radius: 3px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>IB 网络配置计算器</h1>
        <span class="subtitle">InfiniBand Fabric Topology Calculator</span>
    </div>

    <div class="main-container">
        <!-- 左侧输入面板 -->
        <div class="input-panel">
            <div class="section-title">基本参数</div>
            <div class="form-row">
                <div class="form-group">
                    <label>网络速度</label>
                    <select id="speed">
                        <option value="1">HDR (200G)</option>
                        <option value="2" selected>NDR (400G)</option>
                        <option value="3">SN5600 (400G)</option>
                        <option value="4">Q3400 (800G)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>收敛比</label>
                    <select id="ratio">
                        <option value="1" selected>1:1</option>
                        <option value="2">1:2</option>
                        <option value="3">1:3</option>
                    </select>
                </div>
            </div>

            <div class="section-title">服务器配置</div>
            <table class="server-table">
                <thead>
                    <tr><th>类型</th><th>数量</th><th>NIC</th></tr>
                </thead>
                <tbody>
                    <tr>
                        <td>GPU</td>
                        <td><input type="number" id="gpuServerNum" value="0" min="0"></td>
                        <td><select id="gpuCardNum">
                            <option value="1">1</option><option value="2">2</option>
                            <option value="4">4</option><option value="8" selected>8</option>
                        </select></td>
                    </tr>
                    <tr>
                        <td>存储</td>
                        <td><input type="number" id="storageServerNum" value="0" min="0"></td>
                        <td><select id="storageCardNum">
                            <option value="1" selected>1</option><option value="2">2</option><option value="4">4</option>
                        </select></td>
                    </tr>
                    <tr>
                        <td>CPU</td>
                        <td><input type="number" id="cpuServerNum" value="0" min="0"></td>
                        <td><select id="cpuCardNum">
                            <option value="1" selected>1</option><option value="2">2</option>
                        </select></td>
                    </tr>
                    <tr>
                        <td>其他</td>
                        <td><input type="number" id="otherServerNum" value="0" min="0"></td>
                        <td><select id="otherCardNum">
                            <option value="1" selected>1</option><option value="2">2</option>
                        </select></td>
                    </tr>
                </tbody>
            </table>

            <div class="form-row">
                <div class="form-group">
                    <label>GPU 型号</label>
                    <input type="text" id="gpuType" value="H800">
                </div>
                <div class="form-group">
                    <label>DAC 线缆</label>
                    <input type="number" id="dacCableNumber" value="0" min="0">
                </div>
            </div>

            <button class="btn-calculate" id="calculateButton">计算拓扑</button>
        </div>

        <!-- 右侧结果面板 -->
        <div class="result-panel">
            <div class="result-card">
                <h3>拓扑概览</h3>
                <div class="result-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="statServers">0</div>
                        <div class="stat-label">服务器</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statNodes">0</div>
                        <div class="stat-label">节点</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statSpines">0</div>
                        <div class="stat-label">Spine</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statLeafs">0</div>
                        <div class="stat-label">Leaf</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statCables">0</div>
                        <div class="stat-label">线缆</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statSpeed">-</div>
                        <div class="stat-label">速度</div>
                    </div>
                </div>
            </div>

            <div class="result-card">
                <div class="tabs">
                    <button class="tab-btn" data-tab="detail">详细结果</button>
                    <button class="tab-btn active" data-tab="product">配置清单</button>
                </div>

                <!-- 详细结果 -->
                <div class="tab-content" id="tab-detail">
                    <div class="section-title">服务器统计</div>
                    <table class="result-table">
                        <thead><tr><th>类型</th><th>服务器</th><th>节点</th><th>Leaf</th></tr></thead>
                        <tbody>
                            <tr><td>GPU</td><td id="gpuServerResult">0</td><td id="gpuNodesResult">0</td><td id="gpuLeafsResult">0</td></tr>
                            <tr><td>存储</td><td id="storageServerResult">0</td><td id="storageNodesResult">0</td><td id="storageLeafsResult">0</td></tr>
                            <tr><td>CPU</td><td id="cpuServerResult">0</td><td id="cpuNodesResult">0</td><td id="cpuLeafsResult">0</td></tr>
                            <tr><td>其他</td><td id="otherServerResult">0</td><td id="otherNodesResult">0</td><td id="otherLeafsResult">0</td></tr>
                            <tr style="font-weight:bold;background:rgba(0,212,255,0.1)"><td>总计</td><td id="totalServerResult">0</td><td id="totalNodesResult">0</td><td id="totalLeafsResult">0</td></tr>
                        </tbody>
                    </table>

                    <div class="section-title" style="margin-top:16px">线缆统计</div>
                    <div class="info-row"><span>Spine-Leaf 线缆</span><span id="spineLeafCables">0</span></div>
                    <div class="info-row"><span>Leaf-Server 线缆</span><span id="leafServerCables">0</span></div>
                    <div class="info-row"><span>最大 Leaf-Server</span><span id="maxLeafServerCables">0</span></div>
                    <div class="info-row"><span>总线缆数</span><span id="totalCables">0</span></div>

                    <div class="section-title" style="margin-top:16px">光模块统计</div>
                    <div id="otInfo"></div>
                </div>

                <!-- 配置清单 -->
                <div class="tab-content active" id="tab-product">
                    <div id="productSummary" style="color:#00d4ff;margin-bottom:12px;font-weight:500;"></div>
                    <table class="result-table" id="productTable">
                        <thead><tr><th>产品</th><th>型号</th><th>描述</th><th>数量</th><th>备注</th></tr></thead>
                        <tbody></tbody>
                    </table>
                    <button class="btn-download" id="downloadExcel" disabled>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        下载 Excel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SheetJS for Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script>
    // 产品数据
    const ndrProducts = [
        {name: '400G IB交换机', model: 'MQM9790-NS2R', desc: 'NVIDIA Quantum-2 based NDR InfiniBand Switch, 64 NDR ports, 32 OSFP ports, 2 Power Supplies (AC), Standard depth, Unmanaged, C2P airflow, RailKit'},
        {name: '400G IB交换机', model: 'MQM9700-NS2R', desc: 'NVIDIA Quantum-2 based NDR InfiniBand Switch, 64 NDR ports, 32 OSFP ports, 2 Power Supplies (AC), Standard depth, Managed, C2P airflow, Rail Kit'},
        {name: '400G IB交换机', model: 'SN5600', desc: 'NVIDIA Spectrum-4 based 800GbE 2U Open Ethernet switch with Cumulus Linux authentication, 64 OSFP ports and 1 SFP28 port, 2 power supplies (AC), x86 CPU, Secure Boot, standard depth, C2P airflow, tool-less rail kit'},
        {name: '800G IB交换机', model: 'Q3400', desc: '920-9B36F-00RX-8S0 NVIDIA AIR COOLED SYSTEM 72 PORTS OSFP XDR MNG SWITCH W/ 8 PS STANDARD DEPTH C2P AIRFLOW'},
        {name: '800G 光模块NDR', model: 'MMA4Z00-NS', desc: 'NVIDIA twin port transceiver, 800Gbps, 2xNDR, OSFP, 2xMPO12 APC, 850nm MMF, up to 50m, finned'},
        {name: '400G 光模块', model: 'MMA4Z00-NS400', desc: 'NVIDIA single port transceiver, 400Gbps, NDR, OSFP, MPO12 APC, 850nm MMF, up to 50m, flat top'},
        {name: '1.6T 光模块', model: 'NVIDIA 1.6T transceiver', desc: 'NVIDIA twin port transceiver, 1.6Tbps, Q3, OSFP, MPO12 APC, 1310nm MMF, up to 500m'},
        {name: '800G 光模块XDR', model: 'MMS8X00-NS800', desc: 'NVIDIA single port transceiver, 800Gbps, XDR, OSFP, MPO12 APC, 1310nm SMF, up to 500m, flat top'},
        {name: 'MPO12-APC光纤', model: 'MFP7E10-N030', desc: 'NVIDIA passive fiber cable, MMF, MPO12 APC to MPO12 APC, 30m'},
        {name: 'MPO12-APC光纤(SMF)', model: 'MFP7E30-N030', desc: 'NVIDIA passive fiber cable, SMF, MPO12 APC to MPO12 APC, 30m'},
        {name: 'MPO12-APC 1分2光纤', model: 'MFP7E20-N030', desc: 'NVIDIA passive fiber cable, MMF, MPO12 APC to 2xMPO12 APC, 30m'}
    ];

    const hdrProducts = [
        {name: '200G IB交换机', model: 'MQM8790-HS2F', desc: 'Mellanox Quantum HDR InfiniBand Switch, 40 QSFP56 ports, 2 Power Supplies (AC), unmanaged, standard depth, C2P airflow, Rail Kit'},
        {name: '200G IB交换机', model: 'MQM8700-HS2F', desc: 'Mellanox Quantum HDR InfiniBand Switch, 40 QSFP56 ports, 2 Power Supplies (AC), x86 dual core, standard depth, C2P airflow, Rail Kit'},
        {name: '200G IB AOC线缆', model: 'MFS1S00-H030V', desc: 'Mellanox active optical cable, up to 200Gb/s IB HDR, QSFP56, 30m'},
        {name: '200G IB AOC 1分2线缆', model: 'MFS1S50-H030V', desc: 'Mellanox active optical cable, 200Gb/s to 2x100Gb/s IB HDR, QSFP56 to 2x QSFP56, 30m'}
    ];

    const PORTS = { HDR: 40, NDR: 64, SN5600_NDR: 128, Q3: 144 };
    let calcResults = {};
    let productData = [];

    // 标签页切换
    document.querySelectorAll('.tab-btn[data-tab]').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn[data-tab]').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        });
    });

    // 事件绑定
    document.getElementById('calculateButton').addEventListener('click', calculate);
    document.getElementById('downloadExcel').addEventListener('click', downloadExcel);

    function transform(x, n) { return n * Math.ceil(x/n); }

    // 主计算函数
    function calculate() {
        const ratio = parseInt(document.getElementById('ratio').value) || 1;
        const RA = ratio + 1;
        const inputSpeed = parseInt(document.getElementById('speed').value);

        const gpuServerNum = parseInt(document.getElementById('gpuServerNum').value) || 0;
        const gpuCardNum = parseInt(document.getElementById('gpuCardNum').value);
        const storageServerNum = parseInt(document.getElementById('storageServerNum').value) || 0;
        const storageCardNum = parseInt(document.getElementById('storageCardNum').value);
        const cpuServerNum = parseInt(document.getElementById('cpuServerNum').value) || 0;
        const cpuCardNum = parseInt(document.getElementById('cpuCardNum').value);
        const otherServerNum = parseInt(document.getElementById('otherServerNum').value) || 0;
        const otherCardNum = parseInt(document.getElementById('otherCardNum').value);
        const dacCableNumber = parseInt(document.getElementById('dacCableNumber').value) || 0;

        let ports, speed, switchType, cableType, ot800, ot400, ot1600;

        switch(inputSpeed) {
            case 1:
                ports = PORTS.HDR; speed = "HDR"; switchType = "MQM8790-HS2F";
                cableType = "MFS1S00-H030V";
                break;
            case 2:
                ports = PORTS.NDR; speed = "NDR"; switchType = "MQM9790-NS2R";
                cableType = "MFP7E10-N030"; ot800 = "MMA4Z00-NS"; ot400 = "MMA4Z00-NS400";
                break;
            case 3:
                ports = PORTS.SN5600_NDR; speed = "SN5600-NDR"; switchType = "SN5600";
                cableType = "MFP7E10-N030"; ot800 = "MMA4Z00-NS"; ot400 = "MMA4Z00-NS400";
                break;
            case 4:
                ports = PORTS.Q3; speed = "XDR"; switchType = "Q3400";
                cableType = "MFP7E30-N030"; ot1600 = "NVIDIA 1.6T transceiver"; ot800 = "MMS8X00-NS800";
                break;
        }

        // 计算 bisection
        let bisection, ratioText;
        if (RA === 2 && ports === PORTS.HDR) { bisection = 20; ratioText = "1:1"; }
        else if (RA === 2 && ports === PORTS.NDR) { bisection = 32; ratioText = "1:1"; }
        else if (RA === 3 && ports === PORTS.HDR) { bisection = 16; ratioText = "3:5"; }
        else if (RA === 3 && ports === PORTS.NDR) { bisection = 20; ratioText = "1:2"; }
        else if (ports === PORTS.SN5600_NDR) { bisection = Math.ceil(ports / RA); ratioText = "1:1"; }
        else if (ports === PORTS.Q3) { bisection = Math.ceil(ports / RA); ratioText = "1:1"; }
        else { bisection = 32; ratioText = "1:1"; }

        const factors = [];
        for (let i = 1; i <= bisection; i++) if (bisection % i === 0) factors.push(i);

        // GPU
        let gpuLeafs = 0, gpuNodes = 0, restGpuPorts = 0;
        if (gpuServerNum > 0) {
            const suNodes = gpuCardNum * bisection;
            const su = Math.ceil((gpuServerNum * gpuCardNum) / suNodes);
            gpuLeafs = gpuCardNum * su;
            gpuNodes = gpuServerNum * gpuCardNum;
            restGpuPorts = su * suNodes - gpuNodes;
        }

        // Storage
        let storageLeafs = 0, storageNodes = 0, restStoragePorts = 0;
        if (storageServerNum > 0) {
            storageNodes = storageServerNum * storageCardNum;
            storageLeafs = (storageNodes - restGpuPorts) / bisection;
            if (storageLeafs > 0) storageLeafs = transform(storageLeafs, storageCardNum);
            else storageLeafs = 0;
            restStoragePorts = (gpuLeafs + storageLeafs) * bisection - (gpuNodes + storageNodes);
        } else {
            restStoragePorts = gpuLeafs * bisection - gpuNodes;
        }

        // CPU
        let cpuLeafs = 0, cpuNodes = 0, restCpuPorts = 0;
        if (cpuServerNum > 0) {
            cpuNodes = cpuServerNum * cpuCardNum;
            cpuLeafs = (cpuNodes - restStoragePorts) / bisection;
            if (cpuLeafs > 0) cpuLeafs = transform(cpuLeafs, cpuCardNum);
            else cpuLeafs = 0;
            restCpuPorts = (gpuLeafs + storageLeafs + cpuLeafs) * bisection - (gpuNodes + storageNodes + cpuNodes);
        } else {
            restCpuPorts = (gpuLeafs + storageLeafs) * bisection - (gpuNodes + storageNodes);
        }

        // Other
        let otherLeafs = 0, otherNodes = 0;
        if (otherServerNum > 0) {
            otherNodes = otherServerNum * otherCardNum;
            otherLeafs = (otherNodes - restCpuPorts) / bisection;
            if (otherLeafs > 0) otherLeafs = transform(otherLeafs, otherCardNum);
            else otherLeafs = 0;
        }

        const serverNum = gpuServerNum + storageServerNum + cpuServerNum + otherServerNum;
        const nodes = gpuNodes + storageNodes + cpuNodes + otherNodes;
        const leafs = gpuLeafs + storageLeafs + cpuLeafs + otherLeafs;

        let spines = Math.ceil(leafs * bisection / ports);
        if (!factors.includes(spines)) {
            for (const f of factors) if (f > spines) { spines = f; break; }
        }

        const spineToLeafCables = Math.floor(leafs * bisection);
        let leafToServerCables = Math.floor(nodes);
        const maxLeafToServerCables = leafs * (ports - bisection);

        // 光模块
        let spine2LeafOT = 0, leaf2ServerOT = 0, switchOT = 0, hcaOT = nodes;
        let q3SpineToLeafOT = 0, q3LeafToServerOT = 0, q3OT = 0;

        if (speed === "NDR" || speed === "SN5600-NDR") {
            spine2LeafOT = Math.ceil(leafs * bisection * 2 / 2);
            leaf2ServerOT = Math.ceil(nodes / 2);
            switchOT = spine2LeafOT + leaf2ServerOT;
        } else if (speed === "XDR") {
            q3SpineToLeafOT = Math.ceil(leafs * bisection * 2 / 2);
            q3LeafToServerOT = Math.ceil(nodes / 2);
            q3OT = q3SpineToLeafOT + q3LeafToServerOT;
        }

        if (dacCableNumber > 0) {
            leafToServerCables -= dacCableNumber * 2;
            hcaOT -= dacCableNumber * 2;
            if (speed === "NDR" || speed === "SN5600-NDR") {
                leaf2ServerOT -= dacCableNumber;
                switchOT = spine2LeafOT + leaf2ServerOT;
            } else if (speed === "XDR") {
                q3LeafToServerOT -= dacCableNumber;
                q3OT = q3SpineToLeafOT + q3LeafToServerOT;
            }
        }

        calcResults = {
            speed, ratioText, switchType, cableType, ot800, ot400, ot1600,
            serverNum, nodes, spines, leafs,
            gpuServerNum, gpuNodes, gpuLeafs,
            storageServerNum, storageNodes, storageLeafs,
            cpuServerNum, cpuNodes, cpuLeafs,
            otherServerNum, otherNodes, otherLeafs,
            spineToLeafCables, leafToServerCables, maxLeafToServerCables,
            allCables: spineToLeafCables + leafToServerCables,
            spine2LeafOT, leaf2ServerOT, switchOT, hcaOT,
            q3SpineToLeafOT, q3LeafToServerOT, q3OT
        };

        updateUI();
    }

    function updateUI() {
        const r = calcResults;

        // 概览
        document.getElementById('statServers').textContent = r.serverNum;
        document.getElementById('statNodes').textContent = r.nodes;
        document.getElementById('statSpines').textContent = r.spines;
        document.getElementById('statLeafs').textContent = r.leafs;
        document.getElementById('statCables').textContent = r.allCables;
        document.getElementById('statSpeed').textContent = r.speed;

        // 详细
        document.getElementById('gpuServerResult').textContent = r.gpuServerNum;
        document.getElementById('gpuNodesResult').textContent = r.gpuNodes;
        document.getElementById('gpuLeafsResult').textContent = r.gpuLeafs;
        document.getElementById('storageServerResult').textContent = r.storageServerNum;
        document.getElementById('storageNodesResult').textContent = r.storageNodes;
        document.getElementById('storageLeafsResult').textContent = r.storageLeafs;
        document.getElementById('cpuServerResult').textContent = r.cpuServerNum;
        document.getElementById('cpuNodesResult').textContent = r.cpuNodes;
        document.getElementById('cpuLeafsResult').textContent = r.cpuLeafs;
        document.getElementById('otherServerResult').textContent = r.otherServerNum;
        document.getElementById('otherNodesResult').textContent = r.otherNodes;
        document.getElementById('otherLeafsResult').textContent = r.otherLeafs;
        document.getElementById('totalServerResult').textContent = r.serverNum;
        document.getElementById('totalNodesResult').textContent = r.nodes;
        document.getElementById('totalLeafsResult').textContent = r.leafs;

        document.getElementById('spineLeafCables').textContent = r.spineToLeafCables;
        document.getElementById('leafServerCables').textContent = r.leafToServerCables;
        document.getElementById('maxLeafServerCables').textContent = r.maxLeafToServerCables;
        document.getElementById('totalCables').textContent = r.allCables;

        // 光模块
        let otHtml = '';
        if (r.speed === "NDR" || r.speed === "SN5600-NDR") {
            otHtml = `
                <div class="info-row"><span>Spine-Leaf 800G 双端口</span><span>${r.spine2LeafOT}</span></div>
                <div class="info-row"><span>Leaf-Server 800G 双端口</span><span>${r.leaf2ServerOT}</span></div>
                <div class="info-row"><span>交换机侧总数</span><span>${r.switchOT}</span></div>
                <div class="info-row"><span>HCA 400G 单端口</span><span>${r.hcaOT}</span></div>`;
        } else if (r.speed === "XDR") {
            otHtml = `
                <div class="info-row"><span>Spine-Leaf 1.6T 双端口</span><span>${r.q3SpineToLeafOT}</span></div>
                <div class="info-row"><span>Leaf-Server 1.6T 双端口</span><span>${r.q3LeafToServerOT}</span></div>
                <div class="info-row"><span>交换机侧总数</span><span>${r.q3OT}</span></div>
                <div class="info-row"><span>HCA 800G 单端口</span><span>${r.hcaOT}</span></div>`;
        } else if (r.speed === "HDR") {
            otHtml = `<div class="info-row"><span>HDR AOC 线缆</span><span>${r.allCables}</span></div>`;
        }
        document.getElementById('otInfo').innerHTML = otHtml;

        // 产品清单
        const gpuType = document.getElementById('gpuType').value || 'H800';
        let summary = [];
        if (r.gpuServerNum > 0) summary.push(`${r.gpuServerNum}台 ${gpuType} GPU`);
        if (r.storageServerNum > 0) summary.push(`${r.storageServerNum}台存储`);
        if (r.cpuServerNum > 0) summary.push(`${r.cpuServerNum}台CPU`);
        if (r.otherServerNum > 0) summary.push(`${r.otherServerNum}台其他`);
        const summaryText = (summary.join('、') || '服务器') + ` ${r.speed}网络配置清单`;
        document.getElementById('productSummary').textContent = summaryText;

        const tbody = document.querySelector('#productTable tbody');
        tbody.innerHTML = '';
        const products = r.speed === "HDR" ? hdrProducts : ndrProducts;

        const items = [
            { model: r.switchType, num: r.spines, note: 'Spine 交换机' },
            { model: r.switchType, num: r.leafs, note: 'Leaf 交换机' },
            { model: r.cableType, num: r.spineToLeafCables, note: 'Spine-Leaf 线缆' },
            { model: r.cableType, num: r.leafToServerCables, note: 'Leaf-Server 线缆' }
        ];

        if (r.speed === "NDR" || r.speed === "SN5600-NDR") {
            items.push({ model: r.ot800, num: r.spine2LeafOT, note: 'Spine-Leaf 800G' });
            items.push({ model: r.ot800, num: r.leaf2ServerOT, note: 'Leaf-Server 800G' });
            items.push({ model: r.ot400, num: r.hcaOT, note: 'HCA 400G' });
        } else if (r.speed === "XDR") {
            items.push({ model: r.ot1600, num: r.q3SpineToLeafOT, note: 'Spine-Leaf 1.6T' });
            items.push({ model: r.ot1600, num: r.q3LeafToServerOT, note: 'Leaf-Server 1.6T' });
            items.push({ model: r.ot800, num: r.hcaOT, note: 'HCA 800G' });
        }

        // 保存产品数据用于导出
        productData = [];

        items.forEach(item => {
            if (item.num > 0) {
                const prod = products.find(p => p.model === item.model);
                if (prod) {
                    const row = tbody.insertRow();
                    row.innerHTML = `<td>${prod.name}</td><td>${prod.model}</td><td>${prod.desc}</td><td>${item.num}</td><td>${item.note}</td>`;
                    productData.push({
                        '产品名称': prod.name,
                        '型号': prod.model,
                        '描述': prod.desc,
                        '数量': item.num,
                        '备注': item.note
                    });
                }
            }
        });

        // 启用下载按钮
        document.getElementById('downloadExcel').disabled = productData.length === 0;
    }

    function downloadExcel() {
        if (productData.length === 0) {
            alert('请先计算拓扑');
            return;
        }

        const r = calcResults;
        const gpuType = document.getElementById('gpuType').value || 'H800';

        // 创建工作簿
        const wb = XLSX.utils.book_new();

        // 配置清单表
        const wsData = [
            ['产品名称', '型号', '描述', '数量', '备注']
        ];

        // 添加产品数据
        productData.forEach(item => {
            wsData.push([item['产品名称'], item['型号'], item['描述'], item['数量'], item['备注']]);
        });

        const ws = XLSX.utils.aoa_to_sheet(wsData);

        // 设置列宽
        ws['!cols'] = [
            { wch: 18 },
            { wch: 25 },
            { wch: 45 },
            { wch: 8 },
            { wch: 18 }
        ];

        XLSX.utils.book_append_sheet(wb, ws, '配置清单');

        // 生成文件名
        let filename = `IB网络配置清单_${r.speed}`;
        if (r.gpuServerNum > 0) filename += `_${r.gpuServerNum}台${gpuType}`;
        filename += `_${new Date().toISOString().slice(0,10)}.xlsx`;

        // 下载文件
        XLSX.writeFile(wb, filename);
    }
    </script>
</body>
</html>
