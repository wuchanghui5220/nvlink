<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPU 计算网络拓扑可视化</title>
    <style>
        /* ============================================
           FUTURISTIC TECH UI - Complete Redesign
           ============================================ */

        /* 本地字体定义 - 支持离线运行 */
        /* Orbitron - 可变字体，支持 400-700 字重 */
        @font-face {
            font-family: 'Orbitron';
            src: url('fonts/orbitron.woff2') format('woff2');
            font-weight: 400 700;
            font-style: normal;
            font-display: swap;
        }
        /* Rajdhani - 各字重独立文件 */
        @font-face {
            font-family: 'Rajdhani';
            src: url('fonts/rajdhani-300.woff2') format('woff2');
            font-weight: 300;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Rajdhani';
            src: url('fonts/rajdhani-400.woff2') format('woff2');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Rajdhani';
            src: url('fonts/rajdhani-500.woff2') format('woff2');
            font-weight: 500;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Rajdhani';
            src: url('fonts/rajdhani-600.woff2') format('woff2');
            font-weight: 600;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Rajdhani';
            src: url('fonts/rajdhani-700.woff2') format('woff2');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: rgba(18, 18, 26, 0.8);
            --accent-cyan: #00f0ff;
            --accent-purple: #bf5af2;
            --accent-green: #30d158;
            --accent-yellow: #ffd60a;
            --accent-red: #ff453a;
            --accent-orange: #ff9f0a;
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-muted: rgba(255, 255, 255, 0.4);
            --border-glow: rgba(0, 240, 255, 0.3);
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Rajdhani', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Grid Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                linear-gradient(90deg, rgba(0, 240, 255, 0.03) 1px, transparent 1px),
                linear-gradient(rgba(0, 240, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(ellipse at 20% 0%, rgba(191, 90, 242, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(0, 240, 255, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(0, 0, 0, 0.5) 0%, transparent 100%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
            position: relative;
            z-index: 1;
        }

        /* Header */
        h1 {
            font-family: 'Orbitron', sans-serif;
            text-align: center;
            font-size: 2.5em;
            font-weight: 700;
            letter-spacing: 4px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 60px rgba(0, 240, 255, 0.5);
            position: relative;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-cyan), transparent);
        }

        .subtitle {
            text-align: center;
            color: var(--text-muted);
            margin-bottom: 40px;
            font-size: 1.1em;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* Glass Panel */
        .input-section {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            border: 1px solid var(--glass-border);
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .input-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 24px;
            flex-wrap: wrap;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .input-group label {
            font-size: 1em;
            color: var(--text-secondary);
            font-weight: 500;
            letter-spacing: 1px;
        }

        .input-group input {
            width: 160px;
            padding: 14px 18px;
            font-size: 1.1em;
            font-family: 'Orbitron', sans-serif;
            font-weight: 500;
            border: 1px solid var(--border-glow);
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.4);
            color: var(--accent-cyan);
            text-align: center;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow:
                0 0 20px rgba(0, 240, 255, 0.3),
                inset 0 0 20px rgba(0, 240, 255, 0.05);
        }

        .input-group select {
            padding: 14px 18px;
            font-size: 1em;
            font-family: 'Rajdhani', sans-serif;
            border: 1px solid var(--border-glow);
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.4);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .input-group select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 20px rgba(0, 240, 255, 0.3);
        }

        .btn {
            padding: 14px 32px;
            font-size: 1em;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            letter-spacing: 2px;
            text-transform: uppercase;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            color: var(--bg-primary);
            box-shadow: 0 4px 20px rgba(0, 240, 255, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(0, 240, 255, 0.5);
        }

        /* Switch Selector */
        .switch-selector {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .switch-option {
            padding: 18px 28px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-width: 200px;
            position: relative;
            overflow: hidden;
        }

        .switch-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, transparent, rgba(0, 240, 255, 0.05));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .switch-option:hover {
            border-color: rgba(0, 240, 255, 0.3);
            transform: translateY(-2px);
        }

        .switch-option:hover::before {
            opacity: 1;
        }

        .switch-option.active {
            background: rgba(0, 240, 255, 0.1);
            border-color: var(--accent-cyan);
            box-shadow:
                0 0 30px rgba(0, 240, 255, 0.2),
                inset 0 0 30px rgba(0, 240, 255, 0.05);
        }

        .switch-option .switch-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2em;
            font-weight: 600;
            color: var(--accent-cyan);
            margin-bottom: 6px;
            letter-spacing: 1px;
        }

        .switch-option .switch-spec {
            font-size: 0.85em;
            color: var(--text-muted);
        }

        .switch-option.active .switch-name {
            color: var(--accent-green);
            text-shadow: 0 0 20px rgba(48, 209, 88, 0.5);
        }

        .switch-option.compare-option {
            background: linear-gradient(135deg, rgba(255, 69, 58, 0.08), rgba(0, 240, 255, 0.08));
            border-color: rgba(255, 159, 10, 0.3);
        }

        .switch-option.compare-option .switch-name {
            background: linear-gradient(135deg, var(--accent-red), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .switch-option.compare-option.active {
            border-color: var(--accent-orange);
            box-shadow: 0 0 30px rgba(255, 159, 10, 0.2);
        }

        /* Quick Select */
        .quick-select {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .quick-btn {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 25px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            font-weight: 500;
        }

        .quick-btn:hover {
            background: rgba(0, 240, 255, 0.1);
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
            transform: scale(1.05);
        }

        /* GPU & Compute Power Section */
        .gpu-power-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 24px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .gpu-select-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .gpu-select-group label {
            font-size: 1em;
            color: var(--text-secondary);
            font-weight: 500;
            letter-spacing: 1px;
        }

        .gpu-select-group select {
            padding: 12px 16px;
            font-size: 1em;
            font-family: 'Rajdhani', sans-serif;
            border: 1px solid var(--border-glow);
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.4);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .gpu-select-group select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 20px rgba(0, 240, 255, 0.3);
        }

        .compute-power-display {
            background: linear-gradient(135deg, rgba(255, 165, 0, 0.15), rgba(255, 140, 0, 0.1));
            border: 1px solid rgba(255, 165, 0, 0.4);
            border-radius: 12px;
            padding: 12px 16px;
        }

        .compute-power-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .compute-power-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #ffa500, #ff6600);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .compute-power-icon svg {
            width: 20px;
            height: 20px;
            color: white;
        }

        .compute-power-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.9em;
            font-weight: 600;
            color: #ffa500;
            letter-spacing: 1px;
        }

        .compute-power-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }

        .power-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            border: 1px solid transparent;
        }

        .power-item.highlight {
            background: rgba(255, 165, 0, 0.15);
            border-color: rgba(255, 165, 0, 0.3);
        }

        .power-label {
            font-size: 0.7em;
            color: rgba(255, 165, 0, 0.7);
            letter-spacing: 0.5px;
        }

        .power-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85em;
            font-weight: 600;
            color: #ffa500;
        }

        .power-value.large {
            font-size: 1em;
            text-shadow: 0 0 8px rgba(255, 165, 0, 0.4);
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-bottom: 40px;
        }

        .summary-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px 16px;
            text-align: center;
            border: 1px solid var(--glass-border);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent-cyan), transparent);
        }

        .summary-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .summary-card .value {
            font-family: 'Orbitron', sans-serif;
            font-size: 2em;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .summary-card .label {
            color: var(--text-muted);
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .summary-card.gpu { border-top: 3px solid var(--accent-red); }
        .summary-card.gpu::before { background: linear-gradient(90deg, transparent, var(--accent-red), transparent); }
        .summary-card.gpu .value { color: var(--accent-red); }

        .summary-card.leaf { border-top: 3px solid #4ecdc4; }
        .summary-card.leaf::before { background: linear-gradient(90deg, transparent, #4ecdc4, transparent); }
        .summary-card.leaf .value { color: #4ecdc4; }

        .summary-card.spine { border-top: 3px solid var(--accent-yellow); }
        .summary-card.spine::before { background: linear-gradient(90deg, transparent, var(--accent-yellow), transparent); }
        .summary-card.spine .value { color: var(--accent-yellow); }

        .summary-card.core { border-top: 3px solid var(--accent-purple); }
        .summary-card.core::before { background: linear-gradient(90deg, transparent, var(--accent-purple), transparent); }
        .summary-card.core .value { color: var(--accent-purple); }

        .summary-card.pod { border-top: 3px solid var(--accent-cyan); }
        .summary-card.pod::before { background: linear-gradient(90deg, transparent, var(--accent-cyan), transparent); }
        .summary-card.pod .value { color: var(--accent-cyan); }

        /* Section Title */
        .section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.3em;
            font-weight: 600;
            color: var(--accent-cyan);
            margin: 40px 0 24px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(0, 240, 255, 0.2);
            letter-spacing: 2px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--accent-cyan);
            border-radius: 2px;
            box-shadow: 0 0 10px var(--accent-cyan);
        }

        /* Badges */
        .topology-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 24px;
            border-radius: 30px;
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 24px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .topology-badge.two-tier {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.2), rgba(78, 205, 196, 0.1));
            border: 1px solid rgba(78, 205, 196, 0.4);
            color: #4ecdc4;
        }

        .topology-badge.three-tier {
            background: linear-gradient(135deg, rgba(191, 90, 242, 0.2), rgba(191, 90, 242, 0.1));
            border: 1px solid rgba(191, 90, 242, 0.4);
            color: var(--accent-purple);
        }

        .switch-badge {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-left: 12px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
        }

        /* Topology Diagram */
        .topology-diagram {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--glass-border);
        }

        .topology-diagram::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 80%, rgba(191, 90, 242, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 240, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        /* Diagram View Tabs */
        .diagram-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            position: relative;
            z-index: 2;
        }

        .diagram-tab {
            padding: 10px 20px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85em;
            font-weight: 500;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .diagram-tab:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .diagram-tab.active {
            background: linear-gradient(135deg, rgba(0, 240, 255, 0.2), rgba(191, 90, 242, 0.2));
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
            box-shadow: 0 0 20px rgba(0, 240, 255, 0.3);
        }

        .diagram-view {
            display: none;
        }

        .diagram-view.active {
            display: block;
        }

        /* D3 Topology Container */
        .d3-topology-container {
            width: 100%;
            height: 580px;
            position: relative;
            z-index: 1;
            background: linear-gradient(180deg, rgba(10, 10, 15, 0.9) 0%, rgba(18, 18, 26, 0.9) 100%);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .d3-topology-container svg {
            width: 100%;
            height: 100%;
        }

        .d3-topology-container .connection-line {
            pointer-events: none;
        }

        .layer-container {
            position: relative;
            z-index: 1;
        }

        .layer {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 24px 0;
            position: relative;
        }

        .layer-label {
            position: absolute;
            left: 0;
            width: 100px;
            text-align: right;
            padding-right: 20px;
            font-family: 'Orbitron', sans-serif;
            font-weight: 600;
            font-size: 0.85em;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .layer-label.core { color: var(--accent-purple); text-shadow: 0 0 10px rgba(191, 90, 242, 0.5); }
        .layer-label.spine { color: var(--accent-yellow); text-shadow: 0 0 10px rgba(255, 214, 10, 0.5); }
        .layer-label.leaf { color: #4ecdc4; text-shadow: 0 0 10px rgba(78, 205, 196, 0.5); }
        .layer-label.gpu { color: var(--accent-red); text-shadow: 0 0 10px rgba(255, 69, 58, 0.5); }

        .layer-content {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            margin-left: 110px;
        }

        /* Device Nodes - Futuristic Style */
        .device-node {
            padding: 12px 18px;
            border-radius: 10px;
            text-align: center;
            font-size: 0.85em;
            font-weight: 500;
            min-width: 90px;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: 1px solid transparent;
        }

        .device-node:hover {
            transform: translateY(-5px) scale(1.05);
            z-index: 10;
        }

        .device-node::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 10px;
            padding: 1px;
            background: linear-gradient(135deg, rgba(255,255,255,0.2), transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }

        .device-node.core {
            background: linear-gradient(135deg, rgba(191, 90, 242, 0.3), rgba(124, 58, 237, 0.4));
            border-color: rgba(191, 90, 242, 0.5);
            color: #fff;
            box-shadow: 0 4px 20px rgba(191, 90, 242, 0.3), inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .device-node.core:hover {
            box-shadow: 0 8px 30px rgba(191, 90, 242, 0.5), 0 0 40px rgba(191, 90, 242, 0.2);
        }

        .device-node.spine {
            background: linear-gradient(135deg, rgba(255, 214, 10, 0.3), rgba(255, 159, 10, 0.4));
            border-color: rgba(255, 214, 10, 0.5);
            color: #fff;
            box-shadow: 0 4px 20px rgba(255, 214, 10, 0.3), inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .device-node.spine:hover {
            box-shadow: 0 8px 30px rgba(255, 214, 10, 0.5), 0 0 40px rgba(255, 214, 10, 0.2);
        }

        .device-node.leaf {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.3), rgba(61, 189, 181, 0.4));
            border-color: rgba(78, 205, 196, 0.5);
            color: #fff;
            box-shadow: 0 4px 20px rgba(78, 205, 196, 0.3), inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .device-node.leaf:hover {
            box-shadow: 0 8px 30px rgba(78, 205, 196, 0.5), 0 0 40px rgba(78, 205, 196, 0.2);
        }

        .device-node.gpu {
            background: linear-gradient(135deg, rgba(255, 69, 58, 0.3), rgba(238, 90, 90, 0.4));
            border-color: rgba(255, 69, 58, 0.5);
            color: #fff;
            box-shadow: 0 4px 20px rgba(255, 69, 58, 0.3), inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .device-node.gpu:hover {
            box-shadow: 0 8px 30px rgba(255, 69, 58, 0.5), 0 0 40px rgba(255, 69, 58, 0.2);
        }

        .device-node .count {
            font-size: 0.7em;
            opacity: 0.7;
            margin-top: 4px;
        }

        /* SuperPod Box - Futuristic Style */
        .pod-box {
            background: rgba(0, 240, 255, 0.05);
            border: 1px solid rgba(0, 240, 255, 0.3);
            border-radius: 20px;
            padding: 24px;
            margin: 12px;
            min-width: 220px;
            position: relative;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .pod-box::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 20px;
            padding: 1px;
            background: linear-gradient(135deg, rgba(0, 240, 255, 0.3), transparent, rgba(191, 90, 242, 0.2));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }

        .pod-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 240, 255, 0.15);
            border-color: rgba(0, 240, 255, 0.5);
        }

        .pod-box .pod-title {
            position: absolute;
            top: -14px;
            left: 24px;
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-primary));
            padding: 4px 16px;
            color: var(--accent-cyan);
            font-family: 'Orbitron', sans-serif;
            font-weight: 600;
            font-size: 0.9em;
            letter-spacing: 1px;
            border-radius: 20px;
            border: 1px solid rgba(0, 240, 255, 0.3);
        }

        .pod-box .pod-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: 8px;
        }

        .pod-box .pod-layer {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .pod-box .mini-node {
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.75em;
            min-width: 55px;
            text-align: center;
            font-weight: 500;
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }

        .pod-box .mini-node:hover {
            transform: scale(1.1);
        }

        .pod-box .mini-node.spine {
            background: rgba(255, 214, 10, 0.2);
            border-color: rgba(255, 214, 10, 0.4);
            color: var(--accent-yellow);
        }

        .pod-box .mini-node.leaf {
            background: rgba(78, 205, 196, 0.2);
            border-color: rgba(78, 205, 196, 0.4);
            color: #4ecdc4;
        }

        .pod-box .mini-node.gpu {
            background: rgba(255, 69, 58, 0.2);
            border-color: rgba(255, 69, 58, 0.4);
            color: var(--accent-red);
        }

        .pod-box .connection-visual {
            margin: 4px 0;
            opacity: 0.9;
        }

        .pod-box .connection-visual svg {
            display: block;
            margin: 0 auto;
        }

        /* Pods Container */
        .pods-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 24px;
            margin: 24px 0;
        }

        /* Connection Arrows - Animated */
        .connection-arrows {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            position: relative;
        }

        .arrow-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 24px;
        }

        .arrow-line {
            width: 2px;
            height: 35px;
            background: linear-gradient(to bottom, var(--accent-cyan), rgba(0, 240, 255, 0.1));
            position: relative;
        }

        .arrow-line::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, var(--accent-cyan), transparent);
            animation: flowDown 1.5s ease-in-out infinite;
            opacity: 0.5;
        }

        @keyframes flowDown {
            0% { transform: translateY(-100%); opacity: 0; }
            50% { opacity: 0.8; }
            100% { transform: translateY(100%); opacity: 0; }
        }

        .arrow-head {
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 10px solid var(--accent-cyan);
            filter: drop-shadow(0 0 5px var(--accent-cyan));
        }

        .arrow-label {
            font-size: 0.75em;
            color: var(--text-muted);
            margin-top: 8px;
            font-weight: 500;
        }

        /* Stats Box in Diagram */
        .diagram-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--glass-border);
            flex-wrap: wrap;
        }

        .diagram-stat {
            text-align: center;
            padding: 12px 20px;
            background: var(--glass-bg);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
        }

        .diagram-stat .num {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.6em;
            font-weight: 700;
            color: var(--accent-cyan);
            text-shadow: 0 0 20px rgba(0, 240, 255, 0.5);
        }

        .diagram-stat .txt {
            font-size: 0.8em;
            color: var(--text-muted);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .ellipsis-node {
            padding: 12px 18px;
            color: var(--text-muted);
            font-size: 1.4em;
        }

        /* Core Matrix Section - Futuristic */
        .core-section {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--glass-border);
            position: relative;
            overflow: hidden;
        }

        .core-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent-purple), transparent);
        }

        .core-formula {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            font-family: 'Monaco', 'Consolas', monospace;
            border: 1px solid rgba(48, 209, 88, 0.2);
        }

        .core-formula code {
            color: var(--accent-green);
            font-size: 1.1em;
            text-shadow: 0 0 10px rgba(48, 209, 88, 0.3);
        }

        .core-matrix-container {
            overflow-x: auto;
            padding: 20px 0;
        }

        .core-matrix {
            display: inline-block;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--glass-border);
        }

        .core-matrix-header {
            display: flex;
            margin-bottom: 12px;
            padding-left: 70px;
        }

        .core-matrix-header span {
            width: 100px;
            text-align: center;
            color: var(--accent-cyan);
            font-family: 'Orbitron', sans-serif;
            font-weight: 600;
            font-size: 0.8em;
            letter-spacing: 1px;
        }

        .core-matrix-row {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }

        .core-matrix-row-label {
            width: 70px;
            color: var(--accent-yellow);
            font-family: 'Orbitron', sans-serif;
            font-weight: 600;
            font-size: 0.8em;
            text-align: right;
            padding-right: 12px;
        }

        .core-cell {
            width: 100px;
            height: 38px;
            background: linear-gradient(135deg, rgba(191, 90, 242, 0.4), rgba(124, 58, 237, 0.5));
            border: 1px solid rgba(191, 90, 242, 0.5);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 3px;
            font-size: 0.75em;
            color: #fff;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .core-cell:hover {
            transform: scale(1.15);
            box-shadow: 0 0 25px rgba(191, 90, 242, 0.6), 0 0 50px rgba(191, 90, 242, 0.3);
            z-index: 10;
            border-color: var(--accent-purple);
        }

        .core-ellipsis {
            width: 80px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 1.4em;
        }

        /* Connection Example - Futuristic */
        .connection-example {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 16px;
            padding: 24px;
            margin-top: 24px;
            border: 1px solid var(--glass-border);
        }

        .connection-example h4 {
            color: var(--accent-cyan);
            margin-bottom: 16px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1em;
            letter-spacing: 1px;
        }

        .connection-line {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            margin: 6px 0;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9em;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }

        .connection-line:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(0, 240, 255, 0.2);
        }

        .port-range {
            color: #4ecdc4;
            min-width: 130px;
            font-weight: 500;
        }

        .connection-arrow {
            color: var(--text-muted);
            padding: 0 16px;
        }

        .device-name {
            color: var(--accent-yellow);
        }

        .core-name {
            color: var(--accent-purple);
        }

        /* Pod Structure - Futuristic */
        .pod-structure {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }

        .pod-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(0, 240, 255, 0.2);
            transition: all 0.3s ease;
        }

        .pod-card:hover {
            border-color: rgba(0, 240, 255, 0.4);
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }

        .pod-card h4 {
            color: var(--accent-cyan);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1em;
            letter-spacing: 1px;
        }

        .pod-card h4 .pod-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-cyan), #0099cc);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            color: var(--bg-primary);
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 240, 255, 0.3);
        }

        .pod-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .pod-item:last-child {
            border-bottom: none;
        }

        .pod-item .icon {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 14px;
            box-shadow: 0 0 10px currentColor;
        }

        .pod-item .icon.leaf { background: #4ecdc4; color: #4ecdc4; }
        .pod-item .icon.spine { background: var(--accent-yellow); color: var(--accent-yellow); }
        .pod-item .icon.lg { background: var(--accent-cyan); color: var(--accent-cyan); }
        .pod-item .icon.su { background: var(--accent-red); color: var(--accent-red); }

        /* SU Distribution */
        .su-distribution {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            padding: 24px;
            margin-top: 24px;
            border: 1px solid var(--glass-border);
        }

        .su-distribution > p {
            color: var(--text-muted);
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--glass-border);
        }

        .su-row {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            gap: 16px;
        }

        .su-row .pod-label {
            min-width: 120px;
            flex-shrink: 0;
            color: var(--accent-cyan);
            font-weight: 600;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9em;
        }

        .su-row .su-range {
            color: var(--accent-red);
            flex: 1;
        }

        /* Two-tier specific */
        .two-tier-info {
            background: rgba(78, 205, 196, 0.08);
            border: 1px solid rgba(78, 205, 196, 0.3);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .two-tier-info p {
            color: #4ecdc4;
            margin-bottom: 10px;
        }

        /* Legend - Futuristic */
        .legend {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85em;
            color: var(--text-secondary);
            padding: 8px 16px;
            background: var(--glass-bg);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
        }

        .legend-color {
            width: 18px;
            height: 18px;
            border-radius: 6px;
            box-shadow: 0 0 10px currentColor;
        }

        .legend-color.core {
            background: linear-gradient(135deg, var(--accent-purple), #7c3aed);
            color: var(--accent-purple);
        }
        .legend-color.spine {
            background: linear-gradient(135deg, var(--accent-yellow), #ff9f0a);
            color: var(--accent-yellow);
        }
        .legend-color.leaf {
            background: linear-gradient(135deg, #4ecdc4, #3dbdb5);
            color: #4ecdc4;
        }
        .legend-color.gpu {
            background: linear-gradient(135deg, var(--accent-red), #ee5a5a);
            color: var(--accent-red);
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 { font-size: 1.6em; letter-spacing: 2px; }
            .summary-grid { grid-template-columns: repeat(2, 1fr); }
            .input-row { flex-direction: column; }
            .core-cell { width: 80px; font-size: 0.6em; }
            .core-matrix-header span { width: 80px; }
            .core-matrix-row-label { width: 50px; font-size: 0.7em; }
            .pod-box { min-width: 160px; }
            .layer-label { display: none; }
            .layer-content { margin-left: 0; }
            .switch-selector { flex-direction: column; align-items: center; }
            .switch-option { min-width: 280px; }
            .container { padding: 16px; }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes glowPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 240, 255, 0.3); }
            50% { box-shadow: 0 0 40px rgba(0, 240, 255, 0.5); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* Comparison Styles - Futuristic */
        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1000px) {
            .comparison-container {
                grid-template-columns: 1fr;
            }
        }

        .comparison-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 28px;
            border: 2px solid var(--glass-border);
            transition: all 0.3s ease;
        }

        .comparison-card:hover {
            transform: translateY(-5px);
        }

        .comparison-card.qm9790 {
            border-color: rgba(255, 69, 58, 0.4);
        }

        .comparison-card.qm9790:hover {
            box-shadow: 0 20px 40px rgba(255, 69, 58, 0.15);
        }

        .comparison-card.q3400 {
            border-color: rgba(0, 240, 255, 0.4);
        }

        .comparison-card.q3400:hover {
            box-shadow: 0 20px 40px rgba(0, 240, 255, 0.15);
        }

        .comparison-card .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--glass-border);
        }

        .comparison-card .card-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.4em;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .comparison-card.qm9790 .card-title {
            color: var(--accent-red);
            text-shadow: 0 0 20px rgba(255, 69, 58, 0.5);
        }

        .comparison-card.q3400 .card-title {
            color: var(--accent-cyan);
            text-shadow: 0 0 20px rgba(0, 240, 255, 0.5);
        }

        .comparison-card .card-subtitle {
            font-size: 0.85em;
            color: var(--text-muted);
        }

        .comparison-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .comparison-stat-row:last-child {
            border-bottom: none;
        }

        .comparison-stat-label {
            color: var(--text-secondary);
        }

        .comparison-stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2em;
            font-weight: 600;
            color: var(--text-primary);
        }

        .comparison-stat-value.highlight {
            color: var(--accent-green);
            text-shadow: 0 0 15px rgba(48, 209, 88, 0.5);
        }

        /* Savings Section - Futuristic */
        .savings-section {
            background: linear-gradient(135deg, rgba(48, 209, 88, 0.1), rgba(0, 240, 255, 0.1));
            border: 2px solid rgba(48, 209, 88, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .savings-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-green), transparent);
        }

        .savings-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5em;
            color: var(--accent-green);
            margin-bottom: 24px;
            text-align: center;
            letter-spacing: 2px;
            text-shadow: 0 0 30px rgba(48, 209, 88, 0.5);
        }

        .savings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px;
        }

        .savings-item {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            transition: all 0.3s ease;
        }

        .savings-item:hover {
            transform: translateY(-5px);
            border-color: rgba(48, 209, 88, 0.3);
        }

        .savings-item .value {
            font-family: 'Orbitron', sans-serif;
            font-size: 2em;
            font-weight: 700;
            color: var(--accent-green);
            text-shadow: 0 0 20px rgba(48, 209, 88, 0.5);
        }

        .savings-item .value.negative {
            color: var(--accent-red);
            text-shadow: 0 0 20px rgba(255, 69, 58, 0.5);
        }

        .savings-item .label {
            color: var(--text-muted);
            font-size: 0.85em;
            margin-top: 8px;
        }

        .savings-item .detail {
            color: var(--text-muted);
            font-size: 0.75em;
            margin-top: 4px;
            opacity: 0.7;
        }

        /* Comparison Table - Futuristic */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 24px;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 14px 18px;
            text-align: center;
            border-bottom: 1px solid var(--glass-border);
        }

        .comparison-table th {
            background: rgba(0, 0, 0, 0.4);
            color: var(--accent-cyan);
            font-family: 'Orbitron', sans-serif;
            font-weight: 600;
            font-size: 0.9em;
            letter-spacing: 1px;
        }

        .comparison-table th:first-child {
            text-align: left;
        }

        .comparison-table td:first-child {
            text-align: left;
            color: var(--text-secondary);
        }

        .comparison-table tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .comparison-table .qm9790-col {
            color: var(--accent-red);
        }

        .comparison-table .q3400-col {
            color: var(--accent-cyan);
        }

        .comparison-table .savings-col {
            color: var(--accent-green);
            font-weight: bold;
        }

        .winner-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7em;
            margin-left: 6px;
            background: rgba(48, 209, 88, 0.2);
            color: var(--accent-green);
            border: 1px solid rgba(48, 209, 88, 0.3);
        }

        /* Price Input Styles - Futuristic */
        .price-input-section {
            background: rgba(255, 159, 10, 0.08);
            border: 1px solid rgba(255, 159, 10, 0.3);
            border-radius: 16px;
            padding: 24px;
            margin-top: 24px;
        }

        .price-input-title {
            color: var(--accent-orange);
            font-family: 'Orbitron', sans-serif;
            font-size: 1em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: 1px;
        }

        .price-input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }

        .price-input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .price-input-group label {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .price-input-group input {
            padding: 12px 14px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.4);
            color: var(--text-primary);
            font-family: 'Orbitron', sans-serif;
            font-size: 1em;
            width: 100%;
            transition: all 0.3s ease;
        }

        .price-input-group input:focus {
            outline: none;
            border-color: var(--accent-orange);
            box-shadow: 0 0 20px rgba(255, 159, 10, 0.3);
        }

        .price-input-group .unit {
            font-size: 0.75em;
            color: var(--text-muted);
        }

        /* Cost Summary Styles - Futuristic */
        .cost-summary {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 24px;
            margin: 30px 0;
        }

        @media (max-width: 1000px) {
            .cost-summary {
                grid-template-columns: 1fr;
            }
        }

        .cost-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            text-align: center;
            border: 2px solid var(--glass-border);
            transition: all 0.3s ease;
        }

        .cost-card:hover {
            transform: translateY(-5px);
        }

        .cost-card.qm9790 {
            border-color: rgba(255, 69, 58, 0.4);
        }

        .cost-card.q3400 {
            border-color: rgba(0, 240, 255, 0.4);
        }

        .cost-card-header {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 18px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--glass-border);
            letter-spacing: 1px;
        }

        .cost-card.qm9790 .cost-card-header {
            color: var(--accent-red);
        }

        .cost-card.q3400 .cost-card-header {
            color: var(--accent-cyan);
        }

        .cost-card.savings {
            border-color: rgba(48, 209, 88, 0.4);
            background: linear-gradient(135deg, rgba(48, 209, 88, 0.1), rgba(0, 240, 255, 0.1));
        }

        .cost-card.savings .cost-card-header {
            color: var(--accent-green);
        }

        .cost-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .cost-item:last-child {
            border-bottom: none;
        }

        .cost-item.total {
            margin-top: 12px;
            padding-top: 16px;
            border-top: 2px solid rgba(255, 255, 255, 0.15);
            border-bottom: none;
        }

        .cost-label {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .cost-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .cost-item.total .cost-label,
        .cost-item.total .cost-value {
            font-size: 1.1em;
        }

        .cost-card.qm9790 .cost-item.total .cost-value {
            color: var(--accent-red);
        }

        .cost-card.q3400 .cost-item.total .cost-value {
            color: var(--accent-cyan);
        }

        .cost-savings-display {
            text-align: center;
            padding: 24px 0;
        }

        .savings-amount {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.4em;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .savings-amount.positive {
            color: var(--accent-green);
            text-shadow: 0 0 30px rgba(48, 209, 88, 0.5);
        }

        .savings-amount.negative {
            color: var(--accent-red);
            text-shadow: 0 0 30px rgba(255, 69, 58, 0.5);
        }

        .savings-percentage {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5em;
            margin-bottom: 16px;
        }

        .savings-percentage.positive {
            color: var(--accent-green);
        }

        .savings-percentage.negative {
            color: var(--accent-red);
        }

        .savings-note {
            color: var(--text-muted);
            font-size: 0.9em;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 240, 255, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 240, 255, 0.5);
        }
    </style>
    <!-- D3.js 本地化 - 支持离线运行 -->
    <script src="d3.v7.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>GPU 计算网络拓扑可视化</h1>
        <p class="subtitle" id="subtitleText">QUANTUM NETWORK TOPOLOGY // Q3400 SWITCH (144 x 800G)</p>

        <!-- Input Section -->
        <div class="input-section">
            <!-- Switch Type Selector -->
            <div class="switch-selector">
                <div class="switch-option active" onclick="selectSwitch('Q3400')" id="switchQ3400">
                    <div class="switch-name">Q3400</div>
                    <div class="switch-spec">144 x 800G | 最大 93,312 台</div>
                </div>
                <div class="switch-option" onclick="selectSwitch('Q3400_400G')" id="switchQ3400_400G">
                    <div class="switch-name">Q3400 降速</div>
                    <div class="switch-spec">96x400G + 48x800G | 最大 124,416 台</div>
                </div>
                <div class="switch-option" onclick="selectSwitch('QM9790')" id="switchQM9790">
                    <div class="switch-name">QM9790</div>
                    <div class="switch-spec">64 x 400G | 最大 8,192 台</div>
                </div>
                <div class="switch-option compare-option" onclick="selectSwitch('COMPARE')" id="switchCOMPARE">
                    <div class="switch-name">400G 对比</div>
                    <div class="switch-spec">QM9790 vs Q3400降速</div>
                </div>
            </div>

            <div class="input-row">
                <div class="input-group">
                    <label for="serverCount">服务器数量:</label>
                    <input type="number" id="serverCount" value="2592" min="1" max="93312" oninput="updateComputePower()">
                </div>
                <button class="btn btn-primary" onclick="updateTopology()">生成拓扑</button>
            </div>
            <div class="quick-select" id="quickSelect">
                <!-- Dynamically generated -->
            </div>

            <div class="gpu-power-section">
                <div class="gpu-select-group">
                    <label for="gpuModel">GPU 型号:</label>
                    <select id="gpuModel" onchange="updateComputePower()">
                        <option value="B200">NVIDIA B200 (4.5P FP16)</option>
                        <option value="B300">NVIDIA B300 (4.5P FP16)</option>
                        <option value="H200">NVIDIA H200 (1.0P FP16)</option>
                        <option value="H100">NVIDIA H100 (1.0P FP16)</option>
                    </select>
                </div>
                <div class="compute-power-display">
                    <div class="compute-power-header">
                        <div class="compute-power-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                            </svg>
                        </div>
                        <div class="compute-power-title">集群总算力</div>
                    </div>
                    <div class="compute-power-grid" id="computePowerGrid">
                        <!-- 动态生成 -->
                    </div>
                </div>
            </div>

            <!-- Price Input Section (only visible in compare mode) -->
            <div class="price-input-section" id="priceInputSection" style="display: none;">
                <div class="price-input-title">
                    <span>💰</span>
                    <span>价格参数设置 (可选，用于成本对比)</span>
                </div>
                <div class="price-input-grid">
                    <div class="price-input-group">
                        <label>QM9790 交换机单价</label>
                        <input type="number" id="priceQM9790Switch" placeholder="180000" value="180000">
                        <span class="unit">元/台 (32 cage)</span>
                    </div>
                    <div class="price-input-group">
                        <label>Q3400 交换机单价</label>
                        <input type="number" id="priceQ3400Switch" placeholder="730000" value="730000">
                        <span class="unit">元/台 (72 cage)</span>
                    </div>
                    <div class="price-input-group">
                        <label>MMA4Z00-NS 模块单价</label>
                        <input type="number" id="priceMMA4Z00" placeholder="9400" value="9400">
                        <span class="unit">元/个 (800G/双400G)</span>
                    </div>
                    <div class="price-input-group">
                        <label>MMS4A00-XM 模块单价</label>
                        <input type="number" id="priceMMS4A00" placeholder="15000" value="15000">
                        <span class="unit">元/个 (1600G/双800G)</span>
                    </div>
                    <div class="price-input-group">
                        <label>MMA4Z00-NS400 模块单价</label>
                        <input type="number" id="price400GSingle" placeholder="6800" value="6800">
                        <span class="unit">元/个 (网卡侧400G)</span>
                    </div>
                    <div class="price-input-group">
                        <label>MPO 线缆单价</label>
                        <input type="number" id="priceMPOCable" placeholder="1000" value="1000">
                        <span class="unit">元/条 (通用)</span>
                    </div>
                </div>
                <div style="margin-top: 15px; text-align: center;">
                    <button class="btn btn-primary" onclick="updateTopology()" style="background: linear-gradient(135deg, #ffa500, #ff8c00);">
                        重新计算对比
                    </button>
                    <span style="color: #888; font-size: 0.85em; margin-left: 15px;">填写价格后点击重新计算</span>
                </div>
            </div>
        </div>

        <!-- Results Container -->
        <div id="results"></div>
    </div>

    <script>
        // Current switch type
        let currentSwitch = 'Q3400';

        // GPU 算力配置 (单卡 PFLOPS)
        const GPU_SPECS = {
            'B300': {
                name: 'NVIDIA B300',
                fp4Sparse: 144,   // FP4 稀疏
                fp4Dense: 108,    // FP4 稠密
                fp8: 72,          // FP8/FP6
                fp16: 4.5         // FP16 稠密
            },
            'B200': {
                name: 'NVIDIA B200',
                fp4Sparse: 144,   // FP4 稀疏
                fp4Dense: 72,     // FP4 稠密
                fp8: 72,          // FP8/FP6
                fp16: 4.5         // FP16 稠密
            },
            'H200': {
                name: 'NVIDIA H200',
                fp8: 3.96,        // FP8
                fp16: 1.0         // FP16 稠密
            },
            'H100': {
                name: 'NVIDIA H100',
                fp8: 3.96,        // FP8
                fp16: 1.0         // FP16 稠密
            }
        };
        const GPUS_PER_SERVER = 8;

        // Switch configurations
        const SWITCH_CONFIG = {
            'Q3400': {
                name: 'Q3400',
                portsPerSwitch: 144,
                halfK: 72,
                serversPerSU: 72,
                leavesPerLG: 8,
                maxTwoTier: 1296,
                maxThreeTier: 93312,
                portSpeed: '800G',
                isAsymmetric: false,
                spineFactors: [1, 2, 3, 4, 6, 8, 9, 12, 18, 24, 36, 72],
                // SuperPOD 参数
                serversPerSuperPod: 648,
                leafsPerSuperPod: 72,
                spinesPerSuperPod: 72,
                susPerSuperPod: 9,
                numCGs: 72,
                quickSelect: [
                    { count: 72, label: '72 (1 SU)' },
                    { count: 576, label: '576 (8 SU)' },
                    { count: 1296, label: '1,296 (两层最大)' },
                    { count: 2592, label: '2,592 (4 SuperPOD)' },
                    { count: 5184, label: '5,184 (8 SuperPOD)' },
                    { count: 11664, label: '11,664 (18 SuperPOD)' },
                    { count: 46656, label: '46,656 (72 SuperPOD)' },
                    { count: 93312, label: '93,312 (最大)' }
                ]
            },
            'Q3400_400G': {
                name: 'Q3400 降速',
                portsPerSwitch: 144,
                uplinkPorts: 48,
                downlinkPorts: 96,
                serversPerSU: 96,
                leavesPerLG: 8,
                maxTwoTier: 1728,
                maxThreeTier: 124416,
                portSpeed: '96×400G↓ + 48×800G↑',
                isAsymmetric: true,
                // SuperPOD 参数 (非对称)
                serversPerSuperPod: 864,
                leafsPerSuperPod: 72,
                spinesPerSuperPod: 48,
                susPerSuperPod: 9,
                numCGs: 48,
                spineFactors: [1, 2, 3, 4, 6, 8, 12, 16, 24, 48],
                quickSelect: [
                    { count: 96, label: '96 (1 SU)' },
                    { count: 768, label: '768 (8 SU)' },
                    { count: 1728, label: '1,728 (两层最大)' },
                    { count: 3456, label: '3,456 (4 SuperPOD)' },
                    { count: 8640, label: '8,640 (10 SuperPOD)' },
                    { count: 17280, label: '17,280 (20 SuperPOD)' },
                    { count: 62208, label: '62,208 (72 SuperPOD)' },
                    { count: 124416, label: '124,416 (最大)' }
                ]
            },
            'QM9790': {
                name: 'QM9790',
                portsPerSwitch: 64,
                halfK: 32,
                serversPerSU: 32,
                leavesPerLG: 8,
                maxTwoTier: 256,
                maxThreeTier: 8192,
                portSpeed: '400G',
                isAsymmetric: false,
                spineFactors: [1, 2, 4, 8, 16, 32],
                // SuperPOD 参数
                serversPerSuperPod: 128,
                leafsPerSuperPod: 32,
                spinesPerSuperPod: 32,
                susPerSuperPod: 4,
                numCGs: 32,
                quickSelect: [
                    { count: 32, label: '32 (1 SU)' },
                    { count: 128, label: '128 (4 SU)' },
                    { count: 256, label: '256 (两层最大)' },
                    { count: 512, label: '512 (4 SuperPOD)' },
                    { count: 1024, label: '1,024 (8 SuperPOD)' },
                    { count: 2048, label: '2,048 (16 SuperPOD)' },
                    { count: 4096, label: '4,096 (32 SuperPOD)' },
                    { count: 8192, label: '8,192 (最大)' }
                ]
            },
            'COMPARE': {
                name: '400G 方案对比',
                maxThreeTier: 8192,  // Limited by QM9790
                quickSelect: [
                    { count: 256, label: '256 (QM9790两层最大)' },
                    { count: 512, label: '512 (4 SuperPOD)' },
                    { count: 1024, label: '1,024 (8 SuperPOD)' },
                    { count: 2048, label: '2,048 (16 SuperPOD)' },
                    { count: 4096, label: '4,096 (32 SuperPOD)' },
                    { count: 8192, label: '8,192 (QM9790最大)' }
                ]
            }
        };

        function selectSwitch(switchType) {
            currentSwitch = switchType;
            const config = SWITCH_CONFIG[switchType];

            // Update UI
            document.querySelectorAll('.switch-option').forEach(el => el.classList.remove('active'));
            document.getElementById('switch' + switchType).classList.add('active');

            // Update subtitle based on mode
            if (switchType === 'COMPARE') {
                document.getElementById('subtitleText').textContent =
                    'COMPARISON MODE // QM9790 (64×400G) VS Q3400 (96×400G + 48×800G)';
                // Show price input section
                document.getElementById('priceInputSection').style.display = 'block';
            } else {
                document.getElementById('subtitleText').textContent =
                    `QUANTUM NETWORK TOPOLOGY // ${config.name} SWITCH (${config.portsPerSwitch} x ${config.portSpeed})`;
                // Hide price input section
                document.getElementById('priceInputSection').style.display = 'none';
            }

            // Update max value
            document.getElementById('serverCount').max = config.maxThreeTier;

            // Update quick select buttons
            updateQuickSelect();

            // Set default value based on switch type
            const currentValue = parseInt(document.getElementById('serverCount').value);
            if (currentValue > config.maxThreeTier) {
                document.getElementById('serverCount').value = config.quickSelect[3] ? config.quickSelect[3].count : config.quickSelect[0].count;
            }

            // Regenerate topology
            updateTopology();
        }

        function updateQuickSelect() {
            const config = SWITCH_CONFIG[currentSwitch];
            const container = document.getElementById('quickSelect');
            container.innerHTML = config.quickSelect.map(item =>
                `<button class="quick-btn" onclick="setServers(${item.count})">${item.label}</button>`
            ).join('');
        }

        function setServers(count) {
            document.getElementById('serverCount').value = count;
            updateTopology();
        }

        function formatPower(pflops) {
            if (pflops >= 1000) {
                return (pflops / 1000).toFixed(1) + ' EF';
            } else if (pflops >= 1) {
                return pflops.toLocaleString() + ' PF';
            } else {
                return (pflops * 1000).toFixed(0) + ' TF';
            }
        }

        function updateComputePower() {
            const numServers = parseInt(document.getElementById('serverCount').value) || 0;
            const gpuModel = document.getElementById('gpuModel').value;
            const spec = GPU_SPECS[gpuModel];
            if (!spec) return;

            const totalGpus = numServers * GPUS_PER_SERVER;
            const grid = document.getElementById('computePowerGrid');

            let html = '';

            // Blackwell 系列显示 FP4/FP8
            if (spec.fp4Sparse !== undefined) {
                html += `
                    <div class="power-item highlight">
                        <span class="power-label">FP4 稀疏</span>
                        <span class="power-value large">${formatPower(totalGpus * spec.fp4Sparse)}</span>
                    </div>
                    <div class="power-item">
                        <span class="power-label">FP4 稠密</span>
                        <span class="power-value">${formatPower(totalGpus * spec.fp4Dense)}</span>
                    </div>
                `;
            }

            if (spec.fp8 !== undefined) {
                html += `
                    <div class="power-item ${spec.fp4Sparse === undefined ? 'highlight' : ''}">
                        <span class="power-label">FP8</span>
                        <span class="power-value ${spec.fp4Sparse === undefined ? 'large' : ''}">${formatPower(totalGpus * spec.fp8)}</span>
                    </div>
                `;
            }

            html += `
                <div class="power-item">
                    <span class="power-label">FP16</span>
                    <span class="power-value">${formatPower(totalGpus * spec.fp16)}</span>
                </div>
            `;

            grid.innerHTML = html;
        }

        function updateTopology() {
            updateComputePower();

            const config = SWITCH_CONFIG[currentSwitch];
            const numServers = parseInt(document.getElementById('serverCount').value);

            if (numServers <= 0 || numServers > config.maxThreeTier) {
                alert(`请输入 1 - ${config.maxThreeTier.toLocaleString()} 之间的数字`);
                return;
            }

            const results = document.getElementById('results');

            // Handle comparison mode
            if (currentSwitch === 'COMPARE') {
                results.innerHTML = generateComparisonHTML(numServers);
                return;
            }

            if (numServers <= config.maxTwoTier) {
                if (config.isAsymmetric) {
                    results.innerHTML = generateAsymmetricTwoTierHTML(numServers, config);
                } else {
                    results.innerHTML = generateTwoTierHTML(numServers, config);
                }
            } else {
                if (config.isAsymmetric) {
                    results.innerHTML = generateAsymmetricThreeTierHTML(numServers, config);
                } else {
                    results.innerHTML = generateThreeTierHTML(numServers, config);
                }
            }
        }

        function generateTwoTierHTML(numServers, config) {
            const numSUs = Math.ceil(numServers / config.serversPerSU);
            const numLeafs = numSUs * config.leavesPerLG;

            const minSpinesNeeded = Math.ceil(numLeafs / 2);
            const numSpines = config.spineFactors.find(f => f >= minSpinesNeeded) || config.halfK;
            const connectionsPerSpine = config.halfK / numSpines;

            return `
                <div class="fade-in">
                    <span class="topology-badge two-tier">两层架构 (Leaf-Spine)</span>
                    <span class="switch-badge">${config.name} - ${config.portSpeed}</span>

                    <!-- Summary -->
                    <div class="summary-grid">
                        <div class="summary-card gpu">
                            <div class="value">${numServers.toLocaleString()}</div>
                            <div class="label">GPU 服务器</div>
                        </div>
                        <div class="summary-card leaf">
                            <div class="value">${numLeafs}</div>
                            <div class="label">Leaf 交换机</div>
                        </div>
                        <div class="summary-card spine">
                            <div class="value">${numSpines}</div>
                            <div class="label">Spine 交换机</div>
                        </div>
                        <div class="summary-card" style="border-left: 4px solid #888;">
                            <div class="value">${numSUs}</div>
                            <div class="label">SU 数量</div>
                        </div>
                        <div class="summary-card" style="border-left: 4px solid #666;">
                            <div class="value">${numLeafs + numSpines}</div>
                            <div class="label">交换机总数</div>
                        </div>
                    </div>

                    <!-- Enhanced Topology Diagram -->
                    <h3 class="section-title">连接架构图</h3>
                    <div class="topology-diagram" id="two-tier-diagram-container">
                        <div class="diagram-tabs">
                            <button class="diagram-tab active" onclick="switchDiagramView(this, 'two-tier-diagram-container', 'two-tier-arch-view')">架构示意</button>
                            <button class="diagram-tab" onclick="switchDiagramView(this, 'two-tier-diagram-container', 'two-tier-d3-view')">网络拓扑</button>
                        </div>

                        <div id="two-tier-arch-view" class="diagram-view active">
                            <div class="legend">
                                <div class="legend-item"><div class="legend-color spine"></div>Spine</div>
                                <div class="legend-item"><div class="legend-color leaf"></div>Leaf</div>
                                <div class="legend-item"><div class="legend-color gpu"></div>GPU</div>
                            </div>

                            <div class="layer-container">
                                <div class="layer">
                                    <div class="layer-label spine">Spine 层</div>
                                    <div class="layer-content">
                                        ${generateSpineNodes(numSpines)}
                                    </div>
                                </div>

                                <div class="connection-arrows">
                                    <div class="arrow-group">
                                        <div class="arrow-line"></div>
                                        <div class="arrow-head"></div>
                                        <div class="arrow-label">每Leaf ${connectionsPerSpine}条/Spine</div>
                                    </div>
                                </div>

                                <div class="layer">
                                    <div class="layer-label leaf">Leaf 层</div>
                                    <div class="layer-content">
                                        ${generateLGBoxes(numSUs)}
                                    </div>
                                </div>

                                <div class="connection-arrows">
                                    <div class="arrow-group">
                                        <div class="arrow-line"></div>
                                        <div class="arrow-head"></div>
                                        <div class="arrow-label">8 HCA/GPU</div>
                                    </div>
                                </div>

                                <div class="layer">
                                    <div class="layer-label gpu">GPU 层</div>
                                    <div class="layer-content">
                                        ${generateSUNodes(numSUs, numServers, config.serversPerSU)}
                                    </div>
                                </div>
                            </div>

                            <div class="diagram-stats">
                                <div class="diagram-stat">
                                    <div class="num">${connectionsPerSpine}</div>
                                    <div class="txt">Leaf到每Spine连接数</div>
                                </div>
                                <div class="diagram-stat">
                                    <div class="num">${config.portsPerSwitch}</div>
                                    <div class="txt">交换机端口数</div>
                                </div>
                                <div class="diagram-stat">
                                    <div class="num">${config.serversPerSU}</div>
                                    <div class="txt">每SU服务器数</div>
                                </div>
                            </div>
                        </div>

                        ${generateD3ViewHTML('two-tier-d3-view', generateD3TopologyData({
                            numCores: 0,
                            numSpines: numSpines,
                            numLeafs: numLeafs,
                            numGPUs: numServers,
                            spinesPerSuperPod: numSpines,
                            leafsPerSuperPod: numLeafs,
                            serversPerSuperPod: numServers
                        }), false)}
                    </div>

                    <div class="two-tier-info">
                        <p><strong>两层架构特点 (${config.name})：</strong></p>
                        <p>• Spine 是顶层交换机，没有 Core 层</p>
                        <p>• Spine 全部 ${config.portsPerSwitch} 个端口都用于连接 Leaf</p>
                        <p>• 最大支持 ${config.maxTwoTier.toLocaleString()} 台服务器 (P²/2 ÷ 8)</p>
                    </div>

                    <h3 class="section-title">命名规则</h3>
                    <div class="pod-structure">
                        <div class="pod-card">
                            <h4><span class="pod-icon">LG</span> Leaf Group 分组</h4>
                            ${generateLGList(numSUs)}
                        </div>
                        <div class="pod-card">
                            <h4><span class="pod-icon" style="background: linear-gradient(135deg, #ffe66d, #ffd93d); color: #000;">S</span> Spine 交换机</h4>
                            <div class="pod-item">
                                <span class="icon spine"></span>
                                <span>命名: Spine1, Spine2, ..., Spine${numSpines}</span>
                            </div>
                            <div class="pod-item">
                                <span class="icon spine"></span>
                                <span>每 Leaf 到每 Spine: ${connectionsPerSpine} 条连接</span>
                            </div>
                            <div class="pod-item">
                                <span class="icon spine"></span>
                                <span>Spine 端口: 1-${config.portsPerSwitch} (全部可用)</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateThreeTierHTML(numServers, config) {
            // SuperPOD 架构参数
            const serversPerSuperPod = config.serversPerSuperPod;
            const leafsPerSuperPod = config.leafsPerSuperPod;
            const spinesPerSuperPod = config.spinesPerSuperPod;
            const susPerSuperPod = config.susPerSuperPod;
            const numCGs = config.numCGs;
            const uplinkPorts = config.uplinkPorts || spinesPerSuperPod;  // 72 for Q3400

            const numSuperPods = Math.ceil(numServers / serversPerSuperPod);
            const numSUs = Math.ceil(numServers / config.serversPerSU);

            // Core 计算: 与 Python 代码保持一致
            // cores_per_cg = max(1, num_superpods // 2), 然后确保能整除上行端口数
            let coresPerCG = Math.max(1, Math.floor(numSuperPods / 2));
            const validFactors = [1, 2, 3, 4, 6, 8, 9, 12, 18, 24, 36, 72];
            if (uplinkPorts % coresPerCG !== 0) {
                coresPerCG = validFactors.find(c => c >= coresPerCG && uplinkPorts % c === 0) || 72;
            }
            const totalCores = numCGs * coresPerCG;
            const cablesPerCore = Math.floor(spinesPerSuperPod / coresPerCG);

            const totalLeafs = numSuperPods * leafsPerSuperPod;
            const totalSpines = numSuperPods * spinesPerSuperPod;

            return `
                <div class="fade-in">
                    <span class="topology-badge three-tier">三层 SuperPOD 架构 (Leaf-Spine-Core)</span>
                    <span class="switch-badge">${config.name} - ${config.portSpeed}</span>

                    <!-- Summary -->
                    <div class="summary-grid">
                        <div class="summary-card gpu">
                            <div class="value">${numServers.toLocaleString()}</div>
                            <div class="label">GPU 服务器</div>
                        </div>
                        <div class="summary-card pod">
                            <div class="value">${numSuperPods}</div>
                            <div class="label">SuperPOD 数量</div>
                        </div>
                        <div class="summary-card leaf">
                            <div class="value">${totalLeafs.toLocaleString()}</div>
                            <div class="label">Leaf 交换机</div>
                        </div>
                        <div class="summary-card spine">
                            <div class="value">${totalSpines.toLocaleString()}</div>
                            <div class="label">Spine 交换机</div>
                        </div>
                        <div class="summary-card core">
                            <div class="value">${totalCores.toLocaleString()}</div>
                            <div class="label">Core 交换机</div>
                        </div>
                        <div class="summary-card" style="border-left: 4px solid #666;">
                            <div class="value">${(totalLeafs + totalSpines + totalCores).toLocaleString()}</div>
                            <div class="label">交换机总数</div>
                        </div>
                    </div>

                    <!-- Enhanced Topology Diagram -->
                    <h3 class="section-title">连接架构图</h3>
                    <div class="topology-diagram" id="three-tier-diagram-container">
                        <div class="diagram-tabs">
                            <button class="diagram-tab active" onclick="switchDiagramView(this, 'three-tier-diagram-container', 'three-tier-arch-view')">架构示意</button>
                            <button class="diagram-tab" onclick="switchDiagramView(this, 'three-tier-diagram-container', 'three-tier-d3-view')">网络拓扑</button>
                        </div>

                        <div id="three-tier-arch-view" class="diagram-view active">
                            <div class="legend">
                                <div class="legend-item"><div class="legend-color core"></div>Core</div>
                                <div class="legend-item"><div class="legend-color spine"></div>Spine</div>
                                <div class="legend-item"><div class="legend-color leaf"></div>Leaf</div>
                                <div class="legend-item"><div class="legend-color gpu"></div>GPU</div>
                            </div>

                            <div class="layer-container">
                                <div class="layer">
                                    <div class="layer-label core">Core 层</div>
                                    <div class="layer-content">
                                        ${generateCoreNodesSuperPod(numCGs, coresPerCG)}
                                    </div>
                                </div>

                                <div class="connection-arrows">
                                    <div class="arrow-group">
                                        <div class="arrow-line"></div>
                                        <div class="arrow-head"></div>
                                        <div class="arrow-label">Spine{Y} → CG{Y} 所有Core (${cablesPerCore}条/Core)</div>
                                    </div>
                                </div>

                                <div class="pods-container">
                                    ${generateSuperPodBoxes(numSuperPods, spinesPerSuperPod, leafsPerSuperPod, susPerSuperPod)}
                                </div>

                                <div class="connection-arrows">
                                    <div class="arrow-group">
                                        <div class="arrow-line"></div>
                                        <div class="arrow-head"></div>
                                        <div class="arrow-label">8 HCA/GPU</div>
                                    </div>
                                </div>

                                <div class="layer">
                                    <div class="layer-label gpu">GPU 层</div>
                                    <div class="layer-content">
                                        ${generateGPUSummarySuperPod(numSUs, numServers, numSuperPods, susPerSuperPod)}
                                    </div>
                                </div>
                            </div>

                            <div class="diagram-stats">
                                <div class="diagram-stat">
                                    <div class="num">${coresPerCG}</div>
                                    <div class="txt">每CG的Core数</div>
                                </div>
                                <div class="diagram-stat">
                                    <div class="num">${numSuperPods}</div>
                                    <div class="txt">每Core连接SuperPOD数</div>
                                </div>
                                <div class="diagram-stat">
                                    <div class="num">${cablesPerCore}</div>
                                    <div class="txt">Spine到每Core连接数</div>
                                </div>
                                <div class="diagram-stat">
                                    <div class="num">${susPerSuperPod}</div>
                                    <div class="txt">每SuperPOD的SU数</div>
                                </div>
                            </div>
                        </div>

                        ${generateD3ViewHTML('three-tier-d3-view', generateD3TopologyData({
                            numCores: totalCores,
                            numSpines: totalSpines,
                            numLeafs: totalLeafs,
                            numGPUs: numServers,
                            numCGs: numCGs,
                            coresPerCG: coresPerCG,
                            spinesPerSuperPod: spinesPerSuperPod,
                            leafsPerSuperPod: leafsPerSuperPod,
                            serversPerSuperPod: serversPerSuperPod
                        }), true)}
                    </div>

                    <!-- Core Matrix Section -->
                    <h3 class="section-title">Core 交换机命名规则</h3>
                    <div class="core-section">
                        <div class="core-formula">
                            <p><strong>命名格式：</strong><code>CG{cg_id}-Core{core_id}</code></p>
                            <p style="margin-top: 10px;">
                                <strong>CG (Core Group)：</strong> 固定 ${numCGs} 组 (CG1 ~ CG${numCGs})，对应 Spine 编号<br>
                                <strong>cores_per_cg：</strong> <code>ceil(${numSuperPods} / 2) = ${coresPerCG}</code>
                            </p>
                            <p style="margin-top: 10px;">
                                <strong>总数：</strong> <code>${numCGs} × ${coresPerCG} = ${totalCores}</code> 台
                            </p>
                            <p style="margin-top: 10px;">
                                <strong>cables_per_core：</strong> <code>${spinesPerSuperPod} / ${coresPerCG} = ${cablesPerCore}</code> 条
                            </p>
                        </div>

                        <h4 style="color: #a855f7; margin: 20px 0 15px;">Core 矩阵可视化 (${numCGs} CG × ${coresPerCG} Core)</h4>
                        <div class="core-matrix-container">
                            ${generateCoreMatrixSuperPod(numCGs, coresPerCG)}
                        </div>

                        <div class="connection-example">
                            <h4>Spine → Core 连接示例</h4>
                            <p style="color: #888; margin-bottom: 15px;">
                                SuperPOD{X} 的 Spine{Y} 连接 CG{Y} 的所有 ${coresPerCG} 个 Core
                            </p>
                            <p style="color: #ffe66d; margin-bottom: 10px;"><strong>SG1-Spine1 的上行连接 (到 CG1)：</strong></p>
                            ${generateSpineToCoreConnectionsSuperPod(coresPerCG, cablesPerCore, spinesPerSuperPod)}

                            <p style="color: #a855f7; margin: 20px 0 10px;"><strong>CG1-Core1 的下行连接：</strong></p>
                            ${generateCoreToSpineConnectionsSuperPod(numSuperPods, cablesPerCore)}
                        </div>
                    </div>

                    <!-- SuperPOD Structure -->
                    <h3 class="section-title">SuperPOD 内部结构</h3>
                    <div class="pod-structure">
                        <div class="pod-card">
                            <h4><span class="pod-icon">SP</span> 每个 SuperPOD 包含</h4>
                            <div class="pod-item">
                                <span class="icon leaf"></span>
                                <span>${leafsPerSuperPod} 个 Leaf: LG{X}-Leaf1 ~ Leaf${leafsPerSuperPod}</span>
                            </div>
                            <div class="pod-item">
                                <span class="icon spine"></span>
                                <span>${spinesPerSuperPod} 个 Spine: SG{X}-Spine1 ~ Spine${spinesPerSuperPod}</span>
                            </div>
                            <div class="pod-item">
                                <span class="icon lg"></span>
                                <span>${susPerSuperPod} 个 LG (每 LG 8 个 Leaf)</span>
                            </div>
                            <div class="pod-item">
                                <span class="icon su"></span>
                                <span>${susPerSuperPod} 个 SU (每 SU ${config.serversPerSU} 台服务器)</span>
                            </div>
                        </div>
                        <div class="pod-card">
                            <h4><span class="pod-icon">LG</span> SuperPOD 内 LG 分布</h4>
                            ${generateSuperPodLGList(susPerSuperPod, leafsPerSuperPod)}
                        </div>
                    </div>

                    <!-- SU Distribution -->
                    <h3 class="section-title">全局 SU 编号分布</h3>
                    <div class="su-distribution">
                        <p>SU 在所有 SuperPOD 中全局连续编号：</p>
                        ${generateSUDistributionSuperPod(numSuperPods, susPerSuperPod)}
                    </div>
                </div>
            `;
        }

        // ========== Asymmetric Topology Functions (Q3400 400G) ==========

        function generateAsymmetricTwoTierHTML(numServers, config) {
            const numSUs = Math.ceil(numServers / config.serversPerSU);
            const numLeafs = numSUs * config.leavesPerLG;

            const minSpinesNeeded = Math.ceil(numLeafs / 2);
            const numSpines = config.spineFactors.find(f => f >= minSpinesNeeded) || config.uplinkPorts;
            const connectionsPerSpine = config.uplinkPorts / numSpines;

            return `
                <div class="fade-in">
                    <span class="topology-badge two-tier">两层架构 (Leaf-Spine)</span>
                    <span class="switch-badge">${config.name} - ${config.portSpeed}</span>

                    <div class="summary-grid">
                        <div class="summary-card gpu">
                            <div class="value">${numServers.toLocaleString()}</div>
                            <div class="label">GPU 服务器</div>
                        </div>
                        <div class="summary-card leaf">
                            <div class="value">${numLeafs}</div>
                            <div class="label">Leaf 交换机</div>
                        </div>
                        <div class="summary-card spine">
                            <div class="value">${numSpines}</div>
                            <div class="label">Spine 交换机</div>
                        </div>
                        <div class="summary-card" style="border-left: 4px solid #888;">
                            <div class="value">${numSUs}</div>
                            <div class="label">SU 数量</div>
                        </div>
                        <div class="summary-card" style="border-left: 4px solid #666;">
                            <div class="value">${numLeafs + numSpines}</div>
                            <div class="label">交换机总数</div>
                        </div>
                    </div>

                    <h3 class="section-title">连接架构图</h3>
                    <div class="topology-diagram" id="asymmetric-two-tier-diagram-container">
                        <div class="diagram-tabs">
                            <button class="diagram-tab active" onclick="switchDiagramView(this, 'asymmetric-two-tier-diagram-container', 'asymmetric-two-tier-arch-view')">架构示意</button>
                            <button class="diagram-tab" onclick="switchDiagramView(this, 'asymmetric-two-tier-diagram-container', 'asymmetric-two-tier-d3-view')">网络拓扑</button>
                        </div>

                        <div id="asymmetric-two-tier-arch-view" class="diagram-view active">
                            <div class="legend">
                                <div class="legend-item"><div class="legend-color spine"></div>Spine</div>
                                <div class="legend-item"><div class="legend-color leaf"></div>Leaf</div>
                                <div class="legend-item"><div class="legend-color gpu"></div>GPU</div>
                            </div>

                            <div class="layer-container">
                                <div class="layer">
                                    <div class="layer-label spine">Spine 层</div>
                                    <div class="layer-content">
                                        ${generateSpineNodes(numSpines)}
                                    </div>
                                </div>

                                <div class="connection-arrows">
                                    <div class="arrow-group">
                                        <div class="arrow-line"></div>
                                        <div class="arrow-head"></div>
                                        <div class="arrow-label">每Leaf ${connectionsPerSpine}条/Spine (800G)</div>
                                    </div>
                                </div>

                                <div class="layer">
                                    <div class="layer-label leaf">Leaf 层</div>
                                    <div class="layer-content">
                                        ${generateLGBoxes(numSUs)}
                                    </div>
                                </div>

                                <div class="connection-arrows">
                                    <div class="arrow-group">
                                        <div class="arrow-line"></div>
                                        <div class="arrow-head"></div>
                                        <div class="arrow-label">8 HCA/GPU (400G)</div>
                                    </div>
                                </div>

                                <div class="layer">
                                    <div class="layer-label gpu">GPU 层</div>
                                    <div class="layer-content">
                                        ${generateSUNodes(numSUs, numServers, config.serversPerSU)}
                                    </div>
                                </div>
                            </div>

                            <div class="diagram-stats">
                                <div class="diagram-stat">
                                    <div class="num">${connectionsPerSpine}</div>
                                    <div class="txt">Leaf到每Spine连接数</div>
                                </div>
                                <div class="diagram-stat">
                                    <div class="num">${config.downlinkPorts}</div>
                                    <div class="txt">Leaf下行端口(400G)</div>
                                </div>
                                <div class="diagram-stat">
                                    <div class="num">${config.uplinkPorts}</div>
                                    <div class="txt">Leaf上行端口(800G)</div>
                                </div>
                                <div class="diagram-stat">
                                    <div class="num">${config.serversPerSU}</div>
                                    <div class="txt">每SU服务器数</div>
                                </div>
                            </div>
                        </div>

                        ${generateD3ViewHTML('asymmetric-two-tier-d3-view', generateD3TopologyData({
                            numCores: 0,
                            numSpines: numSpines,
                            numLeafs: numLeafs,
                            numGPUs: numServers,
                            spinesPerSuperPod: numSpines,
                            leafsPerSuperPod: numLeafs,
                            serversPerSuperPod: numServers
                        }), false)}
                    </div>

                    <div class="two-tier-info">
                        <p><strong>Q3400 降速方案特点：</strong></p>
                        <p>• 下行端口 49-144 (96端口) 降速为 400G 连接 GPU</p>
                        <p>• 上行端口 1-48 (48端口) 保持 800G 连接 Spine</p>
                        <p>• 每 SU 96 台服务器 (比 QM9790 多 3 倍密度)</p>
                        <p>• 最大支持 ${config.maxTwoTier.toLocaleString()} 台服务器</p>
                    </div>

                    <h3 class="section-title">命名规则</h3>
                    <div class="pod-structure">
                        <div class="pod-card">
                            <h4><span class="pod-icon">LG</span> Leaf Group 分组</h4>
                            ${generateLGList(numSUs)}
                        </div>
                        <div class="pod-card">
                            <h4><span class="pod-icon" style="background: linear-gradient(135deg, #ffe66d, #ffd93d); color: #000;">S</span> Spine 交换机</h4>
                            <div class="pod-item">
                                <span class="icon spine"></span>
                                <span>命名: Spine1, Spine2, ..., Spine${numSpines}</span>
                            </div>
                            <div class="pod-item">
                                <span class="icon spine"></span>
                                <span>每 Leaf 到每 Spine: ${connectionsPerSpine} 条 800G 连接</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateAsymmetricThreeTierHTML(numServers, config) {
            // SuperPOD 架构参数 (非对称: 72 Leaf + 48 Spine)
            const serversPerSuperPod = config.serversPerSuperPod;  // 864
            const leafsPerSuperPod = config.leafsPerSuperPod;  // 72
            const spinesPerSuperPod = config.spinesPerSuperPod;  // 48
            const susPerSuperPod = config.susPerSuperPod;  // 9
            const numCGs = config.numCGs;  // 48
            const spineUplinkPorts = 72;  // Spine 上行端口数 (到 Core)

            const numSuperPods = Math.ceil(numServers / serversPerSuperPod);
            const numSUs = Math.ceil(numServers / config.serversPerSU);

            // Core 计算: 与 Python 代码保持一致
            let coresPerCG = Math.max(1, Math.floor(numSuperPods / 2));
            const validFactors = [1, 2, 3, 4, 6, 8, 9, 12, 18, 24, 36, 72];
            if (spineUplinkPorts % coresPerCG !== 0) {
                coresPerCG = validFactors.find(c => c >= coresPerCG && spineUplinkPorts % c === 0) || 72;
            }
            const totalCores = numCGs * coresPerCG;
            const cablesPerCore = Math.floor(spineUplinkPorts / coresPerCG);  // 72 / cores_per_cg

            const totalLeafs = numSuperPods * leafsPerSuperPod;
            const totalSpines = numSuperPods * spinesPerSuperPod;

            return `
                <div class="fade-in">
                    <span class="topology-badge three-tier">三层非对称 SuperPOD (72 Leaf + 48 Spine)</span>
                    <span class="switch-badge">${config.name} - ${config.portSpeed}</span>

                    <div class="summary-grid">
                        <div class="summary-card gpu">
                            <div class="value">${numServers.toLocaleString()}</div>
                            <div class="label">GPU 服务器</div>
                        </div>
                        <div class="summary-card pod">
                            <div class="value">${numSuperPods}</div>
                            <div class="label">SuperPOD 数量</div>
                        </div>
                        <div class="summary-card leaf">
                            <div class="value">${totalLeafs.toLocaleString()}</div>
                            <div class="label">Leaf 交换机</div>
                        </div>
                        <div class="summary-card spine">
                            <div class="value">${totalSpines.toLocaleString()}</div>
                            <div class="label">Spine 交换机</div>
                        </div>
                        <div class="summary-card core">
                            <div class="value">${totalCores.toLocaleString()}</div>
                            <div class="label">Core 交换机</div>
                        </div>
                        <div class="summary-card" style="border-left: 4px solid #666;">
                            <div class="value">${(totalLeafs + totalSpines + totalCores).toLocaleString()}</div>
                            <div class="label">交换机总数</div>
                        </div>
                    </div>

                    <h3 class="section-title">连接架构图</h3>
                    <div class="topology-diagram" id="asymmetric-three-tier-diagram-container">
                        <div class="diagram-tabs">
                            <button class="diagram-tab active" onclick="switchDiagramView(this, 'asymmetric-three-tier-diagram-container', 'asymmetric-three-tier-arch-view')">架构示意</button>
                            <button class="diagram-tab" onclick="switchDiagramView(this, 'asymmetric-three-tier-diagram-container', 'asymmetric-three-tier-d3-view')">网络拓扑</button>
                        </div>

                        <div id="asymmetric-three-tier-arch-view" class="diagram-view active">
                            <div class="legend">
                                <div class="legend-item"><div class="legend-color core"></div>Core</div>
                                <div class="legend-item"><div class="legend-color spine"></div>Spine</div>
                                <div class="legend-item"><div class="legend-color leaf"></div>Leaf</div>
                                <div class="legend-item"><div class="legend-color gpu"></div>GPU</div>
                            </div>

                            <div class="layer-container">
                                <div class="layer">
                                    <div class="layer-label core">Core 层</div>
                                    <div class="layer-content">
                                        ${generateCoreNodesSuperPod(numCGs, coresPerCG)}
                                    </div>
                                </div>

                                <div class="connection-arrows">
                                    <div class="arrow-group">
                                        <div class="arrow-line"></div>
                                        <div class="arrow-head"></div>
                                        <div class="arrow-label">Spine{Y} → CG{Y} 所有Core (${cablesPerCore}条/Core) 800G</div>
                                    </div>
                                </div>

                                <div class="pods-container">
                                    ${generateAsymmetricSuperPodBoxes(numSuperPods, spinesPerSuperPod, leafsPerSuperPod, susPerSuperPod)}
                                </div>

                                <div class="connection-arrows">
                                    <div class="arrow-group">
                                        <div class="arrow-line"></div>
                                        <div class="arrow-head"></div>
                                        <div class="arrow-label">8 HCA/GPU (400G)</div>
                                    </div>
                                </div>

                                <div class="layer">
                                    <div class="layer-label gpu">GPU 层</div>
                                    <div class="layer-content">
                                        ${generateGPUSummarySuperPod(numSUs, numServers, numSuperPods, susPerSuperPod)}
                                    </div>
                                </div>
                            </div>

                            <div class="diagram-stats">
                                <div class="diagram-stat">
                                    <div class="num">${coresPerCG}</div>
                                    <div class="txt">每CG的Core数</div>
                                </div>
                                <div class="diagram-stat">
                                    <div class="num">${numSuperPods}</div>
                                    <div class="txt">每Core连接SuperPOD数</div>
                                </div>
                                <div class="diagram-stat">
                                    <div class="num">${cablesPerCore}</div>
                                    <div class="txt">Spine到每Core连接数</div>
                                </div>
                                <div class="diagram-stat">
                                    <div class="num">${susPerSuperPod}</div>
                                    <div class="txt">每SuperPOD的SU数</div>
                                </div>
                            </div>
                        </div>

                        ${generateD3ViewHTML('asymmetric-three-tier-d3-view', generateD3TopologyData({
                            numCores: totalCores,
                            numSpines: totalSpines,
                            numLeafs: totalLeafs,
                            numGPUs: numServers,
                            numCGs: numCGs,
                            coresPerCG: coresPerCG,
                            spinesPerSuperPod: spinesPerSuperPod,
                            leafsPerSuperPod: leafsPerSuperPod,
                            serversPerSuperPod: serversPerSuperPod
                        }), true)}
                    </div>

                    <!-- Core Matrix Section -->
                    <h3 class="section-title">Core 交换机命名规则</h3>
                    <div class="core-section">
                        <div class="core-formula">
                            <p><strong>命名格式：</strong><code>CG{cg_id}-Core{core_id}</code></p>
                            <p style="margin-top: 10px;">
                                <strong>CG (Core Group)：</strong> 固定 ${numCGs} 组 (CG1 ~ CG${numCGs})，对应 Spine 编号<br>
                                <strong>cores_per_cg：</strong> <code>ceil(${numSuperPods} / 2) = ${coresPerCG}</code>
                            </p>
                            <p style="margin-top: 10px;">
                                <strong>总数：</strong> <code>${numCGs} × ${coresPerCG} = ${totalCores}</code> 台
                            </p>
                            <p style="margin-top: 10px;">
                                <strong>cables_per_core：</strong> <code>${leafsPerSuperPod} / ${coresPerCG} = ${cablesPerCore}</code> 条
                            </p>
                        </div>

                        <h4 style="color: #a855f7; margin: 20px 0 15px;">Core 矩阵可视化 (${numCGs} CG × ${coresPerCG} Core)</h4>
                        <div class="core-matrix-container">
                            ${generateCoreMatrixSuperPod(numCGs, coresPerCG)}
                        </div>

                        <div class="connection-example">
                            <h4>Spine → Core 连接示例</h4>
                            <p style="color: #888; margin-bottom: 15px;">
                                SuperPOD{X} 的 Spine{Y} 连接 CG{Y} 的所有 ${coresPerCG} 个 Core (800G)
                            </p>
                            <p style="color: #ffe66d; margin-bottom: 10px;"><strong>SG1-Spine1 的上行连接 (到 CG1)：</strong></p>
                            ${generateSpineToCoreConnectionsSuperPod(coresPerCG, cablesPerCore, spinesPerSuperPod)}

                            <p style="color: #a855f7; margin: 20px 0 10px;"><strong>CG1-Core1 的下行连接：</strong></p>
                            ${generateCoreToSpineConnectionsSuperPod(numSuperPods, cablesPerCore)}
                        </div>
                    </div>

                    <!-- SuperPOD Structure -->
                    <h3 class="section-title">SuperPOD 内部结构 (非对称)</h3>
                    <div class="pod-structure">
                        <div class="pod-card">
                            <h4><span class="pod-icon">SP</span> 每个 SuperPOD 包含</h4>
                            <div class="pod-item">
                                <span class="icon leaf"></span>
                                <span>${leafsPerSuperPod} 个 Leaf: LG{X}-Leaf1 ~ Leaf${leafsPerSuperPod}</span>
                            </div>
                            <div class="pod-item">
                                <span class="icon spine"></span>
                                <span>${spinesPerSuperPod} 个 Spine: SG{X}-Spine1 ~ Spine${spinesPerSuperPod}</span>
                            </div>
                            <div class="pod-item">
                                <span class="icon lg"></span>
                                <span>${susPerSuperPod} 个 LG (每 LG 8 个 Leaf)</span>
                            </div>
                            <div class="pod-item">
                                <span class="icon su"></span>
                                <span>${susPerSuperPod} 个 SU (每 SU ${config.serversPerSU} 台服务器)</span>
                            </div>
                            <div class="pod-item" style="color: #ff6b6b; font-weight: bold;">
                                <span>非对称: ${leafsPerSuperPod} Leaf ≠ ${spinesPerSuperPod} Spine</span>
                            </div>
                        </div>
                        <div class="pod-card">
                            <h4><span class="pod-icon">LG</span> SuperPOD 内 LG 分布</h4>
                            ${generateSuperPodLGList(susPerSuperPod, leafsPerSuperPod)}
                        </div>
                    </div>

                    <!-- SU Distribution -->
                    <h3 class="section-title">全局 SU 编号分布</h3>
                    <div class="su-distribution">
                        <p>SU 在所有 SuperPOD 中全局连续编号：</p>
                        ${generateSUDistributionSuperPod(numSuperPods, susPerSuperPod)}
                    </div>

                    <!-- Comparison Info -->
                    <h3 class="section-title">方案对比优势</h3>
                    <div class="two-tier-info" style="background: rgba(0, 212, 255, 0.1); border-color: rgba(0, 212, 255, 0.3);">
                        <p style="color: #00d4ff;"><strong>Q3400 降速方案 vs QM9790 原生 400G：</strong></p>
                        <p style="color: #aaa;">• 每 SU 服务器: 96 台 vs 32 台 (3 倍密度)</p>
                        <p style="color: #aaa;">• 每 SuperPOD 容量: 864 台 vs 128 台 (6.75 倍)</p>
                        <p style="color: #aaa;">• 上行带宽: 800G vs 400G (2 倍)</p>
                        <p style="color: #aaa;">• 交换机数量大幅减少约 70%</p>
                        <p style="color: #aaa;">• 未来可直接升级到全 800G</p>
                    </div>
                </div>
            `;
        }

        // ========== Comparison Functions ==========

        function calculateQM9790Topology(numServers) {
            const config = SWITCH_CONFIG['QM9790'];
            const halfK = config.halfK;  // 32
            const numSUs = Math.ceil(numServers / config.serversPerSU);

            if (numServers <= config.maxTwoTier) {
                // Two-tier
                const numLeafs = numSUs * config.leavesPerLG;
                const minSpinesNeeded = Math.ceil(numLeafs / 2);
                const numSpines = config.spineFactors.find(f => f >= minSpinesNeeded) || halfK;
                return {
                    type: '两层',
                    servers: numServers,
                    sus: numSUs,
                    superPods: 0,
                    leafs: numLeafs,
                    spines: numSpines,
                    cores: 0,
                    totalSwitches: numLeafs + numSpines,
                    serversPerSU: config.serversPerSU,
                    serversPerSuperPod: 0
                };
            } else {
                // Three-tier SuperPOD
                const serversPerSuperPod = config.serversPerSuperPod;  // 128
                const leafsPerSuperPod = config.leafsPerSuperPod;  // 32
                const spinesPerSuperPod = config.spinesPerSuperPod;  // 32
                const numCGs = config.numCGs;  // 32
                const uplinkPorts = 32;  // QM9790 上行端口数
                const numSuperPods = Math.ceil(numServers / serversPerSuperPod);

                // 计算 coresPerCG: 使用 floor division, 然后调整到可整除上行端口数的因子
                // 与 Python 代码保持一致: cores_per_cg = max(1, num_superpods // 2)
                // 然后确保 UPLINK_PORTS % cores_per_cg == 0
                let coresPerCG = Math.max(1, Math.floor(numSuperPods / 2));
                const validFactors = [1, 2, 4, 8, 16, 32];
                if (uplinkPorts % coresPerCG !== 0) {
                    // 找到第一个 >= coresPerCG 且能整除 uplinkPorts 的因子
                    coresPerCG = validFactors.find(c => c >= coresPerCG && uplinkPorts % c === 0) || 32;
                }

                const totalLeafs = numSuperPods * leafsPerSuperPod;
                const totalSpines = numSuperPods * spinesPerSuperPod;
                const totalCores = numCGs * coresPerCG;
                return {
                    type: '三层',
                    servers: numServers,
                    sus: numSUs,
                    superPods: numSuperPods,
                    leafs: totalLeafs,
                    spines: totalSpines,
                    cores: totalCores,
                    totalSwitches: totalLeafs + totalSpines + totalCores,
                    serversPerSU: config.serversPerSU,
                    serversPerSuperPod: serversPerSuperPod,
                    coreMatrix: `${numCGs}×${coresPerCG}`
                };
            }
        }

        function calculateQ3400_400GTopology(numServers) {
            const config = SWITCH_CONFIG['Q3400_400G'];
            const numSUs = Math.ceil(numServers / config.serversPerSU);

            if (numServers <= config.maxTwoTier) {
                // Two-tier
                const numLeafs = numSUs * config.leavesPerLG;
                const minSpinesNeeded = Math.ceil(numLeafs / 2);
                const numSpines = config.spineFactors.find(f => f >= minSpinesNeeded) || config.uplinkPorts;
                return {
                    type: '两层',
                    servers: numServers,
                    sus: numSUs,
                    superPods: 0,
                    leafs: numLeafs,
                    spines: numSpines,
                    cores: 0,
                    totalSwitches: numLeafs + numSpines,
                    serversPerSU: config.serversPerSU,
                    serversPerSuperPod: 0
                };
            } else {
                // Three-tier SuperPOD (asymmetric)
                const serversPerSuperPod = config.serversPerSuperPod;  // 864
                const leafsPerSuperPod = config.leafsPerSuperPod;  // 72
                const spinesPerSuperPod = config.spinesPerSuperPod;  // 48
                const numCGs = config.numCGs;  // 48
                const spineUplinkPorts = 72;  // Spine 上行端口数 (到 Core)
                const numSuperPods = Math.ceil(numServers / serversPerSuperPod);

                // 计算 coresPerCG: 与 Python 代码保持一致
                // cores_per_cg = max(1, num_superpods // 2), 然后确保能整除 72
                let coresPerCG = Math.max(1, Math.floor(numSuperPods / 2));
                const validFactors = [1, 2, 3, 4, 6, 8, 9, 12, 18, 24, 36, 72];
                if (spineUplinkPorts % coresPerCG !== 0) {
                    coresPerCG = validFactors.find(c => c >= coresPerCG && spineUplinkPorts % c === 0) || 72;
                }

                const totalLeafs = numSuperPods * leafsPerSuperPod;
                const totalSpines = numSuperPods * spinesPerSuperPod;
                const totalCores = numCGs * coresPerCG;
                return {
                    type: '三层非对称',
                    servers: numServers,
                    sus: numSUs,
                    superPods: numSuperPods,
                    leafs: totalLeafs,
                    spines: totalSpines,
                    cores: totalCores,
                    totalSwitches: totalLeafs + totalSpines + totalCores,
                    serversPerSU: config.serversPerSU,
                    serversPerSuperPod: serversPerSuperPod,
                    coreMatrix: `${numCGs}×${coresPerCG}`
                };
            }
        }

        function generateComparisonHTML(numServers) {
            const qm9790 = calculateQM9790Topology(numServers);
            const q3400 = calculateQ3400_400GTopology(numServers);

            // Calculate savings
            const leafSaved = qm9790.leafs - q3400.leafs;
            const leafSavedPct = ((leafSaved / qm9790.leafs) * 100).toFixed(1);
            const spineSaved = qm9790.spines - q3400.spines;
            const spineSavedPct = ((spineSaved / qm9790.spines) * 100).toFixed(1);
            const coreSaved = qm9790.cores - q3400.cores;
            const coreSavedPct = qm9790.cores > 0 ? ((coreSaved / qm9790.cores) * 100).toFixed(1) : 0;
            const totalSaved = qm9790.totalSwitches - q3400.totalSwitches;
            const totalSavedPct = ((totalSaved / qm9790.totalSwitches) * 100).toFixed(1);
            const superPodSaved = qm9790.superPods - q3400.superPods;
            const superPodSavedPct = qm9790.superPods > 0 ? ((superPodSaved / qm9790.superPods) * 100).toFixed(1) : 0;

            // ==========================================
            // 光模块和线缆计算 - 基于实际模块规格
            // ==========================================
            // QM9790: 32 cage, 使用 MMA4Z00-NS (800G/双400G) = 64个400G端口
            // Q3400: 72 cage, 使用 MMS4A00-XM (1600G/双800G) = 144个800G端口
            // Q3400降速: Leaf下行用MMA4Z00-NS, 上行用MMS4A00-XM
            // 服务器侧: 使用400G单端口模块

            // === QM9790 方案 (全400G) ===
            // 线缆计算 (所有连接都是400G，使用相同MPO线缆)
            const qm9790_cables_gpu_leaf = numServers * 8;  // 每服务器8个HCA到Leaf
            const qm9790_cables_leaf_spine = qm9790.leafs * 32;  // 每Leaf 32端口上行到Spine
            const qm9790_cables_spine_core = qm9790.cores > 0 ? qm9790.spines * 32 : 0;  // 每Spine 32端口上行到Core
            const qm9790TotalCables = qm9790_cables_gpu_leaf + qm9790_cables_leaf_spine + qm9790_cables_spine_core;

            // 模块计算
            // 交换机侧 MMA4Z00-NS 模块:
            // - Leaf: 每台32个模块 (全部使用)
            // - Spine 三层: 每台32个模块 (下行+上行全部使用)
            // - Spine 两层: 只有下行连接Leaf，实际使用模块 = Leaf-Spine连接数 / 2
            // - Core: 每台32个模块 (全部使用)
            const qm9790_leaf_modules = qm9790.leafs * 32;
            const qm9790_spine_modules = qm9790.cores > 0
                ? qm9790.spines * 32  // 三层: 每Spine全部32个cage装模块
                : qm9790_cables_leaf_spine / 2;  // 两层: 基于实际连接数
            const qm9790_core_modules = qm9790.cores * 32;
            const qm9790_MMA4Z00_modules = qm9790_leaf_modules + qm9790_spine_modules + qm9790_core_modules;
            // 服务器侧: 每台服务器8个400G单端口模块
            const qm9790_400G_single_modules = numServers * 8;

            // === Q3400 降速方案 (下行400G, 上行800G) ===
            // 线缆计算 (所有连接使用相同MPO线缆)
            const q3400_cables_gpu_leaf = numServers * 8;  // 每服务器8个HCA到Leaf (400G连接)
            const q3400_cables_leaf_spine = q3400.leafs * 48;  // 每Leaf 48端口上行到Spine (800G连接)
            const q3400_cables_spine_core = q3400.cores > 0 ? q3400.spines * 48 : 0;  // 每Spine 48端口上行到Core (800G连接)
            const q3400TotalCables = q3400_cables_gpu_leaf + q3400_cables_leaf_spine + q3400_cables_spine_core;

            // 模块计算
            // Leaf: 48个MMA4Z00-NS(下行96×400G) + 24个MMS4A00-XM(上行48×800G)
            const q3400_leaf_MMA4Z00 = q3400.leafs * 48;
            const q3400_leaf_MMS4A00 = q3400.leafs * 24;
            // Spine 模块计算:
            // - 三层: 每Spine 72个模块 (下行72端口连Leaf + 上行72端口连Core，但降速方案上行48端口)
            // - 两层: 只有下行连接Leaf，实际使用模块 = Leaf-Spine连接数 / 2
            const q3400_spine_MMS4A00 = q3400.cores > 0
                ? q3400.spines * 72  // 三层: 每Spine全部72个cage装模块
                : q3400_cables_leaf_spine / 2;  // 两层: 基于实际连接数
            // Core: 72个MMS4A00-XM (全800G, 144端口)
            const q3400_core_MMS4A00 = q3400.cores * 72;
            // 汇总
            const q3400_MMA4Z00_modules = q3400_leaf_MMA4Z00;  // 只有Leaf下行用
            const q3400_MMS4A00_modules = q3400_leaf_MMS4A00 + q3400_spine_MMS4A00 + q3400_core_MMS4A00;
            // 服务器侧: 每台服务器8个400G单端口模块
            const q3400_400G_single_modules = numServers * 8;

            const cablesSaved = qm9790TotalCables - q3400TotalCables;
            const cablesSavedPct = ((cablesSaved / qm9790TotalCables) * 100).toFixed(1);

            // Get prices from inputs
            const priceQM9790Switch = parseFloat(document.getElementById('priceQM9790Switch').value) || 0;
            const priceQ3400Switch = parseFloat(document.getElementById('priceQ3400Switch').value) || 0;
            const priceMMA4Z00 = parseFloat(document.getElementById('priceMMA4Z00').value) || 0;
            const priceMMS4A00 = parseFloat(document.getElementById('priceMMS4A00').value) || 0;
            const price400GSingle = parseFloat(document.getElementById('price400GSingle').value) || 0;
            const priceMPOCable = parseFloat(document.getElementById('priceMPOCable').value) || 0;

            const hasPrices = priceQM9790Switch > 0 || priceQ3400Switch > 0 || priceMMA4Z00 > 0 || priceMMS4A00 > 0;

            // Calculate costs
            // QM9790 成本
            const qm9790SwitchCost = qm9790.totalSwitches * priceQM9790Switch;
            const qm9790_MMA4Z00_cost = qm9790_MMA4Z00_modules * priceMMA4Z00;
            const qm9790_400G_single_cost = qm9790_400G_single_modules * price400GSingle;
            const qm9790CableCost = qm9790TotalCables * priceMPOCable;
            const qm9790ModuleCost = qm9790_MMA4Z00_cost + qm9790_400G_single_cost;
            const qm9790TotalCost = qm9790SwitchCost + qm9790ModuleCost + qm9790CableCost;

            // Q3400 成本
            const q3400SwitchCost = q3400.totalSwitches * priceQ3400Switch;
            const q3400_MMA4Z00_cost = q3400_MMA4Z00_modules * priceMMA4Z00;
            const q3400_MMS4A00_cost = q3400_MMS4A00_modules * priceMMS4A00;
            const q3400_400G_single_cost = q3400_400G_single_modules * price400GSingle;
            const q3400CableCost = q3400TotalCables * priceMPOCable;
            const q3400ModuleCost = q3400_MMA4Z00_cost + q3400_MMS4A00_cost + q3400_400G_single_cost;
            const q3400TotalCost = q3400SwitchCost + q3400ModuleCost + q3400CableCost;

            const costSaved = qm9790TotalCost - q3400TotalCost;
            const costSavedPct = qm9790TotalCost > 0 ? ((costSaved / qm9790TotalCost) * 100).toFixed(1) : 0;

            // Format currency
            const formatCurrency = (value) => {
                if (value >= 100000000) {
                    return (value / 100000000).toFixed(2) + ' 亿';
                } else if (value >= 10000) {
                    return (value / 10000).toFixed(2) + ' 万';
                }
                return value.toLocaleString();
            };

            return `
                <div class="fade-in">
                    <h2 style="color: #ffa500; text-align: center; margin-bottom: 10px;">
                        400G 组网方案对比
                    </h2>
                    <p style="text-align: center; color: #888; margin-bottom: 30px;">
                        ${numServers.toLocaleString()} 台 GPU 服务器
                    </p>

                    <!-- Savings Summary -->
                    <div class="savings-section">
                        <div class="savings-title">Q3400 降速方案节省统计</div>
                        <div class="savings-grid">
                            <div class="savings-item">
                                <div class="value">${totalSavedPct}%</div>
                                <div class="label">交换机节省</div>
                                <div class="detail">${qm9790.totalSwitches.toLocaleString()} → ${q3400.totalSwitches.toLocaleString()} 台</div>
                            </div>
                            <div class="savings-item">
                                <div class="value">${leafSavedPct}%</div>
                                <div class="label">Leaf 节省</div>
                                <div class="detail">${qm9790.leafs.toLocaleString()} → ${q3400.leafs.toLocaleString()} 台</div>
                            </div>
                            <div class="savings-item">
                                <div class="value">${spineSavedPct}%</div>
                                <div class="label">Spine 节省</div>
                                <div class="detail">${qm9790.spines.toLocaleString()} → ${q3400.spines.toLocaleString()} 台</div>
                            </div>
                            ${qm9790.cores > 0 ? `
                            <div class="savings-item">
                                <div class="value">${coreSavedPct}%</div>
                                <div class="label">Core 节省</div>
                                <div class="detail">${qm9790.cores.toLocaleString()} → ${q3400.cores.toLocaleString()} 台</div>
                            </div>
                            ` : ''}
                            ${qm9790.superPods > 0 ? `
                            <div class="savings-item">
                                <div class="value">${superPodSavedPct}%</div>
                                <div class="label">SuperPOD 节省</div>
                                <div class="detail">${qm9790.superPods} → ${q3400.superPods} 个</div>
                            </div>
                            ` : ''}
                            <div class="savings-item">
                                <div class="value ${cablesSaved >= 0 ? '' : 'negative'}">${cablesSavedPct}%</div>
                                <div class="label">线缆节省</div>
                                <div class="detail">${qm9790TotalCables.toLocaleString()} → ${q3400TotalCables.toLocaleString()} 条</div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Comparison Table -->
                    <h3 class="section-title">详细对比</h3>
                    <div style="background: rgba(0,0,0,0.2); border-radius: 15px; padding: 20px; overflow-x: auto;">
                        <table class="comparison-table">
                            <thead>
                                <tr>
                                    <th>指标</th>
                                    <th class="qm9790-col">QM9790 (64×400G)</th>
                                    <th class="q3400-col">Q3400 降速 (96×400G+48×800G)</th>
                                    <th class="savings-col">节省</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>拓扑类型</td>
                                    <td class="qm9790-col">${qm9790.type}</td>
                                    <td class="q3400-col">${q3400.type}</td>
                                    <td>-</td>
                                </tr>
                                <tr>
                                    <td>每 SU 服务器</td>
                                    <td class="qm9790-col">${qm9790.serversPerSU} 台</td>
                                    <td class="q3400-col">${q3400.serversPerSU} 台 <span class="winner-badge">3倍</span></td>
                                    <td class="savings-col">+${q3400.serversPerSU - qm9790.serversPerSU}</td>
                                </tr>
                                ${qm9790.superPods > 0 ? `
                                <tr>
                                    <td>每 SuperPOD 容量</td>
                                    <td class="qm9790-col">${qm9790.serversPerSuperPod} 台</td>
                                    <td class="q3400-col">${q3400.serversPerSuperPod} 台 <span class="winner-badge">${(q3400.serversPerSuperPod / qm9790.serversPerSuperPod).toFixed(1)}倍</span></td>
                                    <td class="savings-col">+${q3400.serversPerSuperPod - qm9790.serversPerSuperPod}</td>
                                </tr>
                                <tr>
                                    <td>SuperPOD 数量</td>
                                    <td class="qm9790-col">${qm9790.superPods} 个</td>
                                    <td class="q3400-col">${q3400.superPods} 个</td>
                                    <td class="savings-col">${superPodSaved > 0 ? '-' + superPodSaved + ' (' + superPodSavedPct + '%)' : '-'}</td>
                                </tr>
                                ` : ''}
                                <tr>
                                    <td>SU 数量</td>
                                    <td class="qm9790-col">${qm9790.sus} 个</td>
                                    <td class="q3400-col">${q3400.sus} 个</td>
                                    <td class="savings-col">${qm9790.sus - q3400.sus > 0 ? '-' + (qm9790.sus - q3400.sus) : '-'}</td>
                                </tr>
                                <tr>
                                    <td>Leaf 交换机</td>
                                    <td class="qm9790-col">${qm9790.leafs.toLocaleString()} 台</td>
                                    <td class="q3400-col">${q3400.leafs.toLocaleString()} 台</td>
                                    <td class="savings-col">-${leafSaved.toLocaleString()} (${leafSavedPct}%)</td>
                                </tr>
                                <tr>
                                    <td>Spine 交换机</td>
                                    <td class="qm9790-col">${qm9790.spines.toLocaleString()} 台</td>
                                    <td class="q3400-col">${q3400.spines.toLocaleString()} 台</td>
                                    <td class="savings-col">-${spineSaved.toLocaleString()} (${spineSavedPct}%)</td>
                                </tr>
                                ${qm9790.cores > 0 ? `
                                <tr>
                                    <td>Core 交换机</td>
                                    <td class="qm9790-col">${qm9790.cores.toLocaleString()} 台</td>
                                    <td class="q3400-col">${q3400.cores.toLocaleString()} 台</td>
                                    <td class="savings-col">-${coreSaved.toLocaleString()} (${coreSavedPct}%)</td>
                                </tr>
                                <tr>
                                    <td>Core 矩阵</td>
                                    <td class="qm9790-col">${qm9790.coreMatrix}</td>
                                    <td class="q3400-col">${q3400.coreMatrix}</td>
                                    <td>-</td>
                                </tr>
                                ` : ''}
                                <tr style="background: rgba(0, 255, 136, 0.1);">
                                    <td><strong>交换机总数</strong></td>
                                    <td class="qm9790-col"><strong>${qm9790.totalSwitches.toLocaleString()} 台</strong></td>
                                    <td class="q3400-col"><strong>${q3400.totalSwitches.toLocaleString()} 台</strong> <span class="winner-badge">优选</span></td>
                                    <td class="savings-col"><strong>-${totalSaved.toLocaleString()} (${totalSavedPct}%)</strong></td>
                                </tr>
                                <tr>
                                    <td>MPO 线缆总数</td>
                                    <td class="qm9790-col">${qm9790TotalCables.toLocaleString()} 条</td>
                                    <td class="q3400-col">${q3400TotalCables.toLocaleString()} 条</td>
                                    <td class="savings-col">${cablesSaved >= 0 ? '-' + cablesSaved.toLocaleString() + ' (' + cablesSavedPct + '%)' : '+' + Math.abs(cablesSaved).toLocaleString()}</td>
                                </tr>
                                <tr>
                                    <td>MMA4Z00-NS 模块</td>
                                    <td class="qm9790-col">${qm9790_MMA4Z00_modules.toLocaleString()} 个</td>
                                    <td class="q3400-col">${q3400_MMA4Z00_modules.toLocaleString()} 个</td>
                                    <td class="savings-col">${qm9790_MMA4Z00_modules > q3400_MMA4Z00_modules ? '-' + (qm9790_MMA4Z00_modules - q3400_MMA4Z00_modules).toLocaleString() : '+' + (q3400_MMA4Z00_modules - qm9790_MMA4Z00_modules).toLocaleString()}</td>
                                </tr>
                                <tr>
                                    <td>MMS4A00-XM 模块</td>
                                    <td class="qm9790-col">0 个</td>
                                    <td class="q3400-col">${q3400_MMS4A00_modules.toLocaleString()} 个</td>
                                    <td class="savings-col">+${q3400_MMS4A00_modules.toLocaleString()}</td>
                                </tr>
                                <tr>
                                    <td>MMA4Z00-NS400 (网卡侧)</td>
                                    <td class="qm9790-col">${qm9790_400G_single_modules.toLocaleString()} 个</td>
                                    <td class="q3400-col">${q3400_400G_single_modules.toLocaleString()} 个</td>
                                    <td class="savings-col">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    ${hasPrices ? `
                    <!-- Cost Comparison -->
                    <h3 class="section-title">💰 成本对比分析</h3>
                    <div class="cost-summary">
                        <div class="cost-card qm9790">
                            <div class="cost-card-header">QM9790 方案成本</div>
                            <div class="cost-breakdown">
                                <div class="cost-item">
                                    <span class="cost-label">交换机 (${qm9790.totalSwitches.toLocaleString()} 台)</span>
                                    <span class="cost-value">¥${formatCurrency(qm9790SwitchCost)}</span>
                                </div>
                                <div class="cost-item">
                                    <span class="cost-label">MMA4Z00-NS (${qm9790_MMA4Z00_modules.toLocaleString()} 个)</span>
                                    <span class="cost-value">¥${formatCurrency(qm9790_MMA4Z00_cost)}</span>
                                </div>
                                <div class="cost-item">
                                    <span class="cost-label">MMA4Z00-NS400 (${qm9790_400G_single_modules.toLocaleString()} 个)</span>
                                    <span class="cost-value">¥${formatCurrency(qm9790_400G_single_cost)}</span>
                                </div>
                                <div class="cost-item">
                                    <span class="cost-label">MPO 线缆 (${qm9790TotalCables.toLocaleString()} 条)</span>
                                    <span class="cost-value">¥${formatCurrency(qm9790CableCost)}</span>
                                </div>
                                <div class="cost-item total">
                                    <span class="cost-label">总成本</span>
                                    <span class="cost-value">¥${formatCurrency(qm9790TotalCost)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="cost-card q3400">
                            <div class="cost-card-header">Q3400 降速方案成本</div>
                            <div class="cost-breakdown">
                                <div class="cost-item">
                                    <span class="cost-label">交换机 (${q3400.totalSwitches.toLocaleString()} 台)</span>
                                    <span class="cost-value">¥${formatCurrency(q3400SwitchCost)}</span>
                                </div>
                                <div class="cost-item">
                                    <span class="cost-label">MMA4Z00-NS (${q3400_MMA4Z00_modules.toLocaleString()} 个)</span>
                                    <span class="cost-value">¥${formatCurrency(q3400_MMA4Z00_cost)}</span>
                                </div>
                                <div class="cost-item">
                                    <span class="cost-label">MMS4A00-XM (${q3400_MMS4A00_modules.toLocaleString()} 个)</span>
                                    <span class="cost-value">¥${formatCurrency(q3400_MMS4A00_cost)}</span>
                                </div>
                                <div class="cost-item">
                                    <span class="cost-label">MMA4Z00-NS400 (${q3400_400G_single_modules.toLocaleString()} 个)</span>
                                    <span class="cost-value">¥${formatCurrency(q3400_400G_single_cost)}</span>
                                </div>
                                <div class="cost-item">
                                    <span class="cost-label">MPO 线缆 (${q3400TotalCables.toLocaleString()} 条)</span>
                                    <span class="cost-value">¥${formatCurrency(q3400CableCost)}</span>
                                </div>
                                <div class="cost-item total">
                                    <span class="cost-label">总成本</span>
                                    <span class="cost-value">¥${formatCurrency(q3400TotalCost)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="cost-card savings">
                            <div class="cost-card-header">💵 成本节省</div>
                            <div class="cost-savings-display">
                                <div class="savings-amount ${costSaved >= 0 ? 'positive' : 'negative'}">
                                    ${costSaved >= 0 ? '-' : '+'}¥${formatCurrency(Math.abs(costSaved))}
                                </div>
                                <div class="savings-percentage ${costSaved >= 0 ? 'positive' : 'negative'}">
                                    ${costSaved >= 0 ? '节省' : '增加'} ${Math.abs(costSavedPct)}%
                                </div>
                                <div class="savings-note">
                                    ${costSaved >= 0 ? 'Q3400 降速方案成本更低' : 'QM9790 方案成本更低'}
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Side by Side Cards -->
                    <h3 class="section-title">方案规格对比</h3>
                    <div class="comparison-container">
                        <div class="comparison-card qm9790">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">QM9790</div>
                                    <div class="card-subtitle">64 端口全 400G 交换机</div>
                                </div>
                            </div>
                            <div class="comparison-stat-row">
                                <span class="comparison-stat-label">端口配置</span>
                                <span class="comparison-stat-value">32↑ + 32↓</span>
                            </div>
                            <div class="comparison-stat-row">
                                <span class="comparison-stat-label">端口速率</span>
                                <span class="comparison-stat-value">全部 400G</span>
                            </div>
                            <div class="comparison-stat-row">
                                <span class="comparison-stat-label">Pod 结构</span>
                                <span class="comparison-stat-value">32L + 32S (对称)</span>
                            </div>
                            <div class="comparison-stat-row">
                                <span class="comparison-stat-label">每 SU 服务器</span>
                                <span class="comparison-stat-value">32 台</span>
                            </div>
                            <div class="comparison-stat-row">
                                <span class="comparison-stat-label">两层最大</span>
                                <span class="comparison-stat-value">256 台</span>
                            </div>
                            <div class="comparison-stat-row">
                                <span class="comparison-stat-label">三层最大</span>
                                <span class="comparison-stat-value">8,192 台</span>
                            </div>
                        </div>

                        <div class="comparison-card q3400">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Q3400 降速</div>
                                    <div class="card-subtitle">144 端口 800G 交换机 (降速使用)</div>
                                </div>
                            </div>
                            <div class="comparison-stat-row">
                                <span class="comparison-stat-label">端口配置</span>
                                <span class="comparison-stat-value">48↑ + 96↓</span>
                            </div>
                            <div class="comparison-stat-row">
                                <span class="comparison-stat-label">端口速率</span>
                                <span class="comparison-stat-value highlight">800G↑ + 400G↓</span>
                            </div>
                            <div class="comparison-stat-row">
                                <span class="comparison-stat-label">Pod 结构</span>
                                <span class="comparison-stat-value">72L + 48S (非对称)</span>
                            </div>
                            <div class="comparison-stat-row">
                                <span class="comparison-stat-label">每 SU 服务器</span>
                                <span class="comparison-stat-value highlight">96 台</span>
                            </div>
                            <div class="comparison-stat-row">
                                <span class="comparison-stat-label">两层最大</span>
                                <span class="comparison-stat-value highlight">1,728 台</span>
                            </div>
                            <div class="comparison-stat-row">
                                <span class="comparison-stat-label">三层最大</span>
                                <span class="comparison-stat-value highlight">124,416 台</span>
                            </div>
                        </div>
                    </div>

                    <!-- Conclusion -->
                    <div class="two-tier-info" style="background: rgba(0, 212, 255, 0.1); border-color: rgba(0, 212, 255, 0.3);">
                        <p style="color: #00d4ff; font-size: 1.1em;"><strong>结论: Q3400 降速方案优势明显</strong></p>
                        <p style="color: #aaa; margin-top: 10px;">
                            对于 ${numServers.toLocaleString()} 台服务器规模:
                        </p>
                        <p style="color: #00ff88; margin-top: 5px;">
                            • 交换机节省 <strong>${totalSavedPct}%</strong> (${totalSaved.toLocaleString()} 台)
                        </p>
                        <p style="color: #00ff88;">
                            • 每 SU 密度提升 <strong>3 倍</strong> (96 vs 32)
                        </p>
                        ${qm9790.superPods > 0 ? `
                        <p style="color: #00ff88;">
                            • 每 SuperPOD 容量提升 <strong>${(q3400.serversPerSuperPod / qm9790.serversPerSuperPod).toFixed(1)} 倍</strong> (${q3400.serversPerSuperPod} vs ${qm9790.serversPerSuperPod})
                        </p>
                        ` : ''}
                        <p style="color: #aaa; margin-top: 10px;">
                            • 上行带宽 800G，为未来全速升级预留空间
                        </p>
                        <p style="color: #aaa;">
                            • 大幅减少机柜、功耗、布线复杂度
                        </p>
                    </div>
                </div>
            `;
        }

        // ========== SuperPOD Helper Functions ==========

        function generateCoreNodesSuperPod(numCGs, coresPerCG) {
            let html = '';
            const totalCores = numCGs * coresPerCG;

            if (coresPerCG <= 4) {
                html += `<div class="device-node core" style="min-width: 180px;">`;
                html += `<div>Core 矩阵</div>`;
                html += `<div class="count">${numCGs} CG × ${coresPerCG} Core = ${totalCores} 台</div>`;
                html += `</div>`;

                html += `<div style="display: flex; gap: 5px; margin-left: 20px;">`;
                for (let c = 0; c < Math.min(coresPerCG, 3); c++) {
                    html += `
                        <div style="display: flex; flex-direction: column; gap: 3px;">
                            <div class="device-node core" style="min-width: 80px; padding: 6px 8px; font-size: 0.7em;">CG1-Core${c+1}</div>
                            <div class="device-node core" style="min-width: 80px; padding: 6px 8px; font-size: 0.7em;">CG2-Core${c+1}</div>
                            <div style="color: #666; text-align: center; font-size: 0.7em;">⋮</div>
                            <div class="device-node core" style="min-width: 80px; padding: 6px 8px; font-size: 0.7em;">CG${numCGs}-Core${c+1}</div>
                        </div>
                    `;
                }
                if (coresPerCG > 3) {
                    html += `<div class="ellipsis-node">...</div>`;
                    html += `
                        <div style="display: flex; flex-direction: column; gap: 3px;">
                            <div class="device-node core" style="min-width: 80px; padding: 6px 8px; font-size: 0.7em;">CG1-Core${coresPerCG}</div>
                            <div style="color: #666; text-align: center; font-size: 0.7em;">⋮</div>
                            <div class="device-node core" style="min-width: 80px; padding: 6px 8px; font-size: 0.7em;">CG${numCGs}-Core${coresPerCG}</div>
                        </div>
                    `;
                }
                html += `</div>`;
            } else {
                html += `<div class="device-node core" style="min-width: 220px;">`;
                html += `<div>Core 矩阵</div>`;
                html += `<div class="count">${numCGs} CG × ${coresPerCG} Core = ${totalCores} 台</div>`;
                html += `</div>`;

                html += `<div style="display: flex; gap: 5px; margin-left: 20px; align-items: center;">`;
                for (let c = 0; c < 2; c++) {
                    html += `
                        <div style="display: flex; flex-direction: column; gap: 2px;">
                            <div class="device-node core" style="min-width: 75px; padding: 5px; font-size: 0.65em;">CG1-Core${c+1}</div>
                            <div style="color: #666; text-align: center; font-size: 0.6em;">⋮</div>
                            <div class="device-node core" style="min-width: 75px; padding: 5px; font-size: 0.65em;">CG${numCGs}-Core${c+1}</div>
                        </div>
                    `;
                }
                html += `<div class="ellipsis-node">...</div>`;
                html += `
                    <div style="display: flex; flex-direction: column; gap: 2px;">
                        <div class="device-node core" style="min-width: 75px; padding: 5px; font-size: 0.65em;">CG1-Core${coresPerCG}</div>
                        <div style="color: #666; text-align: center; font-size: 0.6em;">⋮</div>
                        <div class="device-node core" style="min-width: 75px; padding: 5px; font-size: 0.65em;">CG${numCGs}-Core${coresPerCG}</div>
                    </div>
                `;
                html += `</div>`;
            }

            return html;
        }

        function generateSuperPodBoxes(numSuperPods, spinesPerSuperPod, leafsPerSuperPod, susPerSuperPod) {
            const maxShow = 4;
            let html = '';

            const showCount = Math.min(numSuperPods, maxShow);
            const showEllipsis = numSuperPods > maxShow;

            for (let i = 0; i < (showEllipsis ? 2 : showCount); i++) {
                html += generateSingleSuperPodBox(i + 1, spinesPerSuperPod, leafsPerSuperPod, susPerSuperPod);
            }

            if (showEllipsis) {
                html += `<div class="ellipsis-node" style="padding: 40px 20px;">...</div>`;
                html += generateSingleSuperPodBox(numSuperPods, spinesPerSuperPod, leafsPerSuperPod, susPerSuperPod);
            }

            return html;
        }

        function generateSingleSuperPodBox(superPodNum, spinesPerSuperPod, leafsPerSuperPod, susPerSuperPod) {
            const serversPerSU = leafsPerSuperPod === 72 ? 72 : (leafsPerSuperPod === 32 ? 32 : 96);
            const serversPerSuperPod = susPerSuperPod * serversPerSU;
            return `
                <div class="pod-box">
                    <div class="pod-title">SuperPOD ${superPodNum}</div>
                    <div class="pod-content">
                        <!-- Spine 层 -->
                        <div class="pod-layer">
                            <div class="mini-node spine">Spine1</div>
                            <div class="mini-node spine">Spine2</div>
                            <div style="color: #666; font-size: 0.7em;">...</div>
                            <div class="mini-node spine">Spine${spinesPerSuperPod}</div>
                        </div>

                        <!-- Spine-Leaf 连接示意 (SVG) -->
                        <div class="connection-visual">
                            <svg width="100%" height="40" viewBox="0 0 200 40" preserveAspectRatio="xMidYMid meet">
                                <!-- 全连接示意线 -->
                                <line x1="30" y1="5" x2="30" y2="35" stroke="#22d3ee" stroke-width="1" opacity="0.4"/>
                                <line x1="30" y1="5" x2="85" y2="35" stroke="#22d3ee" stroke-width="1" opacity="0.3"/>
                                <line x1="30" y1="5" x2="170" y2="35" stroke="#22d3ee" stroke-width="1" opacity="0.2"/>
                                <line x1="85" y1="5" x2="30" y2="35" stroke="#22d3ee" stroke-width="1" opacity="0.3"/>
                                <line x1="85" y1="5" x2="85" y2="35" stroke="#22d3ee" stroke-width="1" opacity="0.4"/>
                                <line x1="85" y1="5" x2="170" y2="35" stroke="#22d3ee" stroke-width="1" opacity="0.3"/>
                                <line x1="170" y1="5" x2="30" y2="35" stroke="#22d3ee" stroke-width="1" opacity="0.2"/>
                                <line x1="170" y1="5" x2="85" y2="35" stroke="#22d3ee" stroke-width="1" opacity="0.3"/>
                                <line x1="170" y1="5" x2="170" y2="35" stroke="#22d3ee" stroke-width="1" opacity="0.4"/>
                                <!-- 中心标签 -->
                                <text x="100" y="24" text-anchor="middle" fill="#888" font-size="9">全连接 ${spinesPerSuperPod}x${leafsPerSuperPod}</text>
                            </svg>
                        </div>

                        <!-- Leaf 层 -->
                        <div class="pod-layer">
                            <div class="mini-node leaf">Leaf1~8</div>
                            <div class="mini-node leaf">Leaf9~16</div>
                            <div style="color: #666; font-size: 0.7em;">...</div>
                            <div class="mini-node leaf">L${leafsPerSuperPod-7}~${leafsPerSuperPod}</div>
                        </div>

                        <!-- Leaf-GPU 连接示意 -->
                        <div class="connection-visual">
                            <svg width="100%" height="30" viewBox="0 0 200 30" preserveAspectRatio="xMidYMid meet">
                                <line x1="30" y1="5" x2="50" y2="25" stroke="#4ade80" stroke-width="1" opacity="0.5"/>
                                <line x1="85" y1="5" x2="100" y2="25" stroke="#4ade80" stroke-width="1" opacity="0.5"/>
                                <line x1="170" y1="5" x2="150" y2="25" stroke="#4ade80" stroke-width="1" opacity="0.5"/>
                                <text x="100" y="18" text-anchor="middle" fill="#888" font-size="9">8 HCA/GPU</text>
                            </svg>
                        </div>

                        <!-- GPU 层 -->
                        <div class="pod-layer" style="gap: 4px;">
                            <div class="mini-node gpu" style="padding: 4px 8px; min-width: 45px; font-size: 0.65em;">GPU1~${serversPerSU}</div>
                            <div style="color: #666; font-size: 0.6em;">...</div>
                            <div class="mini-node gpu" style="padding: 4px 8px; min-width: 45px; font-size: 0.65em;">GPU${(susPerSuperPod-1)*serversPerSU+1}~${serversPerSuperPod}</div>
                        </div>

                        <!-- 底部统计 -->
                        <div style="text-align: center; color: #888; font-size: 0.7em; margin-top: 5px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 8px;">
                            <span style="color: #22d3ee;">SG${superPodNum}</span> |
                            <span style="color: #4ade80;">LG${superPodNum}</span> |
                            <span style="color: #facc15;">${serversPerSuperPod} GPU</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateAsymmetricSuperPodBoxes(numSuperPods, spinesPerSuperPod, leafsPerSuperPod, susPerSuperPod) {
            const maxShow = 4;
            let html = '';
            const serversPerSU = 96; // 400G 降速方案
            const serversPerSuperPod = susPerSuperPod * serversPerSU;

            const showCount = Math.min(numSuperPods, maxShow);
            const showEllipsis = numSuperPods > maxShow;

            function generateAsymmetricSuperPodContent(spNum) {
                return `
                    <div class="pod-box">
                        <div class="pod-title">SuperPOD ${spNum}</div>
                        <div class="pod-content">
                            <!-- Spine 层 -->
                            <div class="pod-layer">
                                <div class="mini-node spine">Spine1</div>
                                <div class="mini-node spine">Spine2</div>
                                <div style="color: #666; font-size: 0.7em;">...</div>
                                <div class="mini-node spine">Spine${spinesPerSuperPod}</div>
                            </div>

                            <!-- Spine-Leaf 连接示意 (非对称) -->
                            <div class="connection-visual">
                                <svg width="100%" height="40" viewBox="0 0 200 40" preserveAspectRatio="xMidYMid meet">
                                    <line x1="30" y1="5" x2="25" y2="35" stroke="#22d3ee" stroke-width="1" opacity="0.4"/>
                                    <line x1="30" y1="5" x2="100" y2="35" stroke="#22d3ee" stroke-width="1" opacity="0.3"/>
                                    <line x1="30" y1="5" x2="175" y2="35" stroke="#22d3ee" stroke-width="1" opacity="0.2"/>
                                    <line x1="170" y1="5" x2="25" y2="35" stroke="#22d3ee" stroke-width="1" opacity="0.2"/>
                                    <line x1="170" y1="5" x2="100" y2="35" stroke="#22d3ee" stroke-width="1" opacity="0.3"/>
                                    <line x1="170" y1="5" x2="175" y2="35" stroke="#22d3ee" stroke-width="1" opacity="0.4"/>
                                    <text x="100" y="24" text-anchor="middle" fill="#888" font-size="9">${spinesPerSuperPod}:${leafsPerSuperPod} 非对称</text>
                                </svg>
                            </div>

                            <!-- Leaf 层 -->
                            <div class="pod-layer">
                                <div class="mini-node leaf">Leaf1~8</div>
                                <div class="mini-node leaf">Leaf9~16</div>
                                <div style="color: #666; font-size: 0.7em;">...</div>
                                <div class="mini-node leaf">L${leafsPerSuperPod-7}~${leafsPerSuperPod}</div>
                            </div>

                            <!-- Leaf-GPU 连接示意 -->
                            <div class="connection-visual">
                                <svg width="100%" height="30" viewBox="0 0 200 30" preserveAspectRatio="xMidYMid meet">
                                    <line x1="30" y1="5" x2="50" y2="25" stroke="#4ade80" stroke-width="1" opacity="0.5"/>
                                    <line x1="100" y1="5" x2="100" y2="25" stroke="#4ade80" stroke-width="1" opacity="0.5"/>
                                    <line x1="170" y1="5" x2="150" y2="25" stroke="#4ade80" stroke-width="1" opacity="0.5"/>
                                    <text x="100" y="18" text-anchor="middle" fill="#888" font-size="9">8 HCA/GPU</text>
                                </svg>
                            </div>

                            <!-- GPU 层 -->
                            <div class="pod-layer" style="gap: 4px;">
                                <div class="mini-node gpu" style="padding: 4px 8px; min-width: 45px; font-size: 0.65em;">GPU1~${serversPerSU}</div>
                                <div style="color: #666; font-size: 0.6em;">...</div>
                                <div class="mini-node gpu" style="padding: 4px 8px; min-width: 45px; font-size: 0.65em;">GPU${(susPerSuperPod-1)*serversPerSU+1}~${serversPerSuperPod}</div>
                            </div>

                            <!-- 底部统计 -->
                            <div style="text-align: center; color: #888; font-size: 0.7em; margin-top: 5px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 8px;">
                                <span style="color: #22d3ee;">SG${spNum}</span> |
                                <span style="color: #4ade80;">LG${spNum}</span> |
                                <span style="color: #facc15;">${serversPerSuperPod} GPU</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            for (let i = 0; i < (showEllipsis ? 2 : showCount); i++) {
                html += generateAsymmetricSuperPodContent(i + 1);
            }

            if (showEllipsis) {
                html += `<div class="ellipsis-node" style="padding: 40px 20px;">...</div>`;
                html += generateAsymmetricSuperPodContent(numSuperPods);
            }

            return html;
        }

        function generateGPUSummarySuperPod(numSUs, numServers, numSuperPods, susPerSuperPod) {
            let html = '';
            const maxShow = 4;
            const showEllipsis = numSuperPods > maxShow;

            for (let p = 0; p < (showEllipsis ? 2 : Math.min(numSuperPods, maxShow)); p++) {
                const suStart = p * susPerSuperPod + 1;
                const suEnd = (p + 1) * susPerSuperPod;
                html += `
                    <div class="device-node gpu">
                        SP${p+1} GPU
                        <div class="count">SU${suStart}~${suEnd}</div>
                    </div>
                `;
            }

            if (showEllipsis) {
                html += `<div class="ellipsis-node">...</div>`;
                const suStart = (numSuperPods - 1) * susPerSuperPod + 1;
                const suEnd = numSuperPods * susPerSuperPod;
                html += `
                    <div class="device-node gpu">
                        SP${numSuperPods} GPU
                        <div class="count">SU${suStart}~${suEnd}</div>
                    </div>
                `;
            }

            return html;
        }

        function generateCoreMatrixSuperPod(numCGs, coresPerCG) {
            const maxCGsToShow = 6;
            const maxCoresPerCGToShow = 8;

            let html = '<div class="core-matrix">';

            // Header row (CSS padding-left handles the row label space)
            html += '<div class="core-matrix-header">';
            for (let core = 0; core < Math.min(coresPerCG, maxCoresPerCGToShow); core++) {
                html += `<span>Core${core + 1}</span>`;
            }
            if (coresPerCG > maxCoresPerCGToShow) {
                html += '<span>...</span>';
                html += `<span>Core${coresPerCG}</span>`;
            }
            html += '</div>';

            // CG rows
            const cgsToShow = Math.min(numCGs, maxCGsToShow);
            for (let cg = 0; cg < cgsToShow; cg++) {
                html += '<div class="core-matrix-row">';
                html += `<span class="core-matrix-row-label">CG${cg + 1}</span>`;

                for (let core = 0; core < Math.min(coresPerCG, maxCoresPerCGToShow); core++) {
                    html += `<div class="core-cell" title="CG${cg+1} 连接所有 SuperPOD 的 Spine${cg+1}">CG${cg + 1}-Core${core + 1}</div>`;
                }
                if (coresPerCG > maxCoresPerCGToShow) {
                    html += '<span class="core-ellipsis">...</span>';
                    html += `<div class="core-cell">CG${cg + 1}-Core${coresPerCG}</div>`;
                }
                html += '</div>';
            }

            if (numCGs > maxCGsToShow) {
                html += '<div class="core-matrix-row">';
                html += '<span class="core-matrix-row-label">...</span>';
                for (let core = 0; core < Math.min(coresPerCG, maxCoresPerCGToShow); core++) {
                    html += '<span class="core-ellipsis">⋮</span>';
                }
                if (coresPerCG > maxCoresPerCGToShow) {
                    html += '<span class="core-ellipsis"></span>';
                    html += '<span class="core-ellipsis">⋮</span>';
                }
                html += '</div>';

                html += '<div class="core-matrix-row">';
                html += `<span class="core-matrix-row-label">CG${numCGs}</span>`;
                for (let core = 0; core < Math.min(coresPerCG, maxCoresPerCGToShow); core++) {
                    html += `<div class="core-cell">CG${numCGs}-Core${core + 1}</div>`;
                }
                if (coresPerCG > maxCoresPerCGToShow) {
                    html += '<span class="core-ellipsis">...</span>';
                    html += `<div class="core-cell">CG${numCGs}-Core${coresPerCG}</div>`;
                }
                html += '</div>';
            }

            html += '</div>';
            return html;
        }

        function generateSpineToCoreConnectionsSuperPod(coresPerCG, cablesPerCore, spinesPerSuperPod) {
            let html = '';
            const maxToShow = Math.min(coresPerCG, 4);

            for (let core = 0; core < maxToShow; core++) {
                const startPort = core * cablesPerCore + 1;
                const endPort = (core + 1) * cablesPerCore;
                html += `
                    <div class="connection-line">
                        <span class="port-range">端口 ${startPort}~${endPort}</span>
                        <span class="connection-arrow">→</span>
                        <span class="core-name">CG1-Core${core + 1}</span>
                        <span style="color: #666; margin-left: 10px;">(Core 端口 1~${cablesPerCore})</span>
                    </div>
                `;
            }

            if (coresPerCG > 4) {
                html += '<div class="connection-line" style="color: #666;">...</div>';
                const startPort = (coresPerCG - 1) * cablesPerCore + 1;
                html += `
                    <div class="connection-line">
                        <span class="port-range">端口 ${startPort}~${spinesPerSuperPod}</span>
                        <span class="connection-arrow">→</span>
                        <span class="core-name">CG1-Core${coresPerCG}</span>
                        <span style="color: #666; margin-left: 10px;">(Core 端口 1~${cablesPerCore})</span>
                    </div>
                `;
            }

            return html;
        }

        function generateCoreToSpineConnectionsSuperPod(numSuperPods, cablesPerCore) {
            let html = '';
            const maxToShow = Math.min(numSuperPods, 4);

            for (let sp = 0; sp < maxToShow; sp++) {
                const startPort = sp * cablesPerCore + 1;
                const endPort = (sp + 1) * cablesPerCore;
                html += `
                    <div class="connection-line">
                        <span class="port-range">端口 ${startPort}~${endPort}</span>
                        <span class="connection-arrow">←</span>
                        <span class="device-name">SG${sp + 1}-Spine1</span>
                    </div>
                `;
            }

            if (numSuperPods > 4) {
                html += '<div class="connection-line" style="color: #666;">...</div>';
                const startPort = (numSuperPods - 1) * cablesPerCore + 1;
                const endPort = numSuperPods * cablesPerCore;
                html += `
                    <div class="connection-line">
                        <span class="port-range">端口 ${startPort}~${endPort}</span>
                        <span class="connection-arrow">←</span>
                        <span class="device-name">SG${numSuperPods}-Spine1</span>
                    </div>
                `;
            }

            return html;
        }

        function generateSuperPodLGList(susPerSuperPod, leafsPerSuperPod) {
            let html = '';
            const maxToShow = Math.min(susPerSuperPod, 4);

            for (let i = 0; i < maxToShow; i++) {
                const leafStart = i * 8 + 1;
                const leafEnd = (i + 1) * 8;
                html += `
                    <div class="pod-item">
                        <span class="icon lg"></span>
                        <span>LG${i + 1}: Leaf${leafStart}~${leafEnd} → SU${i + 1}</span>
                    </div>
                `;
            }

            if (susPerSuperPod > 4) {
                html += '<div class="pod-item" style="color: #666;">...</div>';
                const leafStart = leafsPerSuperPod - 7;
                html += `
                    <div class="pod-item">
                        <span class="icon lg"></span>
                        <span>LG${susPerSuperPod}: Leaf${leafStart}~${leafsPerSuperPod} → SU${susPerSuperPod}</span>
                    </div>
                `;
            }

            return html;
        }

        function generateSUDistributionSuperPod(numSuperPods, susPerSuperPod) {
            let html = '';
            const maxToShow = Math.min(numSuperPods, 5);

            for (let sp = 0; sp < maxToShow; sp++) {
                const suStart = sp * susPerSuperPod + 1;
                const suEnd = (sp + 1) * susPerSuperPod;
                html += `
                    <div class="su-row">
                        <span class="pod-label">SuperPOD${sp + 1}</span>
                        <span class="su-range">SU${suStart} ~ SU${suEnd}</span>
                    </div>
                `;
            }

            if (numSuperPods > 5) {
                html += '<div class="su-row" style="color: #666;"><span>...</span></div>';
                const suStart = (numSuperPods - 1) * susPerSuperPod + 1;
                const suEnd = numSuperPods * susPerSuperPod;
                html += `
                    <div class="su-row">
                        <span class="pod-label">SuperPOD${numSuperPods}</span>
                        <span class="su-range">SU${suStart} ~ SU${suEnd}</span>
                    </div>
                `;
            }

            return html;
        }

        // ========== Legacy Pod Functions (kept for compatibility) ==========

        function generateAsymmetricPodBoxes(numPods, spinesPerPod, leavesPerPod, lgsPerPod) {
            const maxShow = 4;
            let html = '';

            const showCount = Math.min(numPods, maxShow);
            const showEllipsis = numPods > maxShow;

            for (let i = 0; i < (showEllipsis ? 2 : showCount); i++) {
                html += `
                    <div class="pod-box">
                        <div class="pod-title">Pod ${i + 1}</div>
                        <div class="pod-content">
                            <div class="pod-layer">
                                <div class="mini-node spine">Spine1</div>
                                <div class="mini-node spine">Spine2</div>
                                <div style="color: #666; font-size: 0.7em;">...</div>
                                <div class="mini-node spine">Spine${spinesPerPod}</div>
                            </div>
                            <div style="text-align: center; color: #666; font-size: 0.7em;">↕ ${leavesPerPod}:${spinesPerPod} 非对称连接</div>
                            <div class="pod-layer">
                                <div class="mini-node leaf">Leaf1~8</div>
                                <div class="mini-node leaf">Leaf9~16</div>
                                <div style="color: #666; font-size: 0.7em;">...</div>
                                <div class="mini-node leaf">L${leavesPerPod-7}~${leavesPerPod}</div>
                            </div>
                            <div style="text-align: center; color: #888; font-size: 0.75em; margin-top: 5px;">
                                ${lgsPerPod} LG = ${lgsPerPod} SU
                            </div>
                        </div>
                    </div>
                `;
            }

            if (showEllipsis) {
                html += `<div class="ellipsis-node" style="padding: 40px 20px;">...</div>`;
                html += `
                    <div class="pod-box">
                        <div class="pod-title">Pod ${numPods}</div>
                        <div class="pod-content">
                            <div class="pod-layer">
                                <div class="mini-node spine">Spine1</div>
                                <div class="mini-node spine">Spine2</div>
                                <div style="color: #666; font-size: 0.7em;">...</div>
                                <div class="mini-node spine">Spine${spinesPerPod}</div>
                            </div>
                            <div style="text-align: center; color: #666; font-size: 0.7em;">↕ ${leavesPerPod}:${spinesPerPod} 非对称连接</div>
                            <div class="pod-layer">
                                <div class="mini-node leaf">Leaf1~8</div>
                                <div class="mini-node leaf">Leaf9~16</div>
                                <div style="color: #666; font-size: 0.7em;">...</div>
                                <div class="mini-node leaf">L${leavesPerPod-7}~${leavesPerPod}</div>
                            </div>
                            <div style="text-align: center; color: #888; font-size: 0.75em; margin-top: 5px;">
                                ${lgsPerPod} LG = ${lgsPerPod} SU
                            </div>
                        </div>
                    </div>
                `;
            }

            return html;
        }

        function generateSpineNodes(numSpines) {
            const maxShow = 8;
            let html = '';

            if (numSpines <= maxShow) {
                for (let i = 0; i < numSpines; i++) {
                    html += `<div class="device-node spine">Spine${i+1}</div>`;
                }
            } else {
                for (let i = 0; i < 4; i++) {
                    html += `<div class="device-node spine">Spine${i+1}</div>`;
                }
                html += `<div class="ellipsis-node">...</div>`;
                for (let i = numSpines - 2; i < numSpines; i++) {
                    html += `<div class="device-node spine">Spine${i+1}</div>`;
                }
            }

            return html;
        }

        function generateLGBoxes(numSUs) {
            const maxShow = 6;
            let html = '';

            const showCount = Math.min(numSUs, maxShow);
            const showEllipsis = numSUs > maxShow;

            for (let i = 0; i < (showEllipsis ? 3 : showCount); i++) {
                html += `
                    <div class="pod-box" style="min-width: 120px; padding: 15px;">
                        <div class="pod-title">LG${i+1}</div>
                        <div class="pod-content" style="margin-top: 5px;">
                            <div style="font-size: 0.8em; color: #4ecdc4;">Leaf1~8</div>
                            <div style="font-size: 0.75em; color: #888;">→ SU${i+1}</div>
                        </div>
                    </div>
                `;
            }

            if (showEllipsis) {
                html += `<div class="ellipsis-node">...</div>`;
                html += `
                    <div class="pod-box" style="min-width: 120px; padding: 15px;">
                        <div class="pod-title">LG${numSUs}</div>
                        <div class="pod-content" style="margin-top: 5px;">
                            <div style="font-size: 0.8em; color: #4ecdc4;">Leaf1~8</div>
                            <div style="font-size: 0.75em; color: #888;">→ SU${numSUs}</div>
                        </div>
                    </div>
                `;
            }

            return html;
        }

        function generateSUNodes(numSUs, numServers, serversPerSU) {
            const maxShow = 6;
            let html = '';

            if (numSUs <= maxShow) {
                for (let i = 0; i < numSUs; i++) {
                    const gpuCount = Math.min(serversPerSU, numServers - i * serversPerSU);
                    html += `
                        <div class="device-node gpu">
                            SU${i+1}
                            <div class="count">${gpuCount} GPU</div>
                        </div>
                    `;
                }
            } else {
                for (let i = 0; i < 3; i++) {
                    html += `
                        <div class="device-node gpu">
                            SU${i+1}
                            <div class="count">${serversPerSU} GPU</div>
                        </div>
                    `;
                }
                html += `<div class="ellipsis-node">...</div>`;
                const lastGpuCount = numServers - (numSUs - 1) * serversPerSU;
                html += `
                    <div class="device-node gpu">
                        SU${numSUs}
                        <div class="count">${lastGpuCount} GPU</div>
                    </div>
                `;
            }

            return html;
        }

        function generateCoreNodes(rows, cols) {
            let html = '';
            const totalCores = rows * cols;

            if (cols <= 4) {
                html += `<div class="device-node core" style="min-width: 180px;">`;
                html += `<div>Core 矩阵</div>`;
                html += `<div class="count">${rows} 行 × ${cols} 列 = ${totalCores} 台</div>`;
                html += `</div>`;

                html += `<div style="display: flex; gap: 5px; margin-left: 20px;">`;
                for (let c = 0; c < cols; c++) {
                    html += `
                        <div style="display: flex; flex-direction: column; gap: 3px;">
                            <div class="device-node core" style="min-width: 70px; padding: 6px 8px; font-size: 0.7em;">Core-1-${c+1}</div>
                            <div class="device-node core" style="min-width: 70px; padding: 6px 8px; font-size: 0.7em;">Core-2-${c+1}</div>
                            <div style="color: #666; text-align: center; font-size: 0.7em;">⋮</div>
                            <div class="device-node core" style="min-width: 70px; padding: 6px 8px; font-size: 0.7em;">Core-${rows}-${c+1}</div>
                        </div>
                    `;
                }
                html += `</div>`;
            } else {
                html += `<div class="device-node core" style="min-width: 220px;">`;
                html += `<div>Core 矩阵</div>`;
                html += `<div class="count">${rows} 行 × ${cols} 列 = ${totalCores} 台</div>`;
                html += `</div>`;

                html += `<div style="display: flex; gap: 5px; margin-left: 20px; align-items: center;">`;
                for (let c = 0; c < 2; c++) {
                    html += `
                        <div style="display: flex; flex-direction: column; gap: 2px;">
                            <div class="device-node core" style="min-width: 65px; padding: 5px; font-size: 0.65em;">Core-1-${c+1}</div>
                            <div style="color: #666; text-align: center; font-size: 0.6em;">⋮</div>
                            <div class="device-node core" style="min-width: 65px; padding: 5px; font-size: 0.65em;">Core-${rows}-${c+1}</div>
                        </div>
                    `;
                }
                html += `<div class="ellipsis-node">...</div>`;
                html += `
                    <div style="display: flex; flex-direction: column; gap: 2px;">
                        <div class="device-node core" style="min-width: 65px; padding: 5px; font-size: 0.65em;">Core-1-${cols}</div>
                        <div style="color: #666; text-align: center; font-size: 0.6em;">⋮</div>
                        <div class="device-node core" style="min-width: 65px; padding: 5px; font-size: 0.65em;">Core-${rows}-${cols}</div>
                    </div>
                `;
                html += `</div>`;
            }

            return html;
        }

        function generatePodBoxes(numPods, spinesPerPod, leavesPerPod, lgsPerPod) {
            const maxShow = 4;
            let html = '';

            const showCount = Math.min(numPods, maxShow);
            const showEllipsis = numPods > maxShow;

            for (let i = 0; i < (showEllipsis ? 2 : showCount); i++) {
                html += generateSinglePodBox(i + 1, spinesPerPod, leavesPerPod, lgsPerPod);
            }

            if (showEllipsis) {
                html += `<div class="ellipsis-node" style="padding: 40px 20px;">...</div>`;
                html += generateSinglePodBox(numPods, spinesPerPod, leavesPerPod, lgsPerPod);
            }

            return html;
        }

        function generateSinglePodBox(podNum, spinesPerPod, leavesPerPod, lgsPerPod) {
            return `
                <div class="pod-box">
                    <div class="pod-title">Pod ${podNum}</div>
                    <div class="pod-content">
                        <div class="pod-layer">
                            <div class="mini-node spine">Spine1</div>
                            <div class="mini-node spine">Spine2</div>
                            <div style="color: #666; font-size: 0.7em;">...</div>
                            <div class="mini-node spine">Spine${spinesPerPod}</div>
                        </div>
                        <div style="text-align: center; color: #666; font-size: 0.7em;">↕ Pod内全连接</div>
                        <div class="pod-layer">
                            <div class="mini-node leaf">Leaf1~8</div>
                            <div class="mini-node leaf">Leaf9~16</div>
                            <div style="color: #666; font-size: 0.7em;">...</div>
                            <div class="mini-node leaf">L${leavesPerPod-7}~${leavesPerPod}</div>
                        </div>
                        <div style="text-align: center; color: #888; font-size: 0.75em; margin-top: 5px;">
                            ${lgsPerPod} LG = ${lgsPerPod} SU
                        </div>
                    </div>
                </div>
            `;
        }

        function generateGPUSummary(numSUs, numServers, numPods, lgsPerPod) {
            let html = '';
            const maxShow = 4;
            const showEllipsis = numPods > maxShow;

            for (let p = 0; p < (showEllipsis ? 2 : Math.min(numPods, maxShow)); p++) {
                const suStart = p * lgsPerPod + 1;
                const suEnd = (p + 1) * lgsPerPod;
                html += `
                    <div class="device-node gpu">
                        Pod${p+1} GPU
                        <div class="count">SU${suStart}~${suEnd}</div>
                    </div>
                `;
            }

            if (showEllipsis) {
                html += `<div class="ellipsis-node">...</div>`;
                const suStart = (numPods - 1) * lgsPerPod + 1;
                const suEnd = numPods * lgsPerPod;
                html += `
                    <div class="device-node gpu">
                        Pod${numPods} GPU
                        <div class="count">SU${suStart}~${suEnd}</div>
                    </div>
                `;
            }

            return html;
        }

        function generateCoreMatrix(rows, cols) {
            const maxRowsToShow = 6;
            const maxColsToShow = 8;

            let html = '<div class="core-matrix">';

            html += '<div class="core-matrix-header">';
            for (let col = 0; col < Math.min(cols, maxColsToShow); col++) {
                html += `<span>列${col + 1}</span>`;
            }
            if (cols > maxColsToShow) {
                html += '<span>...</span>';
                html += `<span>列${cols}</span>`;
            }
            html += '</div>';

            const rowsToShow = Math.min(rows, maxRowsToShow);
            for (let row = 0; row < rowsToShow; row++) {
                html += '<div class="core-matrix-row">';
                html += `<span class="core-matrix-row-label">行${row + 1}</span>`;

                for (let col = 0; col < Math.min(cols, maxColsToShow); col++) {
                    html += `<div class="core-cell" title="连接所有Pod的Spine${row+1}">Core-${row + 1}-${col + 1}</div>`;
                }
                if (cols > maxColsToShow) {
                    html += '<span class="core-ellipsis">...</span>';
                    html += `<div class="core-cell">Core-${row + 1}-${cols}</div>`;
                }
                html += '</div>';
            }

            if (rows > maxRowsToShow) {
                html += '<div class="core-matrix-row">';
                html += '<span class="core-matrix-row-label">...</span>';
                for (let col = 0; col < Math.min(cols, maxColsToShow); col++) {
                    html += '<span class="core-ellipsis">⋮</span>';
                }
                if (cols > maxColsToShow) {
                    html += '<span class="core-ellipsis"></span>';
                    html += '<span class="core-ellipsis">⋮</span>';
                }
                html += '</div>';

                html += '<div class="core-matrix-row">';
                html += `<span class="core-matrix-row-label">行${rows}</span>`;
                for (let col = 0; col < Math.min(cols, maxColsToShow); col++) {
                    html += `<div class="core-cell">Core-${rows}-${col + 1}</div>`;
                }
                if (cols > maxColsToShow) {
                    html += '<span class="core-ellipsis">...</span>';
                    html += `<div class="core-cell">Core-${rows}-${cols}</div>`;
                }
                html += '</div>';
            }

            html += '</div>';
            return html;
        }

        function generateSpineToCoreConnections(coreCols, connectionsPerCore, halfK) {
            let html = '';
            const maxToShow = Math.min(coreCols, 4);

            for (let col = 0; col < maxToShow; col++) {
                const startPort = col * connectionsPerCore + 1;
                const endPort = (col + 1) * connectionsPerCore;
                html += `
                    <div class="connection-line">
                        <span class="port-range">端口 ${startPort}~${endPort}</span>
                        <span class="connection-arrow">→</span>
                        <span class="core-name">Core-1-${col + 1}</span>
                        <span style="color: #666; margin-left: 10px;">(Core 端口 1~${connectionsPerCore})</span>
                    </div>
                `;
            }

            if (coreCols > 4) {
                html += '<div class="connection-line" style="color: #666;">...</div>';
                const startPort = (coreCols - 1) * connectionsPerCore + 1;
                html += `
                    <div class="connection-line">
                        <span class="port-range">端口 ${startPort}~${halfK}</span>
                        <span class="connection-arrow">→</span>
                        <span class="core-name">Core-1-${coreCols}</span>
                        <span style="color: #666; margin-left: 10px;">(Core 端口 1~${connectionsPerCore})</span>
                    </div>
                `;
            }

            return html;
        }

        function generateCoreToSpineConnections(numPods, connectionsPerCore) {
            let html = '';
            const maxToShow = Math.min(numPods, 4);

            for (let pod = 0; pod < maxToShow; pod++) {
                const startPort = pod * connectionsPerCore + 1;
                const endPort = (pod + 1) * connectionsPerCore;
                html += `
                    <div class="connection-line">
                        <span class="port-range">端口 ${startPort}~${endPort}</span>
                        <span class="connection-arrow">←</span>
                        <span class="device-name">Pod${pod + 1}-Spine1</span>
                    </div>
                `;
            }

            if (numPods > 4) {
                html += '<div class="connection-line" style="color: #666;">...</div>';
                const startPort = (numPods - 1) * connectionsPerCore + 1;
                const endPort = numPods * connectionsPerCore;
                html += `
                    <div class="connection-line">
                        <span class="port-range">端口 ${startPort}~${endPort}</span>
                        <span class="connection-arrow">←</span>
                        <span class="device-name">Pod${numPods}-Spine1</span>
                    </div>
                `;
            }

            return html;
        }

        function generateLGList(numSUs) {
            let html = '';
            const maxToShow = Math.min(numSUs, 4);

            for (let i = 0; i < maxToShow; i++) {
                html += `
                    <div class="pod-item">
                        <span class="icon lg"></span>
                        <span>LG${i + 1}: Leaf1~8 → SU${i + 1}</span>
                    </div>
                `;
            }

            if (numSUs > 4) {
                html += '<div class="pod-item" style="color: #666;">...</div>';
                html += `
                    <div class="pod-item">
                        <span class="icon lg"></span>
                        <span>LG${numSUs}: Leaf1~8 → SU${numSUs}</span>
                    </div>
                `;
            }

            return html;
        }

        function generatePodLGList(lgsPerPod, leavesPerPod) {
            let html = '';
            const maxToShow = Math.min(lgsPerPod, 4);

            for (let i = 0; i < maxToShow; i++) {
                const leafStart = i * 8 + 1;
                const leafEnd = (i + 1) * 8;
                html += `
                    <div class="pod-item">
                        <span class="icon lg"></span>
                        <span>LG${i + 1}: Leaf${leafStart}~${leafEnd} → SU${i + 1}</span>
                    </div>
                `;
            }

            if (lgsPerPod > 4) {
                html += '<div class="pod-item" style="color: #666;">...</div>';
                const leafStart = leavesPerPod - 7;
                html += `
                    <div class="pod-item">
                        <span class="icon lg"></span>
                        <span>LG${lgsPerPod}: Leaf${leafStart}~${leavesPerPod} → SU${lgsPerPod}</span>
                    </div>
                `;
            }

            return html;
        }

        function generateSUDistribution(numPods, lgsPerPod) {
            let html = '';
            const maxToShow = Math.min(numPods, 5);

            for (let pod = 0; pod < maxToShow; pod++) {
                const suStart = pod * lgsPerPod + 1;
                const suEnd = (pod + 1) * lgsPerPod;
                html += `
                    <div class="su-row">
                        <span class="pod-label">Pod${pod + 1}</span>
                        <span class="su-range">SU${suStart} ~ SU${suEnd}</span>
                    </div>
                `;
            }

            if (numPods > 5) {
                html += '<div class="su-row" style="color: #666;"><span>...</span></div>';
                const suStart = (numPods - 1) * lgsPerPod + 1;
                const suEnd = numPods * lgsPerPod;
                html += `
                    <div class="su-row">
                        <span class="pod-label">Pod${numPods}</span>
                        <span class="su-range">SU${suStart} ~ SU${suEnd}</span>
                    </div>
                `;
            }

            return html;
        }

        // ========== D3.js Topology Visualization ==========

        function switchDiagramView(tabElement, containerId, viewId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const tabs = container.querySelectorAll('.diagram-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            tabElement.classList.add('active');

            const views = container.querySelectorAll('.diagram-view');
            views.forEach(view => view.classList.remove('active'));
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.add('active');
                if (viewId.includes('d3-view')) {
                    setTimeout(() => initD3Topology(viewId), 100);
                }
            }
        }

        function initD3Topology(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const svgContainer = container.querySelector('.d3-topology-container');
            if (!svgContainer) return;

            // Clear and re-render
            svgContainer.innerHTML = '';

            const topologyData = JSON.parse(container.dataset.topology || '{}');
            renderD3Topology(svgContainer, topologyData);
        }

        function renderD3Topology(container, data) {
            const width = container.clientWidth || 1000;
            const height = container.clientHeight || 560;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .style('background', 'linear-gradient(180deg, #0d0d12 0%, #1a1a24 100%)');

            const isThreeTier = data.isThreeTier;
            const numSuperPods = data.numSuperPods || 4;
            const numCGs = data.numCGs || 72;
            const coresPerCG = data.coresPerCG || 2;
            const spinesPerSP = data.spinesPerSuperPod || 72;
            const leafsPerSP = data.leafsPerSuperPod || 72;
            const serversPerSP = data.serversPerSuperPod || 648;

            // 颜色配置
            const C = {
                core: '#a855f7',
                spine: '#22d3ee',
                leaf: '#4ade80',
                gpu: '#facc15',
                line: '#86efac',
                boxBg: 'rgba(255,255,255,0.03)',
                boxBorder: 'rgba(255,255,255,0.12)',
                text: '#e5e5e5',
                textDim: '#888'
            };

            // 布局参数
            const margin = { top: 20, right: 20, bottom: 20, left: 20 };
            const cgAreaH = isThreeTier ? 90 : 0;
            const connAreaH = isThreeTier ? 50 : 0;
            const spAreaTop = margin.top + cgAreaH + connAreaH;
            const spAreaH = height - spAreaTop - margin.bottom;

            // 决定显示几个CG和SuperPOD
            const showSPCount = numSuperPods <= 4 ? numSuperPods : 2;
            const showCGCount = isThreeTier ? (numCGs <= 4 ? numCGs : 2) : 0;
            const spGap = 50;
            const cgGap = 40;

            // ============ 绘制 CG 区域 ============
            const cgBoxW = 160;
            const cgBoxH = 75;
            const cgPositions = [];

            if (isThreeTier) {
                const totalCGWidth = showCGCount * cgBoxW + (showCGCount > 1 ? cgGap : 0) + (numCGs > 2 ? 40 : 0);
                const cgStartX = (width - totalCGWidth) / 2;

                for (let i = 0; i < showCGCount; i++) {
                    const isLast = (numCGs > 2 && i === showCGCount - 1);
                    const cgId = isLast ? numCGs : i + 1;
                    const xPos = i === 0 ? cgStartX : cgStartX + cgBoxW + cgGap + (numCGs > 2 ? 40 : 0);

                    cgPositions.push({ x: xPos, y: margin.top, id: cgId });
                    drawCGBox(svg, xPos, margin.top, cgBoxW, cgBoxH, cgId, coresPerCG, C);
                }

                // CG 省略号
                if (numCGs > 2) {
                    svg.append('text')
                        .attr('x', cgPositions[0].x + cgBoxW + cgGap / 2 + 20)
                        .attr('y', margin.top + cgBoxH / 2 + 5)
                        .attr('text-anchor', 'middle')
                        .attr('fill', C.textDim)
                        .attr('font-size', '24px')
                        .text('···');
                }
            }

            // ============ 绘制 SuperPOD 区域 ============
            const spPositions = [];

            if (numSuperPods <= 4) {
                // 显示所有 SuperPOD（最多4个）
                const totalGaps = (showSPCount - 1) * spGap;
                const spBoxW = (width - margin.left - margin.right - totalGaps) / showSPCount;

                for (let i = 0; i < showSPCount; i++) {
                    const spId = i + 1;
                    const xPos = margin.left + i * (spBoxW + spGap);

                    spPositions.push({ x: xPos, y: spAreaTop, id: spId, w: spBoxW });
                    drawSuperPodBox(svg, xPos, spAreaTop, spBoxW, spAreaH, spId, spinesPerSP, leafsPerSP, serversPerSP, numSuperPods, C);
                }
            } else {
                // 只显示第一个和最后一个 SuperPOD，中间用省略号
                const ellipsisWidth = 50;
                const spBoxW = (width - margin.left - margin.right - spGap - ellipsisWidth) / 2;

                // 第一个 SuperPOD
                spPositions.push({ x: margin.left, y: spAreaTop, id: 1, w: spBoxW });
                drawSuperPodBox(svg, margin.left, spAreaTop, spBoxW, spAreaH, 1, spinesPerSP, leafsPerSP, serversPerSP, numSuperPods, C);

                // 省略号
                svg.append('text')
                    .attr('x', width / 2)
                    .attr('y', spAreaTop + spAreaH / 2)
                    .attr('text-anchor', 'middle')
                    .attr('fill', C.textDim)
                    .attr('font-size', '28px')
                    .text('···');

                // 最后一个 SuperPOD
                const lastX = width - margin.right - spBoxW;
                spPositions.push({ x: lastX, y: spAreaTop, id: numSuperPods, w: spBoxW });
                drawSuperPodBox(svg, lastX, spAreaTop, spBoxW, spAreaH, numSuperPods, spinesPerSP, leafsPerSP, serversPerSP, numSuperPods, C);
            }

            // ============ 绘制连接线 (CG → SuperPOD) ============
            if (isThreeTier && cgPositions.length > 0 && spPositions.length > 0) {
                drawConnections(svg, cgPositions, spPositions, cgBoxW, cgBoxH, coresPerCG, spAreaTop, C, numCGs, spinesPerSP);
            }
        }

        // 绘制 CG 框
        function drawCGBox(svg, x, y, w, h, cgId, coresPerCG, C) {
            const g = svg.append('g');

            // 背景框
            g.append('rect')
                .attr('x', x).attr('y', y)
                .attr('width', w).attr('height', h)
                .attr('rx', 8)
                .attr('fill', 'rgba(168,85,247,0.08)')
                .attr('stroke', C.core)
                .attr('stroke-width', 1.5);

            // 标签
            g.append('text')
                .attr('x', x + 8).attr('y', y + 16)
                .attr('fill', C.core)
                .attr('font-family', 'Orbitron, sans-serif')
                .attr('font-weight', '600')
                .attr('font-size', '11px')
                .text(`CG${cgId}`);

            // Core 节点 - 使用方框风格（与 Spine/Leaf 统一）
            const coreY = y + h / 2 + 8;
            const nodeW = 55;
            const nodeH = 24;
            const showCores = coresPerCG > 3 ? 2 : coresPerCG;
            const hasEllipsis = coresPerCG > 3;

            if (hasEllipsis) {
                // 显示 Core1, ..., CoreN
                const positions = [x + w * 0.2, x + w * 0.5, x + w * 0.8];
                drawCoreNode(g, positions[0] - nodeW/2, coreY - nodeH/2, nodeW, nodeH, 'Core1', C);
                g.append('text')
                    .attr('x', positions[1]).attr('y', coreY + 4)
                    .attr('text-anchor', 'middle')
                    .attr('fill', C.textDim)
                    .attr('font-size', '14px')
                    .text('···');
                drawCoreNode(g, positions[2] - nodeW/2, coreY - nodeH/2, nodeW, nodeH, `Core${coresPerCG}`, C);
            } else {
                const spacing = w / (showCores + 1);
                for (let i = 0; i < showCores; i++) {
                    const nx = x + spacing * (i + 1);
                    drawCoreNode(g, nx - nodeW/2, coreY - nodeH/2, nodeW, nodeH, `Core${i + 1}`, C);
                }
            }
        }

        // Core 节点 - 方框风格
        function drawCoreNode(g, x, y, w, h, label, C) {
            g.append('rect')
                .attr('x', x).attr('y', y)
                .attr('width', w).attr('height', h)
                .attr('rx', 4)
                .attr('fill', C.core + '40')
                .attr('stroke', C.core)
                .attr('stroke-width', 1);
            g.append('text')
                .attr('x', x + w / 2).attr('y', y + h / 2 + 5)
                .attr('text-anchor', 'middle')
                .attr('fill', C.text)
                .attr('font-size', '11px')
                .attr('font-weight', '500')
                .text(label);
        }

        // 绘制 SuperPOD 框 - 改进版
        function drawSuperPodBox(svg, x, y, w, h, spId, spinesPerSP, leafsPerSP, serversPerSP, totalSPs, C) {
            const g = svg.append('g');
            const pad = 15;
            const innerW = w - pad * 2;

            // 外框 - 渐变边框效果
            g.append('rect')
                .attr('x', x).attr('y', y)
                .attr('width', w).attr('height', h)
                .attr('rx', 12)
                .attr('fill', 'rgba(0,0,0,0.3)')
                .attr('stroke', 'url(#spGradient' + spId + ')')
                .attr('stroke-width', 2);

            // 定义渐变
            const defs = svg.append('defs');
            const gradient = defs.append('linearGradient')
                .attr('id', 'spGradient' + spId)
                .attr('x1', '0%').attr('y1', '0%')
                .attr('x2', '100%').attr('y2', '100%');
            gradient.append('stop').attr('offset', '0%').attr('stop-color', C.spine);
            gradient.append('stop').attr('offset', '50%').attr('stop-color', C.leaf);
            gradient.append('stop').attr('offset', '100%').attr('stop-color', C.gpu);

            // 动态布局计算 - 填满整个空间（标题移到底部）
            const topPad = 10;
            const contentH = h - topPad - pad;  // 可用内容高度
            // 比例分配: Spine层(22%) + 连接(13%) + Leaf层(22%) + 连接(13%) + GPU层(30%)
            const layerH = Math.max(45, contentH * 0.22);
            const connH = Math.max(28, contentH * 0.13);
            const gpuH = contentH - layerH * 2 - connH * 2;
            const startY = y + topPad;

            // ========== Spine 层 ==========
            const spineY = startY;
            drawLayerBox(g, x + pad, spineY, innerW, layerH, `SG${spId}`, 'Spine', spinesPerSP, C.spine, C);

            // ========== Spine-Leaf 连接线 (全连接示意) ==========
            const spineConnY = spineY + layerH;
            drawMeshConnection(g, x + pad, spineConnY, innerW, connH, C.spine, C.leaf, `${spinesPerSP}×${leafsPerSP} 全连接`);

            // ========== Leaf 层 ==========
            const leafY = spineConnY + connH;
            drawLayerBox(g, x + pad, leafY, innerW, layerH, `LG${spId}`, 'Leaf', leafsPerSP, C.leaf, C);

            // ========== Leaf-GPU 连接线 ==========
            const leafConnY = leafY + layerH;
            drawMeshConnection(g, x + pad, leafConnY, innerW, connH, C.leaf, C.gpu, '8 HCA/GPU');

            // ========== GPU 层 ==========
            const gpuY = leafConnY + connH;
            drawGPULayer(g, x + pad, gpuY, innerW, gpuH, spId, serversPerSP, C);
        }

        // 绘制层级框 (Spine/Leaf)
        function drawLayerBox(g, x, y, w, h, groupLabel, nodePrefix, count, color, C) {
            // 半透明背景
            g.append('rect')
                .attr('x', x).attr('y', y)
                .attr('width', w).attr('height', h)
                .attr('rx', 8)
                .attr('fill', color + '15')
                .attr('stroke', color)
                .attr('stroke-width', 1)
                .attr('stroke-opacity', 0.5);

            // 组标签
            g.append('text')
                .attr('x', x + 8).attr('y', y + 16)
                .attr('fill', color)
                .attr('font-family', 'Orbitron, sans-serif')
                .attr('font-weight', '600')
                .attr('font-size', '12px')
                .text(groupLabel);

            // 节点绘制
            const nodeY = y + h / 2 + 8;
            const nodeW = 55;
            const nodeH = 24;
            const showNodes = count > 4 ? 3 : Math.min(count, 4);
            const hasEllipsis = count > 4;

            if (hasEllipsis) {
                // 显示 Node1, ..., NodeN
                const positions = [
                    x + w * 0.15,
                    x + w * 0.5,
                    x + w * 0.85
                ];
                drawNodeRect(g, positions[0] - nodeW/2, nodeY - nodeH/2, nodeW, nodeH, `${nodePrefix}1`, color, C);
                g.append('text')
                    .attr('x', positions[1]).attr('y', nodeY + 4)
                    .attr('text-anchor', 'middle')
                    .attr('fill', C.textDim)
                    .attr('font-size', '14px')
                    .text('···');
                drawNodeRect(g, positions[2] - nodeW/2, nodeY - nodeH/2, nodeW, nodeH, `${nodePrefix}${count}`, color, C);
            } else {
                const spacing = w / (showNodes + 1);
                for (let i = 0; i < showNodes; i++) {
                    const nx = x + spacing * (i + 1);
                    drawNodeRect(g, nx - nodeW/2, nodeY - nodeH/2, nodeW, nodeH, `${nodePrefix}${i + 1}`, color, C);
                }
            }

            // 返回节点位置信息供连线使用
            return {
                leftX: x + w * 0.15,
                rightX: x + w * 0.85,
                centerX: x + w * 0.5,
                bottomY: y + h
            };
        }

        // 绘制节点矩形
        function drawNodeRect(g, x, y, w, h, label, color, C) {
            g.append('rect')
                .attr('x', x).attr('y', y)
                .attr('width', w).attr('height', h)
                .attr('rx', 4)
                .attr('fill', color + '40')
                .attr('stroke', color)
                .attr('stroke-width', 1);
            g.append('text')
                .attr('x', x + w / 2).attr('y', y + h / 2 + 5)
                .attr('text-anchor', 'middle')
                .attr('fill', C.text)
                .attr('font-size', '11px')
                .attr('font-weight', '500')
                .text(label);
        }

        // 绘制网格连接 (全连接示意)
        function drawMeshConnection(g, x, y, w, h, topColor, botColor, label) {
            const topNodes = [x + w * 0.15, x + w * 0.5, x + w * 0.85];
            const botNodes = [x + w * 0.15, x + w * 0.5, x + w * 0.85];

            // 先绘制斜线（底层），再绘制垂直线（顶层）
            // 第一遍：绘制所有斜线
            topNodes.forEach((tx, ti) => {
                botNodes.forEach((bx, bi) => {
                    const dist = Math.abs(ti - bi);
                    if (dist > 0) {  // 只绘制斜线
                        const opacity = dist === 1 ? 0.45 : 0.3;
                        // 混合颜色：相邻用顶部颜色，最远用底部颜色
                        const mixColor = dist === 1 ? topColor : botColor;
                        g.append('line')
                            .attr('x1', tx).attr('y1', y + 2)
                            .attr('x2', bx).attr('y2', y + h - 2)
                            .attr('stroke', mixColor)
                            .attr('stroke-width', 1)
                            .attr('stroke-opacity', opacity)
                            .attr('stroke-dasharray', dist > 1 ? '3,2' : 'none');
                    }
                });
            });

            // 第二遍：绘制垂直线（覆盖在斜线上方）
            topNodes.forEach((tx, ti) => {
                g.append('line')
                    .attr('x1', tx).attr('y1', y + 2)
                    .attr('x2', topNodes[ti]).attr('y2', y + h - 2)
                    .attr('stroke', topColor)
                    .attr('stroke-width', 1.5)
                    .attr('stroke-opacity', 0.6);
            });

            // 中心标签
            g.append('text')
                .attr('x', x + w / 2).attr('y', y + h / 2 + 3)
                .attr('text-anchor', 'middle')
                .attr('fill', '#888')
                .attr('font-size', '8px')
                .text(label);
        }

        // 绘制 GPU 层
        function drawGPULayer(g, x, y, w, h, spId, serversPerSP, C) {
            const gpuBoxW = 35;
            const gpuBoxH = 28;
            // 与 drawMeshConnection 的连线位置对齐 (0.15, 0.5, 0.85)
            const positions = [x + w * 0.15, x + w * 0.5, x + w * 0.85];

            positions.forEach((px, i) => {
                const gx = px - gpuBoxW / 2;
                const gy = y + 3;

                // GPU 服务器图标
                g.append('rect')
                    .attr('x', gx).attr('y', gy)
                    .attr('width', gpuBoxW).attr('height', gpuBoxH)
                    .attr('rx', 4)
                    .attr('fill', C.gpu + '25')
                    .attr('stroke', C.gpu)
                    .attr('stroke-width', 1);

                // GPU 芯片
                for (let j = 0; j < 4; j++) {
                    g.append('rect')
                        .attr('x', gx + 4 + j * 7.5).attr('y', gy + 5)
                        .attr('width', 5).attr('height', 18)
                        .attr('rx', 1)
                        .attr('fill', C.gpu + 'aa');
                }

                if (i === 1) {
                    g.append('text')
                        .attr('x', px).attr('y', gy - 3)
                        .attr('text-anchor', 'middle')
                        .attr('fill', C.textDim)
                        .attr('font-size', '8px')
                        .text('···');
                }
            });

            // SuperPOD 标题（在 GPU 图标下方，留出间距）
            const titleY = y + gpuBoxH + 38;
            g.append('text')
                .attr('x', x + w / 2).attr('y', titleY)
                .attr('text-anchor', 'middle')
                .attr('fill', C.text)
                .attr('font-family', 'Orbitron, sans-serif')
                .attr('font-weight', '700')
                .attr('font-size', '13px')
                .text(`SuperPOD ${spId}`);

            // 服务器范围（在标题下方）
            const startNode = (spId - 1) * serversPerSP + 1;
            const endNode = spId * serversPerSP;
            g.append('text')
                .attr('x', x + w / 2).attr('y', y + h - 5)
                .attr('text-anchor', 'middle')
                .attr('fill', C.gpu)
                .attr('font-size', '10px')
                .attr('font-weight', '500')
                .text(`GPU ${startNode} ~ ${endNode}`);
        }

        // CG → SuperPOD 连线
        // 正确规则: CG{Y} 只连接各 SuperPOD 的 Spine{Y}
        function drawConnections(svg, cgPositions, spPositions, cgBoxW, cgBoxH, coresPerCG, spAreaTop, C, numCGs, spinesPerSP) {
            const pad = 15;

            cgPositions.forEach((cg, cgIdx) => {
                // 计算 Core 节点位置 (与 drawCGBox 中的位置匹配)
                const coreCount = coresPerCG > 3 ? 2 : coresPerCG;
                const spacing = cgBoxW / (coresPerCG > 3 ? 4 : (coreCount + 1));
                const coreXs = coresPerCG > 3
                    ? [cg.x + spacing, cg.x + cgBoxW - spacing]
                    : Array.from({ length: coreCount }, (_, i) => cg.x + spacing * (i + 1));

                spPositions.forEach(sp => {
                    const innerW = sp.w - pad * 2;

                    // CG{Y} 只连接 Spine{Y}
                    // Spine1 在 15% 位置, SpineN 在 85% 位置 (与 drawLayerBox 匹配)
                    let spineX;
                    if (cg.id === 1) {
                        spineX = sp.x + pad + innerW * 0.15;  // Spine1 位置
                    } else if (cg.id === numCGs) {
                        spineX = sp.x + pad + innerW * 0.85;  // SpineN 位置
                    } else {
                        // 中间的 CG 按比例计算
                        const ratio = (cg.id - 1) / (numCGs - 1);
                        spineX = sp.x + pad + innerW * (0.15 + ratio * 0.7);
                    }

                    // Spine 节点上边框 Y 坐标 (与 drawSuperPodBox 匹配)
                    // topPad=10, layerH 约 22% 高度, 节点在层中心偏下 8px, nodeH=24
                    const topPad = 10;
                    const spineNodeTopY = sp.y + topPad + 35;  // Spine 节点上边框

                    // 从每个 Core 连到对应的 Spine 节点上边框
                    coreXs.forEach((cx, ci) => {
                        const startY = cg.y + cgBoxH;
                        const endY = spineNodeTopY;

                        // 使用贝塞尔曲线
                        const path = d3.path();
                        path.moveTo(cx, startY);
                        path.bezierCurveTo(
                            cx, startY + 30,
                            spineX, endY - 30,
                            spineX, endY
                        );

                        // 渐变颜色
                        const lineColor = cg.id === 1 ? '#86efac' : '#c084fc';

                        svg.append('path')
                            .attr('d', path.toString())
                            .attr('fill', 'none')
                            .attr('stroke', lineColor)
                            .attr('stroke-width', 2)
                            .attr('stroke-opacity', 0.7)
                            .attr('stroke-linecap', 'round');
                    });
                });
            });

        }

        function generateD3TopologyData(config) {
            return {
                isThreeTier: config.numCores > 0,
                numSuperPods: Math.ceil(config.numGPUs / (config.serversPerSuperPod || 648)) || Math.ceil(config.numLeafs / (config.leafsPerSuperPod || 72)) || 1,
                numCGs: config.numCGs || 72,
                coresPerCG: config.coresPerCG || 1,
                spinesPerSuperPod: config.spinesPerSuperPod || 72,
                leafsPerSuperPod: config.leafsPerSuperPod || 72,
                serversPerSuperPod: config.serversPerSuperPod || 648,
                numCores: config.numCores || 0,
                numSpines: config.numSpines || 0,
                numLeafs: config.numLeafs || 0,
                numGPUs: config.numGPUs || 0
            };
        }

        function generateD3ViewHTML(containerId, topologyData, isThreeTier) {
            const dataAttr = JSON.stringify(topologyData).replace(/"/g, '&quot;');
            return `
                <div id="${containerId}" class="diagram-view" data-topology="${dataAttr}">
                    <div class="d3-topology-container"></div>
                </div>
            `;
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            updateQuickSelect();
            updateTopology();

            document.getElementById('serverCount').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    updateTopology();
                }
            });
        });
    </script>
</body>
</html>
