<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº§å“æŠ¥ä»·ç®¡ç†ç³»ç»Ÿ</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Custom CSS -->
    <link href="css/styles.css" rel="stylesheet">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line me-2"></i>äº§å“æŠ¥ä»·ç®¡ç†ç³»ç»Ÿ
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">Vincentçš„æŠ¥ä»·åŠ©æ‰‹</span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
        <ul class="nav nav-tabs" id="mainTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">
                    ä»ªè¡¨æ¿
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button" role="tab">
                    äº§å“ç®¡ç†
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="quotes-tab" data-bs-toggle="tab" data-bs-target="#quotes" type="button" role="tab">
                    æŠ¥ä»·è®°å½•
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis" type="button" role="tab">
                    ä»·æ ¼åˆ†æ
                </button>
            </li>
        </ul>

        <div class="tab-content mt-3" id="mainTabContent">
            <!-- ä»ªè¡¨æ¿ -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">äº§å“æ€»æ•°</h5>
                                <h2 class="text-primary" id="totalProducts">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">æŠ¥ä»·è®°å½•</h5>
                                <h2 class="text-success" id="totalQuotes">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">æœ¬æœˆæŠ¥ä»·</h5>
                                <h2 class="text-warning" id="monthlyQuotes">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">æœ¬æœˆæŠ¥ä»·æ€»é¢</h5>
                                <h2 class="text-info" id="monthlyTotal">0ä¸‡å…ƒ</h2>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ•°æ®ç®¡ç† -->
                <div class="card mt-4">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">æ•°æ®ç®¡ç†</h5>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="d-grid">
                                    <button type="button" class="btn btn-primary" onclick="exportAllData()">
                                        ğŸ“¥ å¯¼å‡ºæ‰€æœ‰æ•°æ®
                                    </button>
                                    <small class="text-muted mt-1">å°†æ‰€æœ‰äº§å“å’ŒæŠ¥ä»·æ•°æ®å¯¼å‡ºä¸ºJSONæ–‡ä»¶</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-grid">
                                    <button type="button" class="btn btn-success" onclick="document.getElementById('importFileInput').click()">
                                        ğŸ“¤ å¯¼å…¥æ•°æ®
                                    </button>
                                    <small class="text-muted mt-1">ä»JSONæ–‡ä»¶å¯¼å…¥äº§å“å’ŒæŠ¥ä»·æ•°æ®</small>
                                    <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="importAllData(this)">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æœ€è¿‘æŠ¥ä»·è®°å½• -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">æœ€è¿‘æŠ¥ä»·è®°å½•</h5>
                    </div>
                    <div class="card-body">
                        <div id="recentQuotes">
                            <p class="text-muted text-center">æš‚æ— æŠ¥ä»·è®°å½•</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- äº§å“ç®¡ç† -->
            <div class="tab-pane fade" id="products" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>äº§å“ç®¡ç†</h4>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal">
                        æ·»åŠ äº§å“
                    </button>
                </div>

                <!-- ç­›é€‰æ§ä»¶ -->
                <div class="card mb-3">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">ç­›é€‰æ¡ä»¶</h6>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearProductFilters()">
                                æ¸…é™¤ç­›é€‰
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="filterProductModel" class="form-label">äº§å“å‹å·</label>
                                <input type="text" class="form-control form-control-sm" id="filterProductModel" placeholder="æœç´¢äº§å“å‹å·...">
                            </div>
                            <div class="col-md-3">
                                <label for="filterManufacturer" class="form-label">å‚å•†</label>
                                <select class="form-select form-select-sm" id="filterManufacturer">
                                    <option value="">å…¨éƒ¨å‚å•†</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="filterProductDateFrom" class="form-label">åˆ›å»ºèµ·å§‹æ—¥æœŸ</label>
                                <input type="date" class="form-control form-control-sm" id="filterProductDateFrom">
                            </div>
                            <div class="col-md-3">
                                <label for="filterProductDateTo" class="form-label">åˆ›å»ºç»“æŸæ—¥æœŸ</label>
                                <input type="date" class="form-control form-control-sm" id="filterProductDateTo">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="productsTable">
                                <thead>
                                    <tr>
                                        <th>äº§å“å‹å·</th>
                                        <th>å‚å•†</th>
                                        <th>æè¿°</th>
                                        <th>åˆ›å»ºæ—¥æœŸ</th>
                                        <th>æŠ¥ä»·æ¬¡æ•°</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">æš‚æ— äº§å“æ•°æ®</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- æŸ¥çœ‹æ›´å¤š/æ”¶èµ·æŒ‰é’®åŒºåŸŸ -->
                        <div id="productTableControls" class="text-center mt-3" style="display: none;">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="toggleProductViewBtn" onclick="toggleProductView()">
                                <i class="fas fa-chevron-down me-1"></i>æŸ¥çœ‹æ›´å¤šäº§å“
                            </button>
                            <div class="text-muted small mt-2" id="productCountInfo">
                                æ˜¾ç¤º <span id="displayedProductCount">0</span> / <span id="totalProductCount">0</span> ä¸ªäº§å“
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æŠ¥ä»·è®°å½• -->
            <div class="tab-pane fade" id="quotes" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>æŠ¥ä»·è®°å½•</h4>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#quoteModal">
                        æ·»åŠ æŠ¥ä»·
                    </button>
                </div>

                <!-- ç­›é€‰æ§ä»¶ -->
                <div class="card mb-3">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">ç­›é€‰æ¡ä»¶</h6>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="document.getElementById('excelImportInput').click()">
                                    <i class="fas fa-upload me-1"></i>å¯¼å…¥Excel
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-success me-2" onclick="exportQuoteData()">
                                    <i class="fas fa-download me-1"></i>å¯¼å‡ºæ•°æ®
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearQuoteFilters()">
                                    æ¸…é™¤ç­›é€‰
                                </button>
                                <input type="file" id="excelImportInput" accept=".xlsx,.xls" style="display: none;" onchange="importExcelData(this)">
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="filterProduct" class="form-label">äº§å“</label>
                                <select class="form-select form-select-sm" id="filterProduct">
                                    <option value="">å…¨éƒ¨äº§å“</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="filterCustomer" class="form-label">å®¢æˆ·</label>
                                <select class="form-select form-select-sm" id="filterCustomer">
                                    <option value="">å…¨éƒ¨å®¢æˆ·</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="filterDateFrom" class="form-label">èµ·å§‹æ—¥æœŸ</label>
                                <input type="date" class="form-control form-control-sm" id="filterDateFrom">
                            </div>
                            <div class="col-md-3">
                                <label for="filterDateTo" class="form-label">ç»“æŸæ—¥æœŸ</label>
                                <input type="date" class="form-control form-control-sm" id="filterDateTo">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">æŠ¥ä»·è®°å½•åˆ—è¡¨</h6>
                            <button type="button" class="btn btn-sm btn-outline-info" onclick="debugQuotes()">
                                ğŸ” è°ƒè¯•æŠ¥ä»·æ•°æ®
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="quotesTable">
                                <thead>
                                    <tr>
                                        <th>äº§å“å‹å·</th>
                                        <th>å®¢æˆ·</th>
                                        <th>æ•°é‡</th>
                                        <th>å•ä»·</th>
                                        <th>æ€»ä»·</th>
                                        <th>æ—¥æœŸ</th>
                                        <th>å¤‡æ³¨</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="quotesTableBody">
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">æš‚æ— æŠ¥ä»·è®°å½•</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- æŸ¥çœ‹æ›´å¤š/æ”¶èµ·æŒ‰é’®åŒºåŸŸ -->
                        <div id="quoteTableControls" class="text-center mt-3" style="display: none;">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="toggleQuoteViewBtn" onclick="toggleQuoteView()">
                                <i class="fas fa-chevron-down me-1"></i>æŸ¥çœ‹æ›´å¤šè®°å½•
                            </button>
                            <div class="text-muted small mt-2" id="quoteCountInfo">
                                æ˜¾ç¤ºæœ€è¿‘ <span id="displayedQuoteCount">0</span> / <span id="totalQuoteCount">0</span> æ¡è®°å½•
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä»·æ ¼åˆ†æ -->
            <div class="tab-pane fade" id="analysis" role="tabpanel">
                <h4 class="mb-3">ä»·æ ¼èµ°åŠ¿åˆ†æ</h4>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6>äº§å“é€‰æ‹©</h6>
                            </div>
                            <div class="card-body">
                                <select class="form-select" id="analysisProductSelect">
                                    <option value="">é€‰æ‹©äº§å“æŸ¥çœ‹ä»·æ ¼èµ°åŠ¿</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6>æ—¶é—´èŒƒå›´</h6>
                            </div>
                            <div class="card-body">
                                <select class="form-select" id="timeRange">
                                    <option value="30">æœ€è¿‘30å¤©</option>
                                    <option value="90">æœ€è¿‘90å¤©</option>
                                    <option value="180">æœ€è¿‘6ä¸ªæœˆ</option>
                                    <option value="365">æœ€è¿‘ä¸€å¹´</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-body">
                        <canvas id="priceChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- äº§å“æ·»åŠ æ¨¡æ€æ¡† -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ·»åŠ äº§å“</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <div class="mb-3">
                            <label for="productModel" class="form-label">äº§å“å‹å· *</label>
                            <input type="text" class="form-control" id="productModel" required>
                        </div>
                        <div class="mb-3">
                            <label for="productManufacturer" class="form-label">å‚å•† *</label>
                            <div class="input-group">
                                <select class="form-select" id="manufacturerSelect" style="max-width: 120px;">
                                    <option value="Nvidia">Nvidia</option>
                                    <option value="AMD">AMD</option>
                                    <option value="Intel">Intel</option>
                                    <option value="custom">å…¶ä»–</option>
                                </select>
                                <input type="text" class="form-control" id="productManufacturer" value="Nvidia" required>
                            </div>
                            <div class="form-text">é€‰æ‹©å¸¸ç”¨å‚å•†æˆ–åœ¨å³ä¾§è¾“å…¥æ¡†æ‰‹åŠ¨è¾“å…¥</div>
                        </div>
                        <div class="mb-3">
                            <label for="productDescription" class="form-label">äº§å“æè¿°</label>
                            <textarea class="form-control" id="productDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">ä¿å­˜äº§å“</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æŠ¥ä»·æ·»åŠ æ¨¡æ€æ¡† -->
    <div class="modal fade" id="quoteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ·»åŠ æŠ¥ä»·</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="quoteForm">
                        <div class="mb-3">
                            <label for="quoteProduct" class="form-label">é€‰æ‹©äº§å“ *</label>
                            <select class="form-select" id="quoteProduct" required>
                                <option value="">è¯·é€‰æ‹©äº§å“</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="quoteCustomer" class="form-label">å®¢æˆ·åç§°</label>
                            <div class="input-group">
                                <select class="form-select" id="customerSelect" style="max-width: 120px;">
                                    <option value="new">æ–°å®¢æˆ·</option>
                                </select>
                                <input type="text" class="form-control" id="quoteCustomer" placeholder="è¾“å…¥å®¢æˆ·åç§°">
                            </div>
                            <div class="form-text">é€‰æ‹©å¸¸ç”¨å®¢æˆ·æˆ–åœ¨å³ä¾§è¾“å…¥æ¡†æ‰‹åŠ¨è¾“å…¥</div>
                        </div>
                        <div class="mb-3">
                            <label for="quoteQuantity" class="form-label">æ•°é‡ *</label>
                            <input type="number" class="form-control" id="quoteQuantity" min="1" value="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="quoteUnitPrice" class="form-label">å•ä»· *</label>
                            <div class="input-group">
                                <span class="input-group-text">Â¥</span>
                                <input type="number" class="form-control" id="quoteUnitPrice" step="0.01" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="quoteTotalPrice" class="form-label">æ€»ä»·</label>
                            <div class="input-group">
                                <span class="input-group-text">Â¥</span>
                                <input type="number" class="form-control" id="quoteTotalPrice" step="0.01" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="quoteDate" class="form-label">æŠ¥ä»·æ—¥æœŸ *</label>
                            <input type="date" class="form-control" id="quoteDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="quoteNotes" class="form-label">å¤‡æ³¨</label>
                            <textarea class="form-control" id="quoteNotes" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-success" onclick="saveQuote()">ä¿å­˜æŠ¥ä»·</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Excelå¯¼å…¥é¢„è§ˆæ¨¡æ€æ¡† -->
    <div class="modal fade" id="excelImportModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Excelå¯¼å…¥é¢„è§ˆ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- æ–‡ä»¶ä¿¡æ¯ -->
                    <div class="alert alert-info" id="fileInfo">
                        <h6>æ–‡ä»¶ä¿¡æ¯</h6>
                        <p id="fileInfoContent">æ–‡ä»¶ï¼š-</p>
                    </div>

                    <!-- å®¢æˆ·å’Œæ—¥æœŸè®¾ç½® -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="importCustomer" class="form-label">å®¢æˆ·åç§° *</label>
                            <input type="text" class="form-control" id="importCustomer" placeholder="è¯·è¾“å…¥å®¢æˆ·åç§°" required>
                            <div class="form-text">ä»æ–‡ä»¶åè‡ªåŠ¨è¯†åˆ«æˆ–æ‰‹åŠ¨è¾“å…¥</div>
                        </div>
                        <div class="col-md-6">
                            <label for="importDate" class="form-label">æŠ¥ä»·æ—¥æœŸ *</label>
                            <input type="date" class="form-control" id="importDate" required>
                            <div class="form-text">ä»æ–‡ä»¶åè‡ªåŠ¨è¯†åˆ«æˆ–æ‰‹åŠ¨è¾“å…¥</div>
                        </div>
                    </div>

                    <!-- æ•°æ®é¢„è§ˆ -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">æ•°æ®é¢„è§ˆ <span id="previewCount" class="badge bg-primary">0</span></h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 300px;">
                                <table class="table table-sm table-hover" id="importPreviewTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th>äº§å“å‹å·</th>
                                            <th>å‚å•†</th>
                                            <th>æ•°é‡</th>
                                            <th>å•ä»·</th>
                                            <th>æ€»ä»·</th>
                                            <th>çŠ¶æ€</th>
                                        </tr>
                                    </thead>
                                    <tbody id="importPreviewBody">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">æš‚æ— æ•°æ®</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- å¯¼å…¥çŠ¶æ€ -->
                    <div id="importStatus" class="mt-3" style="display: none;">
                        <div class="alert alert-warning">
                            <strong>æ³¨æ„ï¼š</strong>
                            <ul class="mb-0" id="importWarnings">
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="confirmImportBtn" onclick="confirmExcelImport()" disabled>
                        ç¡®è®¤å¯¼å…¥ <span id="importCountBadge" class="badge bg-light text-dark">0</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="js/app.js"></script>
    <script src="js/product.js"></script>
    <script src="js/quote.js"></script>
    <script src="js/chart.js"></script>

    <!-- æ•°æ®å¯¼å‡º/å¯¼å…¥åŠŸèƒ½ -->
    <script>
    function exportAllData() {
        if (!app) {
            alert('åº”ç”¨æœªåˆå§‹åŒ–');
            return;
        }

        try {
            // å‡†å¤‡å¯¼å‡ºæ•°æ®
            const exportData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                products: app.products,
                quotes: app.quotes,
                statistics: {
                    totalProducts: app.products.length,
                    totalQuotes: app.quotes.length
                }
            };

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            // ç”Ÿæˆæ–‡ä»¶å
            const now = new Date();
            const timestamp = now.toISOString().split('T')[0].replace(/-/g, '');
            const filename = `äº§å“æŠ¥ä»·ç³»ç»Ÿæ•°æ®å¤‡ä»½_${timestamp}.json`;

            // åˆ›å»ºä¸‹è½½é“¾æ¥å¹¶è§¦å‘ä¸‹è½½
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = filename;
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);

            // æ¸…ç†URLå¯¹è±¡
            URL.revokeObjectURL(url);

            app.showAlert(`æ•°æ®å¯¼å‡ºæˆåŠŸï¼å·²å¯¼å‡º ${app.products.length} ä¸ªäº§å“å’Œ ${app.quotes.length} æ¡æŠ¥ä»·è®°å½•`, 'success');

        } catch (error) {
            console.error('æ•°æ®å¯¼å‡ºå¤±è´¥:', error);
            app.showAlert('æ•°æ®å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'danger');
        }
    }

    function importAllData(input) {
        if (!app) {
            alert('åº”ç”¨æœªåˆå§‹åŒ–');
            return;
        }

        const file = input.files[0];
        if (!file) {
            return;
        }

        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        if (!file.name.toLowerCase().endsWith('.json')) {
            app.showAlert('è¯·é€‰æ‹©JSONæ ¼å¼çš„æ•°æ®æ–‡ä»¶', 'danger');
            input.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importData = JSON.parse(e.target.result);

                // éªŒè¯æ•°æ®æ ¼å¼
                if (!importData.products || !importData.quotes) {
                    app.showAlert('æ•°æ®æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘å¿…è¦çš„æ•°æ®å­—æ®µ', 'danger');
                    return;
                }

                // ç¡®è®¤å¯¼å…¥æ“ä½œ
                const confirmMessage = `å‡†å¤‡å¯¼å…¥æ•°æ®ï¼š\näº§å“æ•°é‡ï¼š${importData.products.length}\næŠ¥ä»·è®°å½•ï¼š${importData.quotes.length}\n\næ³¨æ„ï¼šè¿™å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`;

                if (!confirm(confirmMessage)) {
                    return;
                }

                // å¯¼å…¥æ•°æ®
                app.products = importData.products || [];
                app.quotes = importData.quotes || [];

                // ä¿å­˜åˆ°localStorage
                app.saveData();

                // åˆ·æ–°ç•Œé¢
                if (app.updateDashboard) app.updateDashboard();
                if (typeof refreshProductTable === 'function') refreshProductTable();
                if (typeof refreshQuoteTable === 'function') refreshQuoteTable();
                if (typeof updateQuoteProductSelect === 'function') updateQuoteProductSelect();
                if (typeof updateFilterProductSelect === 'function') updateFilterProductSelect();
                if (typeof updateFilterCustomerSelect === 'function') updateFilterCustomerSelect();
                if (typeof updateCustomerSelect === 'function') updateCustomerSelect();
                if (app.updatePriceChart) app.updatePriceChart();

                // å¼ºåˆ¶æ›´æ–°æŠ¥ä»·è¡¨æ ¼æ˜¾ç¤º
                setTimeout(() => {
                    const tableBody = document.getElementById('quotesTableBody');
                    if (tableBody && app.quotes.length > 0) {
                        console.log('å¼ºåˆ¶åˆ·æ–°æŠ¥ä»·è¡¨æ ¼ï¼Œæ•°æ®é‡:', app.quotes.length);
                        if (typeof refreshQuoteTable === 'function') {
                            refreshQuoteTable();
                        }
                    }
                }, 500);

                app.showAlert(`æ•°æ®å¯¼å…¥æˆåŠŸï¼å·²å¯¼å…¥ ${app.products.length} ä¸ªäº§å“å’Œ ${app.quotes.length} æ¡æŠ¥ä»·è®°å½•`, 'success');

            } catch (error) {
                console.error('æ•°æ®å¯¼å…¥å¤±è´¥:', error);
                app.showAlert('æ•°æ®æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'danger');
            } finally {
                // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                input.value = '';
            }
        };

        reader.onerror = function() {
            app.showAlert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•', 'danger');
            input.value = '';
        };

        reader.readAsText(file);
    }

    function debugQuotes() {
        console.log('=== æŠ¥ä»·æ•°æ®è°ƒè¯• ===');
        console.log('appå¯¹è±¡å­˜åœ¨:', !!app);

        if (app) {
            console.log('app.quotesé•¿åº¦:', app.quotes.length);
            console.log('å‰3æ¡æŠ¥ä»·:', app.quotes.slice(0, 3));

            // æ£€æŸ¥localStorage
            const savedQuotes = localStorage.getItem('quote_quotes');
            console.log('localStorageä¸­çš„æŠ¥ä»·æ•°æ®:', savedQuotes ? JSON.parse(savedQuotes).length : 'æ— ');

            // æ£€æŸ¥è¡¨æ ¼å…ƒç´ 
            const tableBody = document.getElementById('quotesTableBody');
            console.log('è¡¨æ ¼bodyå…ƒç´ å­˜åœ¨:', !!tableBody);
            if (tableBody) {
                console.log('å½“å‰è¡¨æ ¼å†…å®¹:', tableBody.innerHTML.substring(0, 100));
            }

            // æ‰‹åŠ¨åˆ·æ–°
            if (typeof refreshQuoteTable === 'function') {
                console.log('è°ƒç”¨refreshQuoteTableå‡½æ•°...');
                refreshQuoteTable();
                console.log('refreshQuoteTableè°ƒç”¨å®Œæˆ');
            } else {
                console.log('refreshQuoteTableå‡½æ•°ä¸å­˜åœ¨');
            }
        }

        alert('è°ƒè¯•ä¿¡æ¯å·²è¾“å‡ºåˆ°æ§åˆ¶å°');
    }

    // Excelå¯¼å…¥ç›¸å…³å…¨å±€å˜é‡
    let importData = [];
    let currentFile = null;

    // è§£ææ–‡ä»¶åè·å–å®¢æˆ·åç§°å’Œæ—¥æœŸ
    function parseFileName(fileName) {
        const result = {
            customer: '',
            date: ''
        };

        // ç§»é™¤æ–‡ä»¶æ‰©å±•å
        const nameWithoutExt = fileName.replace(/\.(xlsx|xls)$/i, '');

        // åŒ¹é…æ—¥æœŸæ¨¡å¼ï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼‰
        const datePatterns = [
            /(\d{4}[-\.]?\d{2}[-\.]?\d{2})/,  // YYYY-MM-DD æˆ– YYYYMMDD æˆ– YYYY.MM.DD
            /(\d{2}[-\.]?\d{2}[-\.]?\d{4})/,  // MM-DD-YYYY ç­‰
            /(\d{8})/,                        // YYYYMMDD
            /(\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥)/      // ä¸­æ–‡æ—¥æœŸæ ¼å¼
        ];

        for (let pattern of datePatterns) {
            const match = nameWithoutExt.match(pattern);
            if (match) {
                let dateStr = match[1];

                // è½¬æ¢ä¸ºæ ‡å‡†æ—¥æœŸæ ¼å¼
                if (dateStr.includes('å¹´')) {
                    // å¤„ç†ä¸­æ–‡æ—¥æœŸ
                    dateStr = dateStr.replace(/å¹´/, '-').replace(/æœˆ/, '-').replace(/æ—¥/, '');
                } else if (dateStr.length === 8 && /^\d{8}$/.test(dateStr)) {
                    // å¤„ç†YYYYMMDDæ ¼å¼
                    dateStr = `${dateStr.substring(0,4)}-${dateStr.substring(4,6)}-${dateStr.substring(6,8)}`;
                } else {
                    // æ ‡å‡†åŒ–åˆ†éš”ç¬¦
                    dateStr = dateStr.replace(/\./g, '-');
                }

                // éªŒè¯æ—¥æœŸæœ‰æ•ˆæ€§
                const testDate = new Date(dateStr);
                if (!isNaN(testDate.getTime())) {
                    result.date = dateStr;
                    break;
                }
            }
        }

        // æå–å®¢æˆ·åç§°ï¼ˆå»é™¤æ—¥æœŸéƒ¨åˆ†å’Œå¸¸è§çš„æè¿°è¯ï¼‰
        let customerPart = nameWithoutExt;
        if (result.date) {
            // å»é™¤æ‰¾åˆ°çš„æ—¥æœŸéƒ¨åˆ†
            for (let pattern of datePatterns) {
                customerPart = customerPart.replace(pattern, '');
            }
        }

        // æ¸…ç†å®¢æˆ·åç§°
        customerPart = customerPart
            .replace(/[-\._\s]+/g, ' ')  // æ›¿æ¢è¿å­—ç¬¦ã€ä¸‹åˆ’çº¿ã€ç‚¹ä¸ºç©ºæ ¼
            .replace(/\b(æ¸…å•|æŠ¥ä»·|è®¾å¤‡|ç»„ç½‘|å°|ä¸ª|ä»¶|æ‰¹|æ¬¡)\b/g, '')  // å»é™¤å¸¸è§æè¿°è¯
            .trim();

        if (customerPart) {
            result.customer = customerPart;
        }

        return result;
    }

    // æ™ºèƒ½è¯†åˆ«è¡¨å¤´
    function identifyColumns(headerRow) {
        const columnMap = {
            model: -1,        // äº§å“å‹å·
            manufacturer: -1, // å‚å•†
            quantity: -1,     // æ•°é‡
            unitPrice: -1,    // å•ä»·
            totalPrice: -1    // æ€»ä»·
        };

        const modelPatterns = ['äº§å“å‹å·', 'å‹å·', 'äº§å“', 'è®¾å¤‡å‹å·', 'è®¾å¤‡åç§°', 'model', 'product'];
        const manufacturerPatterns = ['å‚å•†', 'åˆ¶é€ å•†', 'å“ç‰Œ', 'ä¾›åº”å•†', 'å‚å®¶', 'manufacturer', 'brand', 'vendor', 'supplier'];
        const quantityPatterns = ['æ•°é‡', 'å°æ•°', 'ä¸ªæ•°', 'ä»¶æ•°', 'quantity', 'qty', 'count'];
        const unitPricePatterns = ['å•ä»·', 'ä»·æ ¼', 'å•ä½ä»·æ ¼', 'price', 'unit price', 'unitprice'];
        const totalPricePatterns = ['æ€»ä»·', 'æ€»é‡‘é¢', 'åˆè®¡', 'total', 'total price', 'amount'];

        headerRow.forEach((cell, index) => {
            if (!cell) return;

            const cellText = cell.toString().toLowerCase().trim();

            // åŒ¹é…äº§å“å‹å·
            if (columnMap.model === -1 && modelPatterns.some(pattern =>
                cellText.includes(pattern.toLowerCase())
            )) {
                columnMap.model = index;
            }

            // åŒ¹é…å‚å•†
            if (columnMap.manufacturer === -1 && manufacturerPatterns.some(pattern =>
                cellText.includes(pattern.toLowerCase())
            )) {
                columnMap.manufacturer = index;
            }

            // åŒ¹é…æ•°é‡
            if (columnMap.quantity === -1 && quantityPatterns.some(pattern =>
                cellText.includes(pattern.toLowerCase())
            )) {
                columnMap.quantity = index;
            }

            // åŒ¹é…å•ä»·
            if (columnMap.unitPrice === -1 && unitPricePatterns.some(pattern =>
                cellText.includes(pattern.toLowerCase())
            )) {
                columnMap.unitPrice = index;
            }

            // åŒ¹é…æ€»ä»·
            if (columnMap.totalPrice === -1 && totalPricePatterns.some(pattern =>
                cellText.includes(pattern.toLowerCase())
            )) {
                columnMap.totalPrice = index;
            }
        });

        return columnMap;
    }

    // å¤„ç†Excelæ–‡ä»¶å¯¼å…¥
    function importExcelData(input) {
        const file = input.files[0];
        if (!file) return;

        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        if (!file.name.toLowerCase().match(/\.(xlsx|xls)$/)) {
            app.showAlert('è¯·é€‰æ‹©Excelæ ¼å¼çš„æ–‡ä»¶ï¼ˆ.xlsxæˆ–.xlsï¼‰', 'danger');
            input.value = '';
            return;
        }

        currentFile = file;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                // è¯»å–Excelæ–‡ä»¶
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                // è½¬æ¢ä¸ºJSONæ•°ç»„
                const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                if (rawData.length < 2) {
                    app.showAlert('Excelæ–‡ä»¶æ•°æ®ä¸è¶³ï¼Œè‡³å°‘éœ€è¦åŒ…å«è¡¨å¤´å’Œä¸€è¡Œæ•°æ®', 'danger');
                    input.value = '';
                    return;
                }

                // è§£ææ–‡ä»¶å
                const fileInfo = parseFileName(file.name);

                // å¤„ç†æ•°æ®
                processExcelData(rawData, fileInfo);

            } catch (error) {
                console.error('Excelæ–‡ä»¶è§£æå¤±è´¥:', error);
                app.showAlert('Excelæ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'danger');
                input.value = '';
            }
        };

        reader.onerror = function() {
            app.showAlert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•', 'danger');
            input.value = '';
        };

        reader.readAsArrayBuffer(file);
    }

    // å¤„ç†Excelæ•°æ®
    function processExcelData(rawData, fileInfo) {
        const headerRow = rawData[0];
        const dataRows = rawData.slice(1);

        // è¯†åˆ«åˆ—ä½ç½®
        const columnMap = identifyColumns(headerRow);

        console.log('è¯†åˆ«çš„åˆ—ä½ç½®:', columnMap);
        console.log('è¡¨å¤´:', headerRow);

        // éªŒè¯å¿…è¦åˆ—æ˜¯å¦éƒ½æ‰¾åˆ°äº†
        const missingColumns = [];
        if (columnMap.model === -1) missingColumns.push('äº§å“å‹å·');
        if (columnMap.quantity === -1) missingColumns.push('æ•°é‡');
        if (columnMap.unitPrice === -1 && columnMap.totalPrice === -1) {
            missingColumns.push('å•ä»·æˆ–æ€»ä»·');
        }

        if (missingColumns.length > 0) {
            app.showAlert(`æ— æ³•è¯†åˆ«ä»¥ä¸‹å¿…è¦åˆ—ï¼š${missingColumns.join('ã€')}ã€‚è¯·ç¡®ä¿Excelæ–‡ä»¶åŒ…å«"äº§å“å‹å·"ã€"æ•°é‡"ä»¥åŠ"å•ä»·"æˆ–"æ€»ä»·"åˆ—`, 'danger');
            return;
        }

        // è§£ææ•°æ®è¡Œ
        importData = [];
        const warnings = [];

        dataRows.forEach((row, index) => {
            if (!row || row.length === 0) return;

            const rowNum = index + 2; // Excelè¡Œå·ï¼ˆä»1å¼€å§‹ï¼ŒåŠ ä¸Šè¡¨å¤´ï¼‰

            // æå–æ•°æ®
            const model = row[columnMap.model] ? row[columnMap.model].toString().trim() : '';
            const manufacturer = columnMap.manufacturer !== -1 && row[columnMap.manufacturer] ?
                row[columnMap.manufacturer].toString().trim() : null;
            const quantity = row[columnMap.quantity] ? parseFloat(row[columnMap.quantity]) : null;
            const unitPrice = columnMap.unitPrice !== -1 ? parseFloat(row[columnMap.unitPrice]) : null;
            const totalPrice = columnMap.totalPrice !== -1 ? parseFloat(row[columnMap.totalPrice]) : null;

            // éªŒè¯æ•°æ®
            if (!model) {
                warnings.push(`ç¬¬${rowNum}è¡Œï¼šäº§å“å‹å·ä¸ºç©º`);
                return;
            }

            if (!quantity || quantity <= 0) {
                warnings.push(`ç¬¬${rowNum}è¡Œï¼šæ•°é‡æ— æ•ˆ`);
                return;
            }

            // è®¡ç®—ç¼ºå¤±çš„ä»·æ ¼
            let finalUnitPrice = unitPrice;
            let finalTotalPrice = totalPrice;

            if (unitPrice && !totalPrice) {
                finalTotalPrice = unitPrice * quantity;
            } else if (totalPrice && !unitPrice) {
                finalUnitPrice = totalPrice / quantity;
            } else if (!unitPrice && !totalPrice) {
                warnings.push(`ç¬¬${rowNum}è¡Œï¼šç¼ºå°‘ä»·æ ¼ä¿¡æ¯`);
                return;
            }

            // æŸ¥æ‰¾åŒ¹é…çš„äº§å“
            const matchedProduct = app.products.find(p =>
                p.model.toLowerCase().includes(model.toLowerCase()) ||
                model.toLowerCase().includes(p.model.toLowerCase())
            );

            importData.push({
                model: model,
                manufacturer: manufacturer,
                quantity: quantity,
                unitPrice: finalUnitPrice,
                totalPrice: finalTotalPrice,
                matchedProduct: matchedProduct,
                rowNumber: rowNum
            });
        });

        // æ˜¾ç¤ºé¢„è§ˆ
        showImportPreview(fileInfo, warnings);
    }

    // æ˜¾ç¤ºå¯¼å…¥é¢„è§ˆ
    function showImportPreview(fileInfo, warnings) {
        // è®¾ç½®æ–‡ä»¶ä¿¡æ¯
        document.getElementById('fileInfoContent').textContent =
            `æ–‡ä»¶ï¼š${currentFile.name} (${importData.length} æ¡è®°å½•)`;

        // è®¾ç½®å®¢æˆ·åç§°å’Œæ—¥æœŸ
        document.getElementById('importCustomer').value = fileInfo.customer || '';
        document.getElementById('importDate').value = fileInfo.date || new Date().toISOString().split('T')[0];

        // æ›´æ–°é¢„è§ˆè®¡æ•°
        document.getElementById('previewCount').textContent = importData.length;
        document.getElementById('importCountBadge').textContent = importData.length;

        // å¡«å……é¢„è§ˆè¡¨æ ¼
        const tbody = document.getElementById('importPreviewBody');
        tbody.innerHTML = '';

        importData.forEach(item => {
            const row = document.createElement('tr');
            const statusClass = item.matchedProduct ? 'text-success' : 'text-warning';
            const statusText = item.matchedProduct ? 'âœ“ å·²åŒ¹é…' : 'âš  æ–°äº§å“';

            row.innerHTML = `
                <td>${escapeHtml(item.model)}</td>
                <td><span class="badge bg-secondary">${escapeHtml(item.manufacturer || 'æœªçŸ¥')}</span></td>
                <td>${item.quantity}</td>
                <td>Â¥${item.unitPrice.toFixed(2)}</td>
                <td>Â¥${item.totalPrice.toFixed(2)}</td>
                <td class="${statusClass}">${statusText}</td>
            `;
            tbody.appendChild(row);
        });

        // æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
        const statusDiv = document.getElementById('importStatus');
        const warningsUl = document.getElementById('importWarnings');

        if (warnings.length > 0) {
            warningsUl.innerHTML = warnings.map(w => `<li>${escapeHtml(w)}</li>`).join('');
            statusDiv.style.display = 'block';
        } else {
            statusDiv.style.display = 'none';
        }

        // å¯ç”¨ç¡®è®¤æŒ‰é’®
        document.getElementById('confirmImportBtn').disabled = importData.length === 0;

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        const modal = new bootstrap.Modal(document.getElementById('excelImportModal'));
        modal.show();
    }

    // ç¡®è®¤å¯¼å…¥Excelæ•°æ®
    function confirmExcelImport() {
        const customer = document.getElementById('importCustomer').value.trim();
        const date = document.getElementById('importDate').value;

        if (!customer) {
            app.showAlert('è¯·è¾“å…¥å®¢æˆ·åç§°', 'danger');
            return;
        }

        if (!date) {
            app.showAlert('è¯·é€‰æ‹©æŠ¥ä»·æ—¥æœŸ', 'danger');
            return;
        }

        let addedCount = 0;
        let newProductCount = 0;

        // åˆ›å»ºä¸€ä¸ªæ˜ å°„è¡¨æ¥è·Ÿè¸ªæœ¬æ¬¡å¯¼å…¥ä¸­åˆ›å»ºçš„äº§å“ï¼Œé¿å…é‡å¤åˆ›å»º
        const newProductsMap = new Map(); // model -> productId

        importData.forEach(item => {
            let productId;

            // å¦‚æœæ²¡æœ‰åŒ¹é…çš„äº§å“ï¼Œæ£€æŸ¥æ˜¯å¦åœ¨æœ¬æ¬¡å¯¼å…¥ä¸­å·²åˆ›å»ºè¿‡ç›¸åŒå‹å·çš„äº§å“
            if (!item.matchedProduct) {
                const modelKey = item.model.toLowerCase().trim();

                // æ£€æŸ¥æ˜¯å¦åœ¨æœ¬æ¬¡å¯¼å…¥ä¸­å·²ç»åˆ›å»ºè¿‡è¿™ä¸ªå‹å·çš„äº§å“
                if (newProductsMap.has(modelKey)) {
                    productId = newProductsMap.get(modelKey);
                } else {
                    // åˆ›å»ºæ–°äº§å“
                    const newProduct = {
                        id: 'product_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        model: item.model,
                        manufacturer: item.manufacturer || 'Unknown', // ä½¿ç”¨Excelä¸­çš„å‚å•†ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä¸ºUnknown
                        description: `ä»Excelå¯¼å…¥: ${currentFile.name}`,
                        createDate: new Date().toISOString(),
                        updateDate: new Date().toISOString()
                    };

                    app.products.push(newProduct);
                    productId = newProduct.id;
                    newProductsMap.set(modelKey, productId);
                    newProductCount++;
                }
            } else {
                productId = item.matchedProduct.id;
            }

            // åˆ›å»ºæŠ¥ä»·è®°å½•
            const newQuote = {
                id: 'quote_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                productId: productId,
                customer: customer,
                quantity: item.quantity,
                unitPrice: item.unitPrice,
                totalPrice: item.totalPrice,
                price: item.unitPrice, // å‘åå…¼å®¹å­—æ®µ
                date: date,
                notes: `ä»Excelå¯¼å…¥: ${currentFile.name}`,
                createDate: new Date().toISOString(),
                updateDate: new Date().toISOString()
            };

            app.quotes.push(newQuote);
            addedCount++;
        });

        // ä¿å­˜æ•°æ®
        app.saveData();

        // åˆ·æ–°ç•Œé¢
        if (app.updateDashboard) app.updateDashboard();
        if (typeof refreshProductTable === 'function') refreshProductTable();
        if (typeof refreshQuoteTable === 'function') refreshQuoteTable();
        if (typeof updateQuoteProductSelect === 'function') updateQuoteProductSelect();
        if (typeof updateFilterProductSelect === 'function') updateFilterProductSelect();
        if (typeof updateFilterCustomerSelect === 'function') updateFilterCustomerSelect();
        if (typeof updateCustomerSelect === 'function') updateCustomerSelect();

        // å…³é—­æ¨¡æ€æ¡†
        const modal = bootstrap.Modal.getInstance(document.getElementById('excelImportModal'));
        modal.hide();

        // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
        document.getElementById('excelImportInput').value = '';

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        let message = `æˆåŠŸå¯¼å…¥ ${addedCount} æ¡æŠ¥ä»·è®°å½•`;
        if (newProductCount > 0) {
            message += `ï¼Œåˆ›å»º ${newProductCount} ä¸ªæ–°äº§å“`;
        }
        app.showAlert(message, 'success');

        // æ¸…ç†
        importData = [];
        currentFile = null;
    }

    // HTMLè½¬ä¹‰å‡½æ•°
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    // æ¸…ç†é‡å¤äº§å“çš„å‡½æ•°
    function cleanupDuplicateProducts() {
        if (!app || !app.products || !app.quotes) {
            console.error('åº”ç”¨æ•°æ®ä¸å¯ç”¨');
            return;
        }

        // åˆ›å»ºäº§å“å‹å·æ˜ å°„è¡¨ï¼Œæ‰¾å‡ºé‡å¤çš„äº§å“
        const productGroups = {};
        app.products.forEach(product => {
            const modelKey = product.model.toLowerCase().trim();
            if (!productGroups[modelKey]) {
                productGroups[modelKey] = [];
            }
            productGroups[modelKey].push(product);
        });

        let cleanedCount = 0;
        let mergedGroups = 0;

        // å¤„ç†æ¯ä¸ªäº§å“ç»„
        Object.keys(productGroups).forEach(modelKey => {
            const group = productGroups[modelKey];

            // å¦‚æœè¯¥å‹å·æœ‰å¤šä¸ªäº§å“ï¼ˆé‡å¤ï¼‰
            if (group.length > 1) {
                mergedGroups++;

                // æŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼Œä¿ç•™æœ€æ—©çš„äº§å“
                group.sort((a, b) => new Date(a.createDate) - new Date(b.createDate));
                const keepProduct = group[0];
                const duplicateProducts = group.slice(1);

                console.log(`å¤„ç†é‡å¤äº§å“: ${keepProduct.model}, ä¿ç•™ID: ${keepProduct.id}, åˆ é™¤${duplicateProducts.length}ä¸ªé‡å¤é¡¹`);

                // æ›´æ–°æ‰€æœ‰æŒ‡å‘é‡å¤äº§å“çš„æŠ¥ä»·è®°å½•
                duplicateProducts.forEach(duplicateProduct => {
                    const relatedQuotes = app.quotes.filter(quote => quote.productId === duplicateProduct.id);
                    relatedQuotes.forEach(quote => {
                        quote.productId = keepProduct.id;
                        quote.updateDate = new Date().toISOString();
                    });

                    console.log(`å°†${relatedQuotes.length}æ¡æŠ¥ä»·è®°å½•ä»äº§å“${duplicateProduct.id}è¿ç§»åˆ°${keepProduct.id}`);
                });

                // ä»äº§å“åˆ—è¡¨ä¸­åˆ é™¤é‡å¤çš„äº§å“
                app.products = app.products.filter(product =>
                    !duplicateProducts.some(dup => dup.id === product.id)
                );

                cleanedCount += duplicateProducts.length;
            }
        });

        // ä¿å­˜æ¸…ç†åçš„æ•°æ®
        if (cleanedCount > 0) {
            app.saveData();

            // åˆ·æ–°ç•Œé¢
            if (app.updateDashboard) app.updateDashboard();
            if (typeof refreshProductTable === 'function') refreshProductTable();
            if (typeof refreshQuoteTable === 'function') refreshQuoteTable();
            if (typeof updateQuoteProductSelect === 'function') updateQuoteProductSelect();
            if (typeof updateFilterProductSelect === 'function') updateFilterProductSelect();
            if (typeof updateFilterCustomerSelect === 'function') updateFilterCustomerSelect();
            if (typeof updateCustomerSelect === 'function') updateCustomerSelect();

            const message = `æ¸…ç†å®Œæˆï¼šåˆå¹¶äº†${mergedGroups}ç»„é‡å¤äº§å“ï¼Œåˆ é™¤äº†${cleanedCount}ä¸ªé‡å¤é¡¹`;
            console.log(message);
            app.showAlert(message, 'success');
        } else {
            const message = 'æ²¡æœ‰å‘ç°é‡å¤çš„äº§å“';
            console.log(message);
            app.showAlert(message, 'info');
        }

        return { mergedGroups, cleanedCount };
    }

    // å°†æ¸…ç†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œæ–¹ä¾¿åœ¨æ§åˆ¶å°è°ƒç”¨
    window.cleanupDuplicateProducts = cleanupDuplicateProducts;
    </script>
</body>
</html>